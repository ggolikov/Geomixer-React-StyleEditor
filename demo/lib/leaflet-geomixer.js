/*
 Leaflet-GeoMixer, Leaflet plugin for visualization data from GeoMixer server
 (c) 2013-2016, RDC ScanEx
*/
!function(){"use strict";function e(e,t,r){this.layer=e,this.tilePoint=t,this.zoom=r,this.gmx=e._gmx,this.zKey=this.layer._tileCoordsToKey(t,r);var n=i;this.worldWidthMerc=n.worldWidthMerc;var o=n.getTileNumFromLeaflet(t,r);this.tbounds=n.getTileBounds(o.x,o.y,o.z),this.tpx=256*o.x,this.tpy=256*(1+o.y),this.gmxTilePoint=o,this.showRaster=r>=this.gmx.minZoomRasters&&"rasterBGfunc"in this.gmx||r>=this.gmx.minZoomQuicklooks&&"quicklookBGfunc"in this.gmx,this.rasters={},this.rasterRequests={},this.itemsView=[],this._uniqueID=0,this.gmx.badTiles=this.gmx.badTiles||{}}var t;"undefined"!=typeof module&&module.exports?(t=require("leaflet"),t.gmx={},module.exports=t.gmx):t=window.L,function(){var e=/\[(.+?)\]/g,r=/(floor\()/g,i={functionFromExpression:function(t){return new Function("props","indexes","return "+t.replace(e,'props[indexes["$1"]]').replace(r,"Math.$1")+";")}},n=function(e,t){return{head:e,tail:t}},o=function(e,t){return n(e,t)},a=function(e,t){return n(e,t)},s=new a(-1,null),l=function(e){return-1===e.head},u=function(e,t){return new a(e.head+t,e.tail)},h=function(e){var t=e.length;return function(r,i){return r.substr(i.head,t)===e?u(i,t):s}},c=function(e){var t=e.length;return e=e.toLowerCase(),function(r,i){return r.substr(i.head,t).toLowerCase()===e?u(i,t):s}},d=function(e,t){var r=e.charCodeAt(0),i=t.charCodeAt(0);return function(e,t){var n=e.charCodeAt(t.head);return n>=r&&i>=n?u(t,1):s}},f=function(e){return function(t,r){return t.length>r.head&&l(e(t,r))?u(r,1):s}},m=function(e){return function(t,r){for(var i=0;i<e.length;i++)if(r=e[i](t,r),l(r))return s;return r}},p=function(e){return function(t,r){for(var i=0;i<e.length;i++){var n=e[i](t,r);if(!l(n))return n}return s}},g=function(e,t){return t},v=function(e){return p([e,g])},y=function(e,t){return function(r,i){for(var n=0;;){var o=t(r,i);if(l(o))return n>=e?i:s;n+=1,i=o}}},x=function(e,t,r){var i=m([t,y(e-1,m([r,t]))]);return e>0?i:p([i,g])},_=y(0,p([h(" "),h("	"),h("\n")])),b=function(e,t,r){return x(e,t,m([_,r,_]))},P=function(e){for(var t=[],r=0;r<e.length;r++)t.length>0&&t.push(_),t.push(e[r]);return m(t)},T=function(e){return function(t,r){var i=e(t,r);return l(i)?s:new a(i.head,new o(t.substr(r.head,i.head-r.head),i.tail))}},S=function(e,t){return function(r,i){var n=i,u=e(r,new a(n.head,null));return l(u)?s:new a(u.head,new o(t(u.tail),n.tail))}},I=T(y(1,p([d("a","z"),d("A","Z"),d("а","я"),d("А","Я"),d("0","9"),h("_")]))),M=T(y(1,p([d("a","z"),d("A","Z"),d("а","я"),d("А","Я"),d("0","9"),h("_"),h(" ")]))),L=p([I,m([h('"'),M,h('"')]),m([h("`"),M,h("`")])]),k=m([h("'"),T(y(0,f(h("'")))),h("'")]),C=y(1,d("0","9")),D=T(m([v(h("-")),C,v(m([h("."),C]))])),O=p([D,k]),w=function(e,t){return t(e,new a(0,null))},F=S(P([L,T(p([h("=="),h("!="),h("<>"),h("<="),h(">="),h("="),h("<"),h(">"),c("LIKE")])),p([O,L])]),function(e){var r=e.tail.tail.head,i=e.tail.head,n=e.head,o=null;return"LIKE"===i.toUpperCase()&&(o=function(e){var t=null;return t=function(r,i){var o=n.charAt(r),a=e.charAt(i);return""===o?""===a:"%"===o?t(r+1,i)||""!==a&&t(r,i+1):o===a&&t(r+1,i+1)},t(0,0)}),function(e,a,s){var l=e[a[r]],u=n;if(n in a&&(u=e[a[u]]),"date"!==s[r]&&"datetime"!==s[r]||"string"!=typeof u||(u=t.gmxUtil.getUnixTimeFromStr(u)),"boolean"==typeof l&&"string"==typeof u&&(l=l?"True":"False"),null===l)return!1;if(null!==o)return o(l);if("="===i||"=="===i)return l==u;if("!="===i||"<>"===i)return l!=u;var h,c;return n in a||"string"!=typeof u||w(u,D).head!==u.length?(h=l,c=u,"<"===i?c>h:">"===i?h>c:"<="===i?c>=h:">="===i?h>=c:!1):(h=parseFloat(l),c=parseFloat(u),"<"===i?c>h:">"===i?h>c:"<="===i?c>=h:">="===i?h>=c:!1)}}),N=S(P([L,c("IN"),h("("),b(0,O,h(",")),h(")")]),function(e){for(var t=e;null!=t.tail;)t=t.tail;var r=t.head;return function(t,i){var n=t[i[r]];if(null==n)return!1;for(var o=e;null!==o.tail;){if(o.head===n)return!0;o=o.tail}return!1}}),R=function(e,t){return R(e,t)},A=function(e,t){return A(e,t)},E=S(P([c("NOT"),R]),function(e){var t=e.head;return function(e,r,i){return!t(e,r,i)}});R=p([E,F,N,P([h("("),A,h(")")])]);var z=S(b(2,R,c("AND")),function(e){return function(t,r,i){for(var n=!0,o=e;null!=o;)n=n&&o.head(t,r,i),o=o.tail;return n}}),G=S(b(2,R,c("OR")),function(e){return function(t,r,i){for(var n=!1,o=e;null!=o;)n=n||o.head(t,r,i),o=o.tail;return n}});A=p([z,G,R]);var B=m([_,A,_]);i.parseSQL=function(e){var t=w(e,B);return t.head===e.length?t.tail.head:w(e,_).head===e.length?function(){return!0}:null};var U=function(e,t){return U(e,t)},H=function(e,t){return H(e,t)};U=S(b(1,H,T(p([h("+"),h("-")]))),function(e){return function(t,r,i){for(var n=e,o=0;null!==n;){if(o+=n.head(t,r,i),null===n.tail)return o;"-"===n.tail.head&&(o=-o),n=n.tail.tail}return o}});var V=p([S(D,function(e){return function(){return parseFloat(e.head)}}),S(m([h("floor("),U,h(")")]),function(e){return function(t,r,i){var n=e.head(t,r,i);return Math.floor(n)}}),S(m([h("["),I,h("]")]),function(e){return function(t,r){return parseFloat(t[r[e.head]])}}),P([h("("),U,h(")")])]);V=p([V,S(P([h("-"),V]),function(e){return function(t,r,i){return-e.head(t,r,i)}})]),H=S(b(1,V,T(p([h("*"),h("/")]))),function(e){return function(t,r,i){for(var n=e,o=1;null!==n;){if(o*=n.head(t,r,i),null===n.tail)return o;"/"===n.tail.head&&(o=1/o),n=n.tail.tail}return o}}),V=p([V,S(P([h("-"),V]),function(e){return function(t,r,i){return-e.head(t,r,i)}})]);var j=m([_,U,_]);i.parseExpression=function(e){var t=w(e,j);return t.head===e.length?t.tail.head:null};var q=S(y(0,p([D,h(","),h("M"),h("C"),y(1,p([h(" "),h("	"),h("\r"),h("\n")]))])),function(e){for(var t=[];null!==e;)t.push(parseFloat(e.head)),e=e.tail;return t.reverse(),t});i.parseSVGPath=function(e){var t=w(e,q);return t.head===e.length?t.tail.head:[]},t.gmx=t.gmx||{},t.gmx.Parsers=i}();var r=function(e){var t,i=[],n=[],o=!1,a=!1,s=!1,l=!1,u=this._fulfill=function(e){if(!o){var r=e?i:n;t=[].slice.call(arguments,1),o=!0,a=e,r.forEach(function(e){e.apply(null,t)}),i=n=[]}};this.resolve=function(){l||u.apply(null,[!0].concat([].slice.call(arguments)))},this.reject=function(){l||u.apply(null,[!1].concat([].slice.call(arguments)))};var h=this.cancel=function(){l||o||(l=!0,e&&e())},c=this.then=function(e,s){if(l)return null;var u=null,c=new r(function(){h(),u&&u.cancel()}),d=function(e,t){return function(){if(e){var i=e.apply(null,arguments);i instanceof r?(u=i,i.then(c.resolve,c.reject)):c.resolve(i)}else c._fulfill.apply(null,[t].concat([].slice.call(arguments)))}};return o?d(a?e:s,a).apply(null,t):(i.push(d(e,!0)),n.push(d(s,!1))),c};this.once=function(e){s||(s=!0,c(e))},this.always=function(e){c(e,e)},this.getFulfilledData=function(){return t}};r.all=function(){var e=[].slice.apply(arguments),t=new r,i=e.length,n=new Array(e.length);return i?e.forEach(function(e,r){e.then(function(e){n[r]=e,i--,0===i&&t.resolve.apply(t,n)},function(){t.reject()})}):t.resolve(),t},t.gmx=t.gmx||{},t.gmx.Deferred=r,function(){var e=function(e,r,i){this._id=e,this.def=new t.gmx.Deferred(t.gmx.imageLoader._cancelRequest.bind(t.gmx.imageLoader,this)),this.remove=t.gmx.imageLoader._removeRequestFromCache.bind(t.gmx.imageLoader,this),this.url=r,this.options=i||{}},r=t.Class.extend({includes:t.Mixin.Events,statics:{MAX_COUNT:20},initialize:function(){this.curCount=0,this.requests=[],this.inProgress={},this.requestsCache={},this.uniqueID=0},_resolveRequest:function(e,t,r){var i=e.def;if(t){if(!r&&e.options.cache){var n=e.url,o=this.requestsCache[n],a=e._id;o||(o=this.requestsCache[n]={image:t,requests:{}}),o.requests[a]||(o.requests[a]=e)}i.resolve(t)}else r||i.reject();this.fire("requestdone",{request:e})},_imageLoaded:function(e,r,i){if(e in this.inProgress){var n=function(e){this._resolveRequest(e,r,i)};this.inProgress[e].requests.forEach(n.bind(this)),--this.curCount,delete this.inProgress[e]}t.gmxUtil.loaderStatus(e,!0),this.fire("imageloaded",{url:e}),this._nextLoad()},_nextLoad:function(){if(!(this.curCount>=r.MAX_COUNT)&&this.requests.length){var e=this.requests.shift(),i=e.url;if(i in this.inProgress)this.inProgress[i].requests.push(e);else{var n=[e];this.inProgress[i]={requests:n},++this.curCount;for(var o=this.requests.length-1;o>=0;o--)this.requests[o].url===i&&(n.push(this.requests[o]),this.requests.splice(o,1));var a=this._loadImage(e);a.width||t.gmxUtil.loaderStatus(i),this.inProgress[i]&&(this.inProgress[i].image=a)}}},_loadImage:function(e){var t=new Image,r=e.url,i=this;return e.options.crossOrigin&&(t.crossOrigin=e.options.crossOrigin),t.onload=this._imageLoaded.bind(this,r,t,!1),t.onerror=function(){i._imageLoaded(r)},t.src=r,this.fire("imageloadstart",{url:r}),t},_cancelRequest:function(e){var r,i=e._id,n=e.url,o=0;if(n in this.inProgress){var a=this.inProgress[n],s=a.requests;if(r=s.length,1===r&&s[0]._id===i)a.image.onload=t.Util.falseFn,a.image.onerror=t.Util.falseFn,a.image.src=t.Util.emptyImageUrl,this._imageLoaded(n,null,!0);else for(o=0;r>o;o++)if(s[o]._id===i){s.splice(o,1);break}}else for(o=0,r=this.requests.length;r>o;o++)if(this.requests[o]._id===i){this.requests.splice(o,1);break}this.fire("requestdone",{request:e})},_removeRequestFromCache:function(e){this._cancelRequest(e),this._clearCacheItem(e.url,e._id)},_clearCacheItem:function(e,t){if(this.requestsCache[e]){var r=this.requestsCache[e];delete r.requests[t],0===Object.keys(r.requests).length&&delete this.requestsCache[e]}},_add:function(r,i,n){i=i.replace(/^http:/,t.gmxUtil.protocol);var o="id"+ ++this.uniqueID,a=new e(o,i,n);return i in this.inProgress?this.inProgress[i].requests.push(a):(r?this.requests.unshift(a):this.requests.push(a),this._nextLoad()),this.fire("request",{request:a}),a},push:function(e,t){return this._add(!1,e,t)},unshift:function(e,t){return this._add(!0,e,t)}});t.gmx.imageLoader=new r}();var i={lastMapId:0,newId:function(){return i.lastMapId+=1,"_"+i.lastMapId},uniqueGlobalName:function(e){var t=i.newId();return window[t]=e,t},isPageHidden:function(){return document.hidden||document.msHidden||document.webkitHidden||document.mozHidden||!1},normalizeHostname:function(e){var r=t.gmxUtil.parseUri(("http"!==e.substr(0,4)?t.gmxUtil.protocol+"//":"")+e);return e=r.host+r.directory,"/"===e[e.length-1]&&(e=e.substring(0,e.length-1)),e},getLayerItemFromServer:function(e){var r=e.query?e.query:"["+e.field+"]="+e.value,n=t.gmxUtil.protocol+"//maps.kosmosnimki.ru/",o={WrapStyle:"func",geometry:!0,layer:e.layerID,query:r};return e.border&&(o.border=e.border),i.requestJSONP(e.url||(window.serverBase||n)+"VectorLayer/Search.ashx",o,e)},getCadastreFeatures:function(e){if(e.latlng){var t=e.latlng,r={WrapStyle:"func",text:(t.lat+" "+t.lng).replace(/\./g,","),tolerance:e.tolerance||0};return i.requestJSONP(e.url||"http://pkk5.rosreestr.ru/api/features/",r,e)}return null},getFormData:function(e){var t=[];for(var r in e){var i=e[r];t.push(r+"="+("object"==typeof i?JSON.stringify(i):i))}return t.join("&")},requestJSONP:function(e,r,n){n=n||{};var o=new t.gmx.Deferred,a=document.createElement("script");a.setAttribute("charset","UTF-8");var s="callbackParamName"in n?n.callbackParamName:"CallbackName",l=t.extend({},r,t.gmx.gmxMapManager.syncParams);if(s){var u=i.uniqueGlobalName(function(e){delete window[u],o.resolve(e,n)});l[s]=u}var h=[];for(var c in l)h.push(c+"="+encodeURIComponent(l[c]));var d=e+(-1===e.indexOf("?")?"?":"&")+h.join("&");return a.onerror=function(e){o.reject(e),t.gmxUtil.loaderStatus(d,!0),a.parentNode.removeChild(a)},a.onload=function(){t.gmxUtil.loaderStatus(d,!0),a.parentNode.removeChild(a)},t.gmxUtil.loaderStatus(d,null,"vector"),a.setAttribute("src",d),document.getElementsByTagName("head").item(0).appendChild(a),o},getXmlHttp:function(){var e;if("undefined"!=typeof XMLHttpRequest)e=new XMLHttpRequest;else try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(r){e=!1}}return e},request:function(e){var r=i.getXmlHttp();if(r){if(r.open(e.type?e.type:"GET",e.url,e.async||!1),e.headers)for(var n in e.headers)r.setRequestHeader(n,e.headers[n]);var o=t.gmxUtil.loaderStatus();e.async&&(e.withCredentials&&(r.withCredentials=!0),r.onreadystatechange=function(){4===r.readyState&&(t.gmxUtil.loaderStatus(o,!0),200===r.status?(e.callback(r.responseText),r=null):e.onError&&e.onError(r))});var a=null;if(e.params){a=e.params;var s=t.gmx.gmxMapManager.getSyncParams(!0);s&&(a+="&"+s)}return r.send(a),e.async||200!==r.status?!0:(e.callback(r.responseText),t.gmxUtil.loaderStatus(o,!0),r.status)}return e.onError&&e.onError({Error:"bad XMLHttpRequest!"}),!1},tileSizes:[],getTileNumFromLeaflet:function(e,t){"z"in e&&(t=e.z);var r=Math.pow(2,t),i=e.x%r+(e.x<0?r:0),n=e.y%r+(e.y<0?r:0);return{z:t,x:i%r-r/2,y:r/2-1-n%r}},getTilePosZoomDelta:function(e,t,r){var i=Math.pow(2,t-r),n=256/i,o=e.x%i,a=e.y%i;return{size:n,zDelta:i,x:n*(0>o?i+o:o),y:n*(0>a?-(1+e.y)%i:i-1-a)}},geoItemBounds:function(e){if(!e)return{bounds:null,boundsArr:[]};var t=e.type,r=e.coordinates,n=null,o=0,a=0,s=null,l=[];if("MULTIPOLYGON"===t||"MultiPolygon"===t)for(s=i.bounds(),o=0,a=r.length;a>o;o++){for(var u=[],h=0,c=r[o].length;c>h;h++)n=i.bounds(r[o][h]),u.push(n),0===h&&s.extendBounds(n);l.push(u)}else if("POLYGON"===t||"Polygon"===t)for(s=i.bounds(),o=0,a=r.length;a>o;o++)n=i.bounds(r[o]),l.push(n),0===o&&s.extendBounds(n);else if("POINT"===t||"Point"===t)s=i.bounds([r]);else if("MULTIPOINT"===t||"MultiPoint"===t)for(s=i.bounds(),o=0,a=r.length;a>o;o++)n=i.bounds([r[o]]),s.extendBounds(n);else if("LINESTRING"===t||"LineString"===t)s=i.bounds(r);else if("MULTILINESTRING"===t||"MultiLineString"===t)for(s=i.bounds(),o=0,a=r.length;a>o;o++)n=i.bounds(r[o]),s.extendBounds(n);return{bounds:s,boundsArr:l}},getUnFlattenGeo:function(e){var t=e.type,r=-1!==t.indexOf("POLYGON")||-1!==t.indexOf("Polygon"),n=e.coordinates,o=n;if(r){o=[];var a="POLYGON"===t||"Polygon"===t;a&&(n=[n]);for(var s=0,l=n.length;l>s;s++){for(var u=[],h=0,c=n[s].length;c>h;h++)u[h]=i.unFlattenRing(n[s][h]);o.push(u)}a&&(o=o[0])}return{type:t,coordinates:o}},unFlattenRing:function(e){if("number"!=typeof e[0])return e;for(var t=e.length,r=0,i=new Array(t/2),n=0;t>n;n+=2)i[r++]=[e[n],e[n+1]];return i},geoFlatten:function(e){var t=e.type,r=-1!==t.indexOf("POLYGON")||-1!==t.indexOf("Polygon"),n="POLYGON"===t||"Polygon"===t,o=e.coordinates;if(r){n&&(o=[o]);for(var a=0,s=o.length;s>a;a++)for(var l=0,u=o[a].length;u>l;l++)o[a][l]=i.flattenRing(o[a][l])}},flattenRing:function(e){for(var t=e.length,r=0,i="function"==typeof Float64Array?Float64Array:Array,n=new i(2*t),o=0;t>o;o++)n[r++]=e[o][0],n[r++]=e[o][1];return n},isRectangle:function(e){return!(!e||!e[0]||5!==e[0].length&&4!==e[0].length||e[0][0][0]!==e[0][1][0]&&e[0][0][1]!==e[0][1][1]||e[0][1][0]!==e[0][2][0]&&e[0][1][1]!==e[0][2][1]||e[0][2][0]!==e[0][3][0]&&e[0][2][1]!==e[0][3][1]||e[0][3][0]!==e[0][0][0]&&e[0][3][1]!==e[0][0][1])},getGeometryBounds:function(e){var t=i.geoItemBounds(e);return t.bounds},getMarkerPolygon:function(e,t,r){var i=(e.min.x+e.max.x)/2,n=(e.min.y+e.max.y)/2;return[[i-t,n-r],[i-t,n+r],[i+t,n+r],[i+t,n-r],[i-t,n-r]]},getQuicklookPointsFromProperties:function(e,r){var n=r.tileAttributeIndexes,o={x1:i.getPropItem(r.quicklookX1||("x1"in n?"x1":"X1"),e,n)||0,y1:i.getPropItem(r.quicklookY1||("y1"in n?"y1":"Y1"),e,n)||0,x2:i.getPropItem(r.quicklookX2||("x2"in n?"x2":"X2"),e,n)||0,y2:i.getPropItem(r.quicklookY2||("y2"in n?"y2":"Y2"),e,n)||0,x3:i.getPropItem(r.quicklookX3||("x3"in n?"x3":"X3"),e,n)||0,y3:i.getPropItem(r.quicklookY3||("y3"in n?"y3":"Y3"),e,n)||0,x4:i.getPropItem(r.quicklookX4||("x4"in n?"x4":"X4"),e,n)||0,y4:i.getPropItem(r.quicklookY4||("y4"in n?"y4":"Y4"),e,n)||0},a=i.bounds([[o.x1,o.y1],[o.x2,o.y2],[o.x3,o.y3],[o.x4,o.y4]]);if(a.max.x===a.min.x||a.max.y===a.min.y)return null;if(!r.quicklookPlatform){var s="3857"===r.srs?t.CRS.EPSG3857:t.Projection.Mercator,l=s.project(t.latLng(o.y1,o.x1));o.x1=l.x,o.y1=l.y,l=s.project(t.latLng(o.y2,o.x2)),o.x2=l.x,o.y2=l.y,l=s.project(t.latLng(o.y3,o.x3)),o.x3=l.x,o.y3=l.y,l=s.project(t.latLng(o.y4,o.x4)),o.x4=l.x,o.y4=l.y}return o},getPropertiesHash:function(e,t){var r={};for(var i in t)r[i]=e[t[i]];return r},getPropItem:function(e,t,r){return e in r?t[r[e]]:""},dec2rgba:function(e,t){var r=255&e>>16,i=255&e>>8,n=255&e;return"rgba("+r+", "+i+", "+n+", "+t+")"},dec2hex:function(e){return(e+16777216).toString(16).substr(-6)},dec2color:function(e,t){return 1>t?this.dec2rgba(e,t):"#"+this.dec2hex(e)},oneDay:86400,isTileKeysIntersects:function(e,t){if(e.z<t.z){var r=e;e=t,t=r}var i=e.z-t.z;return e.x>>i===t.x&&e.y>>i===t.y},rotatePoints:function(e,t,r,i){var n=[];t*=Math.PI/180;var o=Math.sin(t),a=Math.cos(t);r||(r=1);for(var s=0;s<e.length;s++){var l=r*e[s].x-i.x,u=r*e[s].y-i.y;n.push({x:a*l-o*u+i.x,y:o*l+a*u+i.y})}return n},getPatternIcon:function(e,t,r){if(!t.fillPattern)return null;var n=!0,o=t.fillPattern,a=e?e.properties:null,s=o.step>0?o.step:0,l={minWidth:1,maxWidth:1e3,minStep:0,maxStep:1e3};o.patternStepFunction&&null!==a&&(s=o.patternStepFunction(a,r),n=!1),s>l.maxStep?s=l.maxStep:s<l.minStep&&(s=l.minStep);var u=o.width>0?o.width:8;o.patternWidthFunction&&null!==a&&(u=o.patternWidthFunction(a,r),n=!1),u>l.maxWidth?u=l.maxWidth:u<l.minWidth&&(u=l.minWidth);var h=t.fillOpacity;t.opacityFunction&&null!==a&&(h=t.opacityFunction(a,r)/100,n=!1);var c=[16711680,65280,255],d=null!=o.colors?o.colors:c,f=d.length,m=[],p=0;for(p=0;f>p;p++){var g=d[p];o.patternColorsFunction&&null!==o.patternColorsFunction[p]&&(g=null!==a?o.patternColorsFunction[p](a,r):c[p%3],n=!1),m.push(g)}0===f&&(m=[0],h=0,f=1);var v=u+s,y=v*f,x=0,_=0,b=y,P=y,T=o.style||"horizontal",S=!1;if("diagonal1"===T||"diagonal2"===T||"cross"===T||"cross1"===T?S=!0:"circle"===T?(P=b=2*v,x=Math.floor(P/2),_=2*Math.PI/f):"vertical"===T?b=1:"horizontal"===T&&(P=1),P*b>l.maxWidth)return console.log({func:"getPatternIcon",Error:"MAX_PATTERN_SIZE",alert:"Bitmap from pattern is too big"}),null;var I=document.createElement("canvas");I.width=P,I.height=b;var M=I.getContext("2d");for(M.clearRect(0,0,I.width,I.height),("diagonal2"===T||"vertical"===T)&&(M.translate(P,0),M.rotate(Math.PI/2)),p=0;f>p;p++){M.beginPath();var L=i.dec2color(m[p],h);if(M.fillStyle=L,S){var k=p*v,C=k+u;M.moveTo(k,0),M.lineTo(C,0),M.lineTo(0,C),M.lineTo(0,k),M.lineTo(k,0),k+=y,C=k+u,M.moveTo(k,0),M.lineTo(C,0),M.lineTo(0,C),M.lineTo(0,k),M.lineTo(k,0),("cross"===T||"cross1"===T)&&(k=p*v,C=k+u,M.moveTo(P,k),M.lineTo(P,C),M.lineTo(P-C,0),M.lineTo(P-k,0),M.lineTo(P,k),k+=y,C=k+u,M.moveTo(P,k),M.lineTo(P,C),M.lineTo(P-C,0),M.lineTo(P-k,0),M.lineTo(P,k))}else"circle"===T?(M.arc(x,x,u,p*_,(p+1)*_),M.lineTo(x,x)):M.fillRect(0,p*v,P,u);M.closePath(),M.fill()}var D=document.createElement("canvas");D.width=P,D.height=b;var O=D.getContext("2d");return O.drawImage(I,0,0,P,b),{notFunc:n,canvas:D}},getSVGIcon:function(e){var r='<svg xmlns="'+t.Path.SVG_NS+'" xmlns:xlink="http://www.w3.org/1999/xlink"',i=e.type,n=e.fillStyle||"rgba(255, 255, 255, 0.5)",o=e.strokeStyle||"#0000ff",a=e.lineWidth||2,s={className:"gmx-svg-icon"};e.className&&(s.className=e.className);var l=e.iconSize;if(s.iconSize=[l,l],r+=' height = "'+l+'px"  width = "'+l+'px">',"circle"===i){if(e.fillRadialGradient){r+='<defs><radialGradient id="myRadialGradient4" spreadMethod="pad">';for(var u=e.fillRadialGradient.colorStop||e.fillRadialGradient.addColorStop||[[0,"#ffff00",.8],[1,"#ff0000",.8]],h=0,c=u.length;c>h;h++){var d=u[h];r+='<stop offset="'+100*d[0]+'%"   stop-color="'+d[1]+'" stop-opacity="'+d[2]+'"/>'}r+="</radialGradient></defs>",n="url(#myRadialGradient4)",o=a=null}l/=2,r+='<g><circle cx="'+l+'" cy="'+l+'" r="'+l+'" style="',n&&(r+=" fill:"+n+";"),o&&(r+=' stroke:"'+o+";"),a&&(r+=' stroke-width:"'+a+";"),r+=';" />'}else"square"===i&&(r+='<g><rect width="'+l+'" height="'+l+'" style="',n&&(r+=" fill:"+n+";"),o&&(r+=" stroke:"+o+";"),a&&(r+=" stroke-width:"+2*a+";"),r+='" />');if(e.text){var f=e.text;r+='<text x="50%" y="50%" dy="0.4em"';for(var m in f)"count"!==m&&(r+=" "+m+'="'+f[m]+'"');r+=">"+f.count+"</text>"}return r+="</g></svg>",s.html=r,new t.DivIcon(s)},toPixels:function(e,t,r,i){var n=e[0]*i;n=.5+n<<0;var o=e[1]*i;return o=.5+o<<0,[n-t,r-o].concat(e.slice(2))},getPixelPoint:function(e,t){var r=e.gmx,n=r.mInPixel,o=e.item,a=o.currentStyle||o.parsedStyleKeys||{},s=e.style||{},l=a.iconScale||1,u=a.iconCenter||!1,h=a.sx||s.sx||4,c=a.sy||s.sy||4,d=a.weight||s.weight||0,f=a.iconAnchor||s.iconAnchor||null,m=e.tpx,p=e.tpy;!u&&f&&(v-=f[0],g-=f[1]),h*=l,c*=l,h+=d,c+=d;var g=p-t[1]*n,v=t[0]*n-m;return v-h>256?v=(t[0]-2*i.worldWidthMerc)*n-m:-h>v&&(v=(t[0]+2*i.worldWidthMerc)*n-m),g-c>256||v-h>256||0>v+h||0>g+c?null:{sx:h,sy:c,px1:.5+v<<0,py1:.5+g<<0}},getImageData:function(e){if(t.gmxUtil.isIE9||t.gmxUtil.isIE10)return null;var r=document.createElement("canvas"),i=e.width,n=e.height;r.width=i,r.height=n;var o=r.getContext("2d");return o.drawImage(e,0,0),o.getImageData(0,0,i,n).data},DEFAULT_REPLACEMENT_COLOR:16711935,isIE:function(e){return e===i.getIEversion()},gtIE:function(e){return e<i.getIEversion()},getIEversion:function(){var e=navigator.userAgent||"",t=e.indexOf("MSIE ");if(t>0)return parseInt(e.substring(t+5,e.indexOf(".",t)),10);var r=e.indexOf("Trident/");if(r>0){var i=e.indexOf("rv:");return parseInt(e.substring(i+3,e.indexOf(".",i)),10)}var n=e.indexOf("Edge/");return n>0?parseInt(e.substring(n+5,e.indexOf(".",n)),10):-1},replaceColor:function(e,r,i){if(t.gmxUtil.isIE9||t.gmxUtil.isIE10)return e;var n=document.createElement("canvas"),o=e.width,a=e.height;n.width=o,n.height=a;var s,l=!1,u=n.getContext("2d");if("string"==typeof r&&(r=parseInt("0x"+r.replace(/#/,""))),r!==this.DEFAULT_REPLACEMENT_COLOR){var h=255&r>>16,c=255&r>>8,d=255&r;i?s=u.createImageData(o,a):(u.drawImage(e,0,0),s=u.getImageData(0,0,o,a),i=s.data);for(var f=s.data,m=0,p=i.length;p>m;m+=4)255!==i[m]&&238!==i[m]||0!==i[m+1]||255!==i[m+2]||(f[m]=h,f[m+1]=c,f[m+2]=d,f[m+3]=i[m+3],l=!0)}return l?u.putImageData(s,0,0):u.drawImage(e,0,0),n},drawIconPath:function(e,r){if(t.Util.isArray(e)&&!(e.length<3)&&r.ctx){var n=!1,o=r.ctx,a=r.radian;(r.px||r.py)&&(o.translate(r.px||0,r.py||0),n=!0),!a&&r.rotateRes&&(a=Math.PI+i.degRad(r.rotateRes)),a&&(o.rotate(a),n=!0),o.moveTo(e[0],e[1]);for(var s=2,l=e.length;l>s;s+=2)o.lineTo(e[s],e[s+1]);n&&o.setTransform(1,0,0,1,0,0)}},pointToCanvas:function(e){var t=e.gmx,r=e.pointAttr,n=e.style||{},o=e.item,a=o.currentStyle||o.parsedStyleKeys,s=a.iconScale||1,l=a.image,u=r.sx,h=r.sy,c=r.px1,d=r.py1,f=c,m=d,p=e.ctx;if("image"===a.type&&(u=n.sx,h=n.sy,l=n.image),a.iconCenter?(f-=u/2,m-=h/2):"circle"===n.type&&(c+=u/2,d+=h/2),a.iconPath&&(e.px=c,e.py=d,e.rotateRes=a.rotate||0),l)"iconColor"in a&&(l=this.replaceColor(l,a.iconColor,e.imageData)),n.rotateRes=a.rotate||0,"opacity"in n&&(p.globalAlpha=a.opacity||n.opacity),t.transformFlag?(p.setTransform(t.mInPixel,0,0,t.mInPixel,-e.tpx,e.tpy),p.drawImage(l,c,-d,u,h),p.setTransform(t.mInPixel,0,0,-t.mInPixel,-e.tpx,e.tpy)):(1!==s&&(u*=s,h*=s,c=r.px1,d=r.py1,f=c,m=d,a.iconCenter&&(f-=u/2,m-=h/2)),n.rotateRes?(p.translate(c,d),p.rotate(i.degRad(n.rotateRes)),p.translate(-c,-d),p.drawImage(l,f,m,u,h),p.setTransform(1,0,0,1,0,0)):p.drawImage(l,f,m,u,h)),"opacity"in n&&(p.globalAlpha=1);else if(n.fillColor||a.fillRadialGradient){if(p.beginPath(),a.iconPath)i.drawIconPath(a.iconPath,e);else if("circle"===n.type||a.fillRadialGradient){var g=n.iconSize/2;if(a.fillRadialGradient){var v=a.fillRadialGradient;g=v.r2*s;for(var y=p.createRadialGradient(c+v.x1,d+v.y1,v.r1*s,c+v.x2,d+v.y2,g),x=0,_=v.addColorStop.length;_>x;x++){var b=v.addColorStop[x];y.addColorStop(b[0],b[1])}p.fillStyle=y}p.arc(c,d,g,0,2*Math.PI)}else p.fillRect(f,m,u,h);p.fill()}a.strokeStyle&&(p.beginPath(),a.iconPath?i.drawIconPath(a.iconPath,e):"circle"===n.type?p.arc(c,d,n.iconSize/2,0,2*Math.PI):p.strokeRect(f,m,u,h),p.stroke())},lineToCanvasAsIcon:function(e,t){var r=e.length,n=t.ctx,o=t.item,a=o.currentStyle||o.parsedStyleKeys,s=a.iconPath;if(r>0){"getLineDash"in n&&n.getLineDash().length>0&&n.setLineDash([]),n.beginPath();for(var l,u=0;r>u;u++)l=e[u],i.drawIconPath(s,{ctx:n,px:l.x,py:l.y,radian:l.radian});a.strokeStyle&&n.stroke(),a.fillStyle&&n.fill()}},lineToCanvas:function(e){var t=e.gmx,r=e.coords,n=e.ctx,o=e.item,a=o.currentStyle||o.parsedStyleKeys,s=a.iconPath?[]:null,l=null,u=null;n.beginPath();for(var h=0,c=r.length;c>h;h++){var d=i.toPixels(r[h],e.tpx,e.tpy,t.mInPixel),f=d[0],m=d[1];(l!==f||u!==m)&&(s&&s.push({x:f,y:m,radian:d[2]}),0===h?n.moveTo(f,m):n.lineTo(f,m),l=f,u=m)}return n.stroke(),s},getCoordsPixels:function(e){for(var t=e.gmx,r=e.coords,n=e.hiddenLines||[],o=[],a=[],s=!1,l={gmx:t,tpx:e.tpx,tpy:e.tpy,coords:null,hiddenLines:null},u=0,h=r.length;h>u;u++){for(var c=r[u],d=n[u]||[],f=[],m=[],p=0,g=c.length;g>p;p++){l.coords=c[p],l.hiddenLines=d[p]||[];var v=i.getRingPixels(l);f.push(v.coords),m.push(v.hidden),v.hidden&&(s=!0)}o.push(f),a.push(m)}return{coords:o,hidden:s?a:null,z:t.currentZoom}},getRingPixels:function(e){if(0===e.coords.length)return null;for(var t=e.gmx,r=t.mInPixel,i=e.coords,n=e.hiddenLines||null,o=e.tpx,a=e.tpy,s=0,l=0,u=null,h=null,c="number"==typeof i[0]?2:1,d=[],f=[],m=0,p=i.length;p>m;m+=c){var g=!1;n&&m===n[l]&&(g=!0,l++);var v=1===c?i[m]:[i[m],i[m+1]],y=v[0]*r,x=v[1]*r,_=Math.round(y-o),b=Math.round(a-x);(u!==_||h!==b)&&(u=_,h=b,g&&f.push(s),d[s++]=y,d[s++]=x)}return{coords:d,hidden:f.length?f:null}},polygonToCanvas:function(e){if(0===e.coords.length)return null;var t=e.hiddenLines||null,r=e.coords,i=e.ctx,n=e.tpx,o=e.tpy,a=0,s=0,l="number"==typeof r[0]?2:1,u=null,h=null;i.beginPath();for(var c=0,d=r.length;d>c;c+=l){var f=1===l?r[c]:[r[c],r[c+1]],m=Math.round(f[0]-n),p=Math.round(o-f[1]),g=!1;t&&c===t[s]&&(g=!0,s++),(u!==m||h!==p)&&(i[g?"moveTo":"lineTo"](m,p),u=m,h=p,a++)}1===a&&i.lineTo(u+1,h),i.stroke()},polygonToCanvasFill:function(e){if(!(e.coords.length<3)){var t=e.coords,r=e.tpx,i=e.tpy,n=1,o=e.ctx;o.lineWidth=0,"number"==typeof t[0]?(n=2,o.moveTo(Math.round(t[0]-r),Math.round(i-t[1]))):o.moveTo(Math.round(t[0][0]-r),Math.round(i-t[0][1]));for(var a=n,s=t.length;s>a;a+=n){var l=1===n?t[a]:[t[a],t[a+1]];o.lineTo(Math.round(l[0]-r),Math.round(i-l[1]))}}},isPatternNode:function(e){return e instanceof HTMLCanvasElement||e instanceof HTMLImageElement},labelCanvasContext:null,getLabelWidth:function(e,t){if(t){if(!i.labelCanvasContext){var r=document.createElement("canvas");r.width=r.height=512,i.labelCanvasContext=r.getContext("2d")}var n=i.labelCanvasContext;n.clearRect(0,0,512,512),n.font!==t.font&&(n.font=t.font),n.fillStyle!==t.fillStyle&&(n.fillStyle=t.fillStyle);var o=e.split("\n");return o.map(function(e){return n.fillText(e,0,0),[e,n.measureText(e).width]})}return 0},setLabel:function(e,r,i,n){var o=i[0],a=i[1];e.shadowColor!==n.strokeStyle&&(e.shadowColor=n.strokeStyle),e.shadowBlur!==n.shadowBlur&&(e.shadowBlur=n.shadowBlur),e.font!==n.font&&(e.font=n.font),t.Browser.gecko?e.strokeStyle!==n.fillStyle&&(e.strokeStyle=n.fillStyle):(e.strokeStyle!==n.strokeStyle&&(e.strokeStyle=n.strokeStyle),e.fillStyle!==n.fillStyle&&(e.fillStyle=n.fillStyle)),e.strokeText(r,o,a),t.Browser.gecko||e.fillText(r,o,a)},worldWidthMerc:20037508,rMajor:6378137,degRad:function(e){return e*(Math.PI/180)},distVincenty:function(e,t,r,n){for(var o={lon:i.degRad(e),lat:i.degRad(t)},a={lon:i.degRad(r),lat:i.degRad(n)},s=i.rMajor,l=6356752.3142,u=1/298.257223563,h=a.lon-o.lon,c=Math.atan((1-u)*Math.tan(o.lat)),d=Math.atan((1-u)*Math.tan(a.lat)),f=Math.sin(c),m=Math.cos(c),p=Math.sin(d),g=Math.cos(d),v=h,y=2*Math.PI,x=20;Math.abs(v-y)>1e-12&&--x>0;){var _=Math.sin(v),b=Math.cos(v),P=Math.sqrt(g*_*g*_+(m*p-f*g*b)*(m*p-f*g*b));if(0===P)return 0;var T=f*p+m*g*b,S=Math.atan2(P,T),I=m*g*_/P,M=1-I*I,L=T-2*f*p/M;isNaN(L)&&(L=0);var k=u/16*M*(4+u*(4-3*M));y=v,v=h+(1-k)*u*I*(S+k*P*(L+k*T*(-1+2*L*L)))}if(0===x)return 0/0;var C=M*(s*s/(l*l)-1),D=1+C/16384*(4096+C*(-768+C*(320-175*C))),O=C/1024*(256+C*(-128+C*(74-47*C))),w=O*P*(L+O/4*(T*(-1+2*L*L)-O/6*L*(-3+4*P*P)*(-3+4*L*L))),F=l*D*(S-w);return F},_vfi:function(e,t,r){return[-Math.cos(e)*Math.sin(t)+Math.sin(e)*Math.sin(r)*Math.cos(t),Math.cos(e)*Math.cos(t)+Math.sin(e)*Math.sin(r)*Math.sin(t),-Math.sin(e)*Math.cos(r)]},getCircleLatLngs:function(e,r){var n=0,o=0;if(e instanceof t.LatLng)n=e.lng,o=e.lat;else{if(!t.Util.isArray(e))return null;n=e[1],o=e[0]}for(var a=Math.PI/180,s=n*a,l=o*a,u=i.rMajor,h=u*Math.sin(r/u),c=u*Math.cos(r/u),d=[c*Math.cos(l)*Math.cos(s),c*Math.cos(l)*Math.sin(s),c*Math.sin(l)],f=[],m=0,p=2*Math.PI+1e-6;p>m;m+=a){for(var g=i._vfi(m,s,l),v=[],y=0;3>y;y++)v[y]=d[y]+h*g[y];var x=Math.acos(v[0]/Math.sqrt(v[0]*v[0]+v[1]*v[1]))/a;v[1]<0&&(x=-x),n-180>x?x+=360:x>n+180&&(x-=360),f.push([Math.asin(v[2]/u)/a,x])}return f},parseCoordinates:function(e){var r=null,i=/\(EPSG:(\d+)\)/g,n=i.exec(e);if(n&&(r=n[1],e=e.replace(i,"")),e.match(/[йцукенгшщзхъфывапролджэячсмитьбюЙЦУКЕНГШЩЗХЪФЫВАПРОЛДЖЭЯЧСМИТЬБЮqrtyuiopadfghjklzxcvbmQRTYUIOPADFGHJKLZXCVBM_:]/))return null;if(-1===e.indexOf(" ")&&-1===e.indexOf(","))return null;-1!==e.indexOf(" ")&&(e=e.replace(/,/g,"."));var o=[];for(i=/(-?\d+(\.\d+)?)([^\d\-]*)/g,n=i.exec(e);n;)o.push(n[1]),n=i.exec(e);if(o.length<2)return null;var a,s=Math.floor(o.length/2),l=0,u=1;for(a=0;s>a;a++)l+=parseFloat(o[a])*u,u/=60;var h=0;for(u=1,a=s;a<o.length;a++)h+=parseFloat(o[a])*u,u/=60;Math.max(e.indexOf("N"),e.indexOf("S"))>Math.max(e.indexOf("E"),e.indexOf("W"))&&(n=h,h=l,l=n);var c;return"3857"===r&&(c=t.Projection.SphericalMercator.unproject(new t.Point(l,h)._divideBy(6378137)),h=c.lng,l=c.lat),(Math.abs(h)>180||Math.abs(l)>180)&&(c=t.Projection.Mercator.unproject(new t.Point(l,h)),h=c.lng,l=c.lat),-1!==e.indexOf("W")&&(h=-h),-1!==e.indexOf("S")&&(l=-l),[l,h]},pad2:function(e){return e>=0&&10>e?"0"+e:""+e},trunc:function(e){return(""+(Math.round(1e7*e)/1e7+1e-8)).substring(0,9)},formatDegrees:function(e,t){e=Math.round(1e7*e)/1e7+1e-8;var r=Math.floor(e),n=Math.floor(60*(e-r)),o=i.toPrecision(3600*(e-r-n/60),2),a=i.pad2(r)+"°";return void 0===t&&(t=2),t>0&&(a+=i.pad2(n)+"'"),t>1&&(a+=i.pad2(o)+'"'),a},latLonFormatCoordinates:function(e,t){return e%=360,e>180?e-=360:-180>e&&(e+=360),i.formatDegrees(Math.abs(t))+(t>0?" N, ":" S, ")+i.formatDegrees(Math.abs(e))+(e>0?" E":" W")},formatCoordinates:function(e,t){return i.latLonFormatCoordinates(e,t)},latLonFormatCoordinates2:function(e,t){return i.trunc(Math.abs(t))+(t>0?" N, ":" S, ")+i.trunc(Math.abs(e))+(e>0?" E":" W")},formatCoordinates2:function(e,t){return i.latLonFormatCoordinates2(e,t)},getPixelScale:function(e){return 256/i.tileSizes[e]},forEachPoint:function(e,t){if(!e||0===e.length)return[];var r,n,o=[];if(e[0].length)for(r=0,n=e.length;n>r;r++)"string"!=typeof e[r]&&o.push(i.forEachPoint(e[r],t));else{if(2===e.length)return t(e);for(r=0,n=e.length/2;n>r;r++)o.push(t([e[2*r],e[2*r+1]]))}return o},getItemCenter:function(e,t){var r=e.bounds,n=r.min,o=r.max,a=e.type,s="POINT"===a||"MULTIPOINT"===a,l=s?[n.x,n.y]:[(n.x+o.x)/2,(n.y+o.y)/2];if("MULTIPOLYGON"===a)return l;if("POLYGON"===a)for(var u=0,h=t.length;h>u;u++){var c=t[u],d=c.geo,f=d.coordinates,m=c.dataOption,p=m.bounds;if(p.contains(l)){"POLYGON"===d.type&&(f=[f]);for(var g=0,v=f.length;v>g;g++)for(var y=0,x=f[g],_=x.length;_>y;y++){var b=i.getHSegmentsInPolygon(l[1],x[y]);if(b)return b.max.center}}}else{if("POINT"===a||"MULTIPOINT"===a)return l;if("LINESTRING"===a||"MULTILINESTRING"===a)return l}return null},getHSegmentsInPolygon:function(e,t){var r,i,n,o=[],a=1,s=t[0];"number"==typeof t[0]&&(a=2,s=[t[0],t[1]]);var l=e>s[1];for(r=a,i=t.length;i>r;r+=a){var u=1===a?t[r]:[t[r],t[r+1]],h=e>u[1];l!==h&&o.push(s[0]-(s[0]-u[0])*(s[1]-e)/(s[1]-u[1])),s=u,l=h}if(i=o.length){o=o.sort();var c=0,d=-1;for(r=1;i>r;r+=2){var f=r-1,m=Math.abs(o[r]-o[f]);m>c&&(c=m,d=f)}n={y:e,segArr:o,max:{width:c,center:[(o[d]+o[d+1])/2,e]}}}return n},isPointInPolygonArr:function(e,t){var r=!1,i=e[0],n=e[1],o=1,a=t[0];"number"==typeof t[0]&&(o=2,a=[t[0],t[1]]);for(var s=o,l=t.length;l>s;s+=o){var u=1===o?t[s]:[t[s],t[s+1]],h=Math.min(a[0],u[0]),c=Math.max(a[0],u[0]),d=Math.max(a[1],u[1]);if(i>h&&c>=i&&d>=n&&a[0]!==u[0]){var f=(i-a[0])*(u[1]-a[1])/(u[0]-a[0])+a[1];(a[1]===u[1]||f>=n)&&(r=!r)}a=u}return r},isPointInPolygonWithHoles:function(e,t){if(!i.isPointInPolygonArr(e,t[0]))return!1;
for(var r=1,n=t.length;n>r;r++)if(i.isPointInPolygonArr(e,t[r]))return!1;return!0},isClockwise:function(e){for(var t,r=0,i=0,n=e.length;n>i;i++)t=(i+1)%n,r+=e[i][0]*e[t][1],r-=e[t][0]*e[i][1];return 0>r},isPointInPolyLine:function(e,r,i,n){var o=e[0],a=e[1],s={x:o,y:a},l=o-r,u=o+r,h=a-r,c=a+r,d=0;r*=r;for(var f=1,m=i.length;m>f;f++)if(n&&f===n[d])d++;else{var p=i[f-1],g=i[f],v=p[0],y=p[1],x=g[0],_=g[1];if(!(Math.max(v,x)<l||Math.min(v,x)>u||Math.max(y,_)<h||Math.min(y,_)>c)){var b=t.LineUtil._sqClosestPointOnSegment(s,{x:v,y:y},{x:x,y:_},!0);if(r>b)return!0}}return!1},isPointInLines:function(e){for(var t=e.coords,r=e.point,n=e.delta,o=e.boundsArr,a=e.hidden,s=0,l=t.length,u=!1;l>s;s++)if(u=o[s]?o[s].contains(r):!0,u&&i.isPointInPolyLine(r,n,t[s],a?a[s]:null))return!0;return!1},getLength:function(e,r){var n=0;if(e&&e.length){var o=!1,a=!1;r=void 0===r||r,e.forEach(function(e){if(t.Util.isArray(e)){if(t.Util.isArray(e[0]))return n+=i.getLength(e,r);r&&(e=t.Projection.Mercator.unproject({x:e[0],y:e[1]}))}o!==!1&&a!==!1&&(n+=parseFloat(i.distVincenty(o,a,e.lng,e.lat))),o=e.lng,a=e.lat})}return n},prettifyDistance:function(e,r){var i=" "+t.gmxLocale.getText("units.km");return"nm"===r?Math.round(.539956803*e)/1e3+" "+t.gmxLocale.getText("units.nm"):"km"===r?Math.round(e)/1e3+i:2e3>e||"m"===r?Math.round(e)+" "+t.gmxLocale.getText("units.m"):2e5>e?Math.round(e/10)/100+i:Math.round(e/1e3)+i},geoJSONGetLength:function(e){var t,r,n,o,a,s=0;if("GeometryCollection"===e.type?s+=e.geometries.forEach(i.geoJSONGetLength):"Feature"===e.type?s+=i.geoJSONGetLength(e.geometry):"FeatureCollection"===e.type&&(s+=e.features.forEach(i.geoJSONGetLength)),"LineString"===e.type||"MultiLineString"===e.type)for(a=e.coordinates,"LineString"===e.type&&(a=[a]),t=0,n=a.length;n>t;t++)s+=i.getRingLength(a[t]);if("Polygon"===e.type||"MultiPolygon"===e.type)for(a=e.coordinates,"Polygon"===e.type&&(a=[a]),t=0,n=a.length;n>t;t++)for(r=0,o=a[t].length;o>r;r++)s+=i.getRingLength(a[t][r]);return s},getRingLength:function(e){var r=0;if(e&&e.length){var n=!1,o=!1;e.forEach(function(e){return t.Util.isArray(e)&&e.length>2?r+=i.getRingLength(e):(n!==!1&&o!==!1&&(r+=parseFloat(i.distVincenty(n,o,e[0],e[1]))),n=e[0],o=e[1],void 0)})}return r},geoJSONGetArea:function(e){var t=0;if("GeometryCollection"===e.type?t+=e.geometries.forEach(i.geoJSONGetArea):"Feature"===e.type?t+=i.geoJSONGetArea(e.geometry):"FeatureCollection"===e.type&&(t+=e.features.forEach(i.geoJSONGetArea)),"Polygon"===e.type||"MultiPolygon"===e.type){var r=e.coordinates;"Polygon"===e.type&&(r=[r]);for(var n=0,o=r.length;o>n;n++){t+=i.getRingArea(r[n][0]);for(var a=1,s=r[n].length;s>a;a++)t-=i.getRingArea(r[n][a])}}return t},geoJSONGetLatLng:function(e){if("Feature"===e.type)return i.geoJSONGetLatLng(e.geometry);if("Point"===e.type)return t.latLng(e.coordinates[1],e.coordinates[0]);throw new Error("cannot get "+e.type+" latLng")},getRingArea:function(e){for(var t=0,r=0,n=e.length;n>r;r++){var o=r===n-1?0:r+1,a=e[r],s=e[o];t+=a[0]*Math.sin(i.degRad(s[1]))-s[0]*Math.sin(i.degRad(a[1]))}var l=Math.abs(t*i.lambertCoefX*i.lambertCoefY/2);return l},getArea:function(e){for(var t=0,r=0,n=e.length;n>r;r++){var o=r===n-1?0:r+1,a=e[r],s=e[o];t+=a.lng*Math.sin(i.degRad(s.lat))-s.lng*Math.sin(i.degRad(a.lat))}return Math.abs(t*i.lambertCoefX*i.lambertCoefY/2)},prettifyArea:function(e,r){var i=" "+t.gmxLocale.getText("units.km2");return"km2"===r?""+Math.round(e/100)/1e4+i:"ha"===r?""+Math.round(e/100)/100+" "+t.gmxLocale.getText("units.ha"):1e5>e||"m2"===r?Math.round(e)+" "+t.gmxLocale.getText("units.m2"):3e6>e?(""+Math.round(e/1e3)/1e3).replace(".",",")+i:3e7>e?(""+Math.round(e/1e4)/100).replace(".",",")+i:3e8>e?(""+Math.round(e/1e5)/10).replace(".",",")+i:Math.round(e/1e6)+i},geoLength:function(e){var t=0,r=e.type;if("MULTILINESTRING"===r||"MultiLineString"===r){for(var n=0,o=e.coordinates.length;o>n;n++)t+=i.geoLength({type:"LINESTRING",coordinates:e.coordinates[n]});return t}return("LINESTRING"===r||"LineString"===r)&&(t=i.getLength(e.coordinates)),t},geometryToGeoJSON:function(e,t){if(!e)return null;var r="MULTIPOLYGON"===e.type?"MultiPolygon":"POLYGON"===e.type?"Polygon":"MULTILINESTRING"===e.type?"MultiLineString":"LINESTRING"===e.type?"LineString":"MULTIPOINT"===e.type?"MultiPoint":"POINT"===e.type?"Point":e.type,n=e.coordinates;return t&&(n=i.coordsFromMercator(r,n)),{type:r,coordinates:n}},convertGeometry:function(e,t){var r="MULTIPOLYGON"===e.type?"MultiPolygon":"POLYGON"===e.type?"Polygon":"MULTILINESTRING"===e.type?"MultiLineString":"LINESTRING"===e.type?"LineString":"MULTIPOINT"===e.type?"MultiPoint":"POINT"===e.type?"Point":e.type,n=e.coordinates;return n=t?i.coordsFromMercator(r,n):i.coordsToMercator(r,n),{type:e.type,coordinates:n}},geoJSONtoGeometry:function(e,t){if("FeatureCollection"===e.type)return i.geoJSONtoGeometry(e.features[0],t);if("Feature"===e.type)return i.geoJSONtoGeometry(e.geometry,t);if("FeatureCollection"===e.type)return i.geoJSONtoGeometry(e.features[0],t);var r="MultiPolygon"===e.type?"MULTIPOLYGON":"Polygon"===e.type?"POLYGON":"MultiLineString"===e.type?"MULTILINESTRING":"LineString"===e.type?"LINESTRING":"MultiPoint"===e.type?"MULTIPOINT":"Point"===e.type?"POINT":e.type,n=e.coordinates;return t&&(n=i.coordsToMercator(e.type,n)),{type:r,coordinates:n}},_coordsConvert:function(e,r,n){var o,a,s,l=[];if("Point"===e)n?(s=t.Projection.Mercator.project({lat:r[1],lng:r[0]}),l=[s.x,s.y]):(s=t.Projection.Mercator.unproject({y:r[1],x:r[0]}),l=[s.lng,s.lat]);else if("LineString"===e||"MultiPoint"===e)for(o=0,a=r.length;a>o;o++)l.push(i._coordsConvert("Point",r[o],n));else if("Polygon"===e||"MultiLineString"===e)for(o=0,a=r.length;a>o;o++)l.push(i._coordsConvert("MultiPoint",r[o],n));else if("MultiPolygon"===e)for(o=0,a=r.length;a>o;o++)l.push(i._coordsConvert("Polygon",r[o],n));return l},coordsFromMercator:function(e,t){return i._coordsConvert(e,t,!1)},coordsToMercator:function(e,t){return i._coordsConvert(e,t,!0)},transformGeometry:function(e,t){return e?{type:e.type,coordinates:i.forEachPoint(e.coordinates,function(e){return t(e)})}:e},geoArea:function(e,r){var n,o,a=0,s=e.type||"";if(r=void 0===r||r,"MULTIPOLYGON"===s||"MultiPolygon"===s){for(n=0,o=e.coordinates.length;o>n;n++)a+=i.geoArea({type:"POLYGON",coordinates:e.coordinates[n]},r);return a}if("POLYGON"===s||"Polygon"===s){for(a=i.geoArea(e.coordinates[0],r),n=1,o=e.coordinates.length;o>n;n++)a-=i.geoArea(e.coordinates[n],r);return a}if(e.length){var l=[],u="number"==typeof e[0]?2:1;for(n=0,o=e.length;o>n;n+=u){var h=1===u?e[n]:[e[n],e[n+1]];l.push(r?t.Projection.Mercator.unproject({y:h[1],x:h[0]}):{lat:h[1],lng:h[0]})}return i.getArea(l)}return 0},getGeoJSONSummary:function(e,t){var r,n,o,a=e.type,s=t||{},l=0;if("Point"===a)o=e.coordinates,l=i.formatCoordinates(o[0],o[1]);else if("Polygon"===a)l=i.prettifyArea(i.geoArea(e,!1),s.squareUnit);else if("MultiPolygon"===a){for(o=e.coordinates,r=0,n=o.length;n>r;r++)l+=i.geoArea({type:"Polygon",coordinates:o[r]},!1);l=i.prettifyArea(l,s.squareUnit)}else if("LineString"===a)l=i.prettifyDistance(i.geoJSONGetLength(e),s.distanceUnit);else if("MultiLineString"===a){for(o=e.coordinates,r=0,n=o.length;n>r;r++)l+=i.geoJSONGetLength({type:"LineString",coordinates:o[r]});l=i.prettifyDistance(l,s.distanceUnit)}return l},getCoordinatesString:function(e,r){var n,o=e.lng,a=e.lat,s=["",""," (EPSG:3395)"," (EPSG:3857)"],l=s.length,u="";return r=r||0,o>180&&(o-=360),-180>o&&(o+=360),0===r%l?u=i.formatCoordinates2(o,a):1===r%l?u=i.formatCoordinates(o,a):2===r%l?(n=t.Projection.Mercator.project(new t.LatLng(a,o)),u=""+Math.round(n.x)+", "+Math.round(n.y)+s[2]):(n=t.CRS.EPSG3857.project(new t.LatLng(a,o)),u=""+Math.round(n.x)+", "+Math.round(n.y)+s[3]),u},getGeometriesSummary:function(e,r){var n="",o="",a=0;return r||(r={}),e&&e.forEach(function(e){if(e)if(o=e.type.toUpperCase(),-1!==o.indexOf("POINT")){var s=t.Projection.Mercator.unproject({y:e.coordinates[1],x:e.coordinates[0]});n="<b>"+t.gmxLocale.getText("Coordinates")+"</b>: "+i.getCoordinatesString(s,r.coordinatesFormat)}else-1!==o.indexOf("LINESTRING")?a+=i.geoLength(e):-1!==o.indexOf("POLYGON")&&(a+=i.geoArea(e))}),n||(-1!==o.indexOf("LINESTRING")?n="<b>"+t.gmxLocale.getText("Length")+"</b>: "+i.prettifyDistance(a,r.distanceUnit):-1!==o.indexOf("POLYGON")&&(n="<b>"+t.gmxLocale.getText("Area")+"</b>: "+i.prettifyArea(a,r.squareUnit))),n},getGeometrySummary:function(e,t){return i.getGeometriesSummary([e],t||{})},chkOnEdge:function(e,t,r){return e[0]<r.min.x&&t[0]<r.min.x||e[0]>r.max.x&&t[0]>r.max.x?!0:e[1]<r.min.y&&t[1]<r.min.y||e[1]>r.max.y&&t[1]>r.max.y?!0:!1},getHidden:function(e,t){for(var r=[],n="number"==typeof e[0]?2:1,o=null,a=0,s=e.length;s>a;a+=n){var l=1===n?e[a]:[e[a],e[a+1]];o&&i.chkOnEdge(l,o,t)&&r.push(a),o=l}return r},getNormalizeBounds:function(e,r){var n=e.getNorthWest(),o=e.getSouthEast(),a=n.lng,s=o.lng,l=(s-a)/2,u=null,h=null,c=[];if(l>=180)a=-180,s=180;else if(s>180||-180>a){var d=(s+a)/2%360;d>180?d-=360:-180>d&&(d+=360),a=d-l,s=d+l,-180>a?(u=a+360,h=180,a=-180):s>180&&(u=-180,h=s-360,s=180)}var f={x:a,y:o.lat},m={x:s,y:n.lat};if(void 0!==r&&(f=t.Projection.Mercator.project(new t.LatLng([o.lat,a])),m=t.Projection.Mercator.project(new t.LatLng([n.lat,s])),f.y-=r,m.y-=r),c.push(i.bounds([[f.x,f.y],[m.x,m.y]])),u){var p={x:u,y:o.lat},g={x:h,y:n.lat};void 0!==r&&(p=t.Projection.Mercator.project(new t.LatLng([o.lat,u])),g=t.Projection.Mercator.project(new t.LatLng([n.lat,h])),p.y-=r,g.y-=r),c.push(i.bounds([[p.x,p.y],[g.x,g.y]]))}return c},toPrecision:function(e,t){var r=Math.pow(10,t?t:4);return Math.round(r*e)/r},getTileBounds:function(e,t,r){var n=i.tileSizes[r],o=e*n,a=t*n;return i.bounds([[o,a],[o+n,a+n]])},parseTemplate:function(e,t){var r=e.match(/\[([^\]]+)\]/gi);if(r)for(var i=0,n=r.length;n>i;i++){var o=r[i],a=o.substr(1,o.length-2),s=a in t?t[a]:"";e=e.replace(o,s)}return e},getDefaultBalloonTemplate:function(e,t){var r="";for(var i in e)(!t||i in t)&&(r+="<b>"+i+":</b> ["+i+"]<br />");return r+="<br />[SUMMARY]<br />"},parseBalloonTemplate:function(e,r){var n=r.properties;e||(e=i.getDefaultBalloonTemplate(n,r.tileAttributeTypes));var o=e.match(/\[([^\]]+)\]/gi);if(o)for(var a=r.tileAttributeTypes,s=r.unitOptions,l=r.geometries,u=0,h=o.length;h>u;u++){var c=o[u],d=c.substr(1,c.length-2),f="";d in n?f=t.gmxUtil.attrToString(a[d],n[d]):"SUMMARY"===d&&(f=r.summary||t.gmxUtil.getGeometriesSummary(l,s)),e=e.replace(c,f)}return e},styleKeys:{marker:{server:["image","angle","scale","minScale","maxScale","size","circle","center","color"],client:["iconUrl","iconAngle","iconScale","iconMinScale","iconMaxScale","iconSize","iconCircle","iconCenter","iconColor"]},outline:{server:["color","opacity","thickness","dashes"],client:["color","opacity","weight","dashArray"]},fill:{server:["color","opacity","image","pattern","radialGradient","linearGradient"],client:["fillColor","fillOpacity","fillIconUrl","fillPattern","fillRadialGradient","fillLinearGradient"]},label:{server:["text","field","template","color","haloColor","size","spacing","align"],client:["labelText","labelField","labelTemplate","labelColor","labelHaloColor","labelFontSize","labelSpacing","labelAlign"]}},styleFuncKeys:{iconSize:"iconSizeFunction",iconAngle:"rotateFunction",iconScale:"scaleFunction",iconColor:"iconColorFunction",opacity:"opacityFunction",fillOpacity:"fillOpacityFunction",color:"colorFunction",fillColor:"fillColorFunction"},styleFuncError:{iconSize:function(){return 8},iconAngle:function(){return 0},iconScale:function(){return 1},iconColor:function(){return 255},opacity:function(){return 1},fillOpacity:function(){return.5},color:function(){return 255},fillColor:function(){return 255}},defaultStyles:{MinZoom:1,MaxZoom:21,Filter:"",Balloon:"",DisableBalloonOnMouseMove:!0,DisableBalloonOnClick:!1,RenderStyle:{point:{color:255,weight:1,iconSize:8},linestring:{color:255,weight:1},polygon:{color:255,weight:1}}},getDefaultStyle:function(e){var r=i.defaultStyles,n=t.extend({},r);return n.RenderStyle=r.RenderStyle[e],n},toServerStyle:function(e){var t={};for(var r in i.styleKeys)for(var n=i.styleKeys[r],o=0,a=n.client.length;a>o;o++){var s=n.client[o];if(s in e){t[r]||(t[r]={});var l=e[s];("opacity"===s||"fillOpacity"===s)&&(l*=100),t[r][n.server[o]]=l}}return"iconAnchor"in e&&(t.marker||(t.marker={}),t.marker.dx=-e.iconAnchor[0],t.marker.dy=-e.iconAnchor[1]),t},fromServerStyle:function(e){var r,n,o,a,s,l={type:""};for(a in i.styleKeys){var u=i.styleKeys[a];for(n=0,o=u.client.length;o>n;n++)s=u.client[n],s in e&&(l[s]=e[s]);if(r=e[a],r&&"object"==typeof r)for(n=0,o=u.server.length;o>n;n++)if(s=u.server[n],s in r){var h=u.client[n],c=r[s];if("string"==typeof c){if(i.styleFuncKeys[h])if(null===c.match(/[^\d\.]/))c=Number(c);else{var d=t.gmx.Parsers.parseExpression(c);null===d?c=i.styleFuncError[h]():l[i.styleFuncKeys[h]]=d}}else"opacity"===s&&(c/=100);l[h]=c}}if(e.marker&&(r=e.marker,"dx"in r||"dy"in r)){var f=r.dx||0,m=r.dy||0;l.iconAnchor=[-f,-m]}for(a in e)i.styleKeys[a]||(l[a]=e[a]);return l},getUnixTimeFromStr:function(e){var r=t.Util.trim(e).split(" "),i=r[0].split("."),n=r[1]?r[1].split(":"):[0,0,0];return 4===i[2].length&&(i=i.reverse()),Date.UTC(i[0],i[1]-1,i[2],n[0]||0,n[1]||0,n[2]||0)/1e3},getDateFromStr:function(e){var r=t.Util.trim(e).split(" ");r=r[0].split("."),4===r[2].length&&(r=r.reverse());var i=new Date(r[0],r[1]-1,r[2]);return i},getUTCdate:function(e){var t=new Date(1e3*e);return[t.getUTCFullYear(),i.pad2(t.getUTCMonth()+1),i.pad2(t.getUTCDate())].join(".")},getUTCtime:function(e){var t=Math.floor(e/3600),r=Math.floor((e-3600*t)/60),n=Math.floor(e-3600*t-60*r);return[i.pad2(t),i.pad2(r),i.pad2(n)].join(":")},getUTCdateTime:function(e){var t=e%86400;return t?[i.getUTCdate(e),i.getUTCtime(e%86400)].join(" "):i.getUTCdate(e)},attrToString:function(e,r){return"date"===e?r?t.gmxUtil.getUTCdate(r):r:"time"===e?r?t.gmxUtil.getUTCtime(r):r:"datetime"===e?r?t.gmxUtil.getUTCdateTime(r):r:r},getTileAttributes:function(e){var t={},r={};if(e.attributes){var i=e.attributes,n=e.attrTypes||null;e.identityField&&(t[e.identityField]=0);for(var o=0;o<i.length;o++){var a=i[o];t[a]=o+1,r[a]=n?n[o]:"string"}}return{tileAttributeTypes:r,tileAttributeIndexes:t}}};i.lambertCoefX=100*i.distVincenty(0,0,.01,0),i.lambertCoefY=180*100*i.distVincenty(0,0,0,.01)/Math.PI,function(){for(var e=0;30>e;e++)i.tileSizes[e]=40075016.685578495/Math.pow(2,e)}(),i.Bounds=function(e){this.min={x:Number.MAX_VALUE,y:Number.MAX_VALUE},this.max={x:-Number.MAX_VALUE,y:-Number.MAX_VALUE},this.extendArray(e)},i.Bounds.prototype={extend:function(e,t){return e<this.min.x&&(this.min.x=e),e>this.max.x&&(this.max.x=e),t<this.min.y&&(this.min.y=t),t>this.max.y&&(this.max.y=t),this},extendBounds:function(e){return this.extendArray([[e.min.x,e.min.y],[e.max.x,e.max.y]])},extendArray:function(e){if(!e||!e.length)return this;var t,r;if("number"==typeof e[0])for(t=0,r=e.length;r>t;t+=2)this.extend(e[t],e[t+1]);else for(t=0,r=e.length;r>t;t++)this.extend(e[t][0],e[t][1]);return this},addBuffer:function(e,t,r,i){return this.min.x-=e,this.min.y-=t||e,this.max.x+=r||e,this.max.y+=i||t||e,this},contains:function(e){var t=this.min,r=this.max,i=e[0],n=e[1];return i>=t.x&&i<=r.x&&n>=t.y&&n<=r.y},getCenter:function(){var e=this.min,t=this.max;return[(e.x+t.x)/2,(e.y+t.y)/2]},addOffset:function(e){return this.min.x+=e[0],this.max.x+=e[0],this.min.y+=e[1],this.max.y+=e[1],this},intersects:function(e){var t=this.min,r=this.max,i=e.min,n=e.max;return n.x>t.x&&i.x<r.x&&n.y>t.y&&i.y<r.y},intersectsWithDelta:function(e,t,r){var i=this.min,n=this.max,o=t||0,a=r||0,s=e.min,l=e.max;return l.x+o>i.x&&s.x-o<n.x&&l.y+a>i.y&&s.y-a<n.y},isEqual:function(e){var t=this.min,r=this.max,i=e.min,n=e.max;return n.x===r.x&&i.x===t.x&&n.y===r.y&&i.y===t.y},isNodeIntersect:function(e){for(var t=0,r=e.length;r>t;t++)if(this.contains(e[t]))return{num:t,point:e[t]};return null},clipPolygon:function(e){var t,r,i,n,o=this.min,a=this.max,s=[[o.x,o.y],[a.x,o.y],[a.x,a.y],[o.x,a.y]],l=function(e){return(r[0]-t[0])*(e[1]-t[1])>(r[1]-t[1])*(e[0]-t[0])},u=function(){var e=[t[0]-r[0],t[1]-r[1]],o=[i[0]-n[0],i[1]-n[1]],a=t[0]*r[1]-t[1]*r[0],s=i[0]*n[1]-i[1]*n[0],l=1/(e[0]*o[1]-e[1]*o[0]);return[(a*o[0]-s*e[0])*l,(a*o[1]-s*e[1])*l]},h=e;t=s[3];for(var c=0;4>c;c++){r=s[c];var d=h,f=d.length;h=[],i=d[f-1];for(var m=0;f>m;m++)n=d[m],l(n)?(l(i)||h.push(u()),h.push(n)):l(i)&&h.push(u()),i=n;t=r}return h},clipPolyLine:function(e,t,r){r=r||0;var i,n,o,a,s,l,u=this.min,h=this.max,c=[u.x-r,u.y-r,h.x+r,h.y+r],d=function(e){var t=0;return e[0]<c[0]?t|=1:e[0]>c[2]&&(t|=2),e[1]<c[1]?t|=4:e[1]>c[3]&&(t|=8),t},f=function(e,t){return Math.PI/2+Math.atan2(t[1]-e[1],e[0]-t[0])},m=function(e,t,r){return 8&r?[e[0]+(t[0]-e[0])*(c[3]-e[1])/(t[1]-e[1]),c[3]]:4&r?[e[0]+(t[0]-e[0])*(c[1]-e[1])/(t[1]-e[1]),c[1]]:2&r?[c[2],e[1]+(t[1]-e[1])*(c[2]-e[0])/(t[0]-e[0])]:1&r?[c[0],e[1]+(t[1]-e[1])*(c[0]-e[0])/(t[0]-e[0])]:null},p=[],g=e.length,v=d(e[0],c),y=[];for(i=1;g>i;i++)if(n=e[i-1],o=e[i],n[0]!==o[0]||n[1]!==o[1]){for(s=l=d(o,c);;){if(!(v|s)){t&&(n[2]=f(n,o),a=e[i+1],o[2]=a?f(o,a):n[2]),y.push(n),s!==l?(y.push(o),g-1>i&&(p.push(y),y=[])):i===g-1&&y.push(o);break}if(v&s)break;v?(n=m(n,o,v,c),v=d(n,c)):(o=m(n,o,s,c),s=d(o,c))}v=l}return y.length&&p.push(y),p}},i.bounds=function(e){return new i.Bounds(e)},i.parseUri=function(e){for(var t=i.parseUri.options,r=t.parser[t.strictMode?"strict":"loose"].exec(e),n={},o=14;o--;)n[t.key[o]]=r[o]||"";return n[t.q.name]={},n[t.key[12]].replace(t.q.parser,function(e,r,i){r&&(n[t.q.name][r]=i)}),n.hostOnly=n.host,n.host=n.authority,n},i.parseUri.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},t.gmxUtil||(t.gmxUtil={}),t.extend(t.gmxUtil,{newId:i.newId,isPageHidden:i.isPageHidden,protocol:"https:"!==location.protocol?"http:":location.protocol,loaderStatus:function(){},isIE9:i.isIE(9),isIE10:i.isIE(10),isIE11:i.isIE(11),gtIE11:i.gtIE(11),getFormData:i.getFormData,requestJSONP:i.requestJSONP,getCadastreFeatures:i.getCadastreFeatures,request:i.request,getLayerItemFromServer:i.getLayerItemFromServer,fromServerStyle:i.fromServerStyle,toServerStyle:i.toServerStyle,getDefaultStyle:i.getDefaultStyle,bounds:i.bounds,getNormalizeBounds:i.getNormalizeBounds,getGeometryBounds:i.getGeometryBounds,tileSizes:i.tileSizes,getDateFromStr:i.getDateFromStr,getUnixTimeFromStr:i.getUnixTimeFromStr,getUTCdate:i.getUTCdate,getUTCtime:i.getUTCtime,getUTCdateTime:i.getUTCdateTime,attrToString:i.attrToString,getTileAttributes:i.getTileAttributes,formatCoordinates:function(e,t){return i["formatCoordinates"+(t?"2":"")](e.lng,e.lat)},formatDegrees:i.formatDegrees,pad2:i.pad2,dec2hex:i.dec2hex,dec2rgba:i.dec2rgba,trunc:i.trunc,latLonFormatCoordinates:i.latLonFormatCoordinates,latLonFormatCoordinates2:i.latLonFormatCoordinates2,getLength:i.getLength,geoLength:i.geoLength,prettifyDistance:i.prettifyDistance,getArea:i.getArea,prettifyArea:i.prettifyArea,geoArea:i.geoArea,parseBalloonTemplate:i.parseBalloonTemplate,getSVGIcon:i.getSVGIcon,getCoordinatesString:i.getCoordinatesString,getGeometriesSummary:i.getGeometriesSummary,getGeometrySummary:i.getGeometrySummary,getGeoJSONSummary:i.getGeoJSONSummary,getPropertiesHash:i.getPropertiesHash,distVincenty:i.distVincenty,parseCoordinates:i.parseCoordinates,geometryToGeoJSON:i.geometryToGeoJSON,convertGeometry:i.convertGeometry,transformGeometry:i.transformGeometry,geoJSONtoGeometry:i.geoJSONtoGeometry,geoJSONGetArea:i.geoJSONGetArea,geoJSONGetLength:i.geoJSONGetLength,geoJSONGetLatLng:i.geoJSONGetLatLng,parseUri:i.parseUri,isRectangle:i.isRectangle,isClockwise:i.isClockwise,isPointInPolygonWithHoles:i.isPointInPolygonWithHoles,getPatternIcon:i.getPatternIcon,getCircleLatLngs:i.getCircleLatLngs,normalizeHostname:i.normalizeHostname,getTileBounds:i.getTileBounds,parseTemplate:i.parseTemplate}),function(){function e(e,o,a){var s="gmxAPIutils_id"+n++,l=t.DomUtil.create("iframe");l.style.display="none",l.setAttribute("id",e),l.setAttribute("name",e),l.src="javascript:true",l.callbackName=s;var u=i.parseUri(a),h=(u.protocol?u.protocol+":":t.gmxUtil.protocol)+"//"+(u.host||window.location.host);return r[h]=r[h]||{},r[h][s]={callback:o,iframe:l},l}var r={},n=0,o=function(e){if(e.origin in r){var t=decodeURIComponent(e.data.replace(/\n/g,"\n\\"));try{var i=JSON.parse(t)}catch(n){console.log({Status:"error",ErrorInfo:{ErrorMessage:"JSON.parse exeption",ExceptionType:"JSON.parse",StackTrace:t}})}var o=r[e.origin][i.CallbackName];o&&(delete r[e.origin][i.CallbackName],delete i.CallbackName,o.iframe.parentNode&&o.iframe.parentNode.removeChild(o.iframe),"callback"in o&&o.callback(i))}};t.DomEvent.on(window,"message",o),i.createPostIframe2=e}(),function(){function e(e,r,n,o){var a,s,l="$$iframe_"+i.newId(),u=i.createPostIframe2(l,n,e);if(o)a=o,s=a.getAttribute("action"),a.setAttribute("action",e),a.target=l;else if(t.Browser.ielt9){var h="<form id="+l+'" enctype="multipart/form-data" style="display:none" target="'+l+'" action="'+e+'" method="post"></form>';a=document.createElement(h)}else a=document.createElement("form"),a.style.display="none",a.setAttribute("enctype","multipart/form-data"),a.target=l,a.setAttribute("method","POST"),a.setAttribute("action",e),a.id=l;var c=document.createElement("div");c.style.display="none","window"===r.WrapStyle&&(r.WrapStyle="message"),"message"===r.WrapStyle&&(r.CallbackName=u.callbackName);for(var d in r){var f=document.createElement("input"),m="undefined"!=typeof r[d]?r[d]:"";f.setAttribute("type","hidden"),f.setAttribute("name",d),f.setAttribute("value",m),c.appendChild(f)}a.appendChild(c),o||document.body.appendChild(a),document.body.appendChild(u),a.submit(),o?(a.removeChild(c),null!==s?a.setAttribute("action",s):a.removeAttribute("action")):a.parentNode.removeChild(a)}t.gmxUtil.sendCrossDomainPostRequest=i.sendCrossDomainPostRequest=e}();var n=["strokeStyle","fillStyle","lineWidth"],o=n.length,a=i,s=function(e,t,r,i){for(var s=0;o>s;s++){var l=n[s],u=i[l];u!==r[l]&&(r[l]=u)}if(i.dashArray){var h=i.dashArray,c=i.dashOffset||0;"setLineDash"in r&&(r.setLineDash(h),r.lineDashOffset!==c&&(r.lineDashOffset=c))}else"getLineDash"in r&&r.getLineDash().length>0&&r.setLineDash([]);if("round"!==r.lineCap&&(r.lineCap="round"),"round"!==r.lineJoin&&(r.lineJoin="round"),i.canvasPattern)r.fillStyle=r.createPattern(i.canvasPattern.canvas,"repeat");else if(i.fillLinearGradient){for(var d=i.fillLinearGradient,f=d.x1Function?d.x1Function(e,t):d.x1,m=d.y1Function?d.y1Function(e,t):d.y1,p=d.x2Function?d.x2Function(e,t):d.x2,g=d.y2Function?d.y2Function(e,t):d.y2,v=r.createLinearGradient(f,m,p,g),y=0,x=d.addColorStop.length;x>y;y++){var _=d.addColorStop[y],b=d.addColorStopFunctions[y],P=b[0]?b[0](e,t):_[0],T=_.length<3?100:b[2]?b[2](e,t):_[2],S=a.dec2color(b[1]?b[1](e,t):_[1],T>1?T/100:T);v.addColorStop(P,S)}r.fillStyle=i.fillStyle=v}};t.gmxUtil.drawGeoItem=function(e,r,i,n,o){var l,u,h,c,d=e.properties,f=d[0],m=i.gmx,p=i.ctx,g=d[d.length-1],v=null,y=e.dataOption,x=i.rasters||{},_=i.tbounds;if(r.currentStyle=t.extend({},n),o){if(m.styleHook){if(e.styleExtend||(e.styleExtend=m.styleHook(r,m.lastHover&&f===m.lastHover.id)),!e.styleExtend)return!1;r.currentStyle=t.extend(r.currentStyle,e.styleExtend)}s(d,m.tileAttributeIndexes,p,r.currentStyle)}else o={};var b=g.type,P={gmx:m,item:r,style:o,styleExtend:e.styleExtend||{},ctx:p,tpx:i.tpx,tpy:i.tpy};if("POINT"===b&&(P.pointAttr=a.getPixelPoint(P,g.coordinates),!P.pointAttr))return!1;if("POINT"===b||"MULTIPOINT"===b)if(v=g.coordinates,"iconColor"in o&&o.image&&(o.lastImage!==o.image&&(o.lastImage=o.image,o.lastImageData=a.getImageData(o.image)),P.imageData=o.lastImageData),"MULTIPOINT"===b)for(l=0,u=v.length;u>l;l++)P.coords=v[l],a.pointToCanvas(P);else P.coords=v,a.pointToCanvas(P);else if("POLYGON"===b||"MULTIPOLYGON"===b)if(o.image)P.coords=[(y.bounds.min.x+y.bounds.max.x)/2,(y.bounds.min.y+y.bounds.max.y)/2],P.pointAttr=a.getPixelPoint(P,P.coords),P.pointAttr&&a.pointToCanvas(P);else{v=g.coordinates,"POLYGON"===b&&(v=[v]);var T=y.hiddenLines||[],S=y.pixels,I=!0;S&&S.z===m.currentZoom||(S=y.pixels=a.getCoordsPixels({gmx:m,coords:v,tpx:i.tpx,tpy:i.tpy,hiddenLines:T}));var M=function(e,t){for(v=S.coords,T=S.hidden||[],P.flagPixels=I,l=0,u=v.length;u>l;l++){var r=v[l],i=T[l]||[];for(p.beginPath(),h=0,c=r.length;c>h;h++)P.coords=r[h],P.hiddenLines=i[h]||[],e(P);p.closePath(),t&&p.fill()}},L=r.currentStyle.strokeStyle||o.strokeStyle,k=r.currentStyle.lineWidth||o.lineWidth;L&&k&&M(a.polygonToCanvas),i.bgImage?P.bgImage=i.bgImage:x[f]&&(P.bgImage=x[f]),(P.styleExtend.skipRasters||r.skipRasters)&&delete P.bgImage,o.imagePattern?r.currentStyle.fillStyle=p.createPattern(o.imagePattern,"repeat"):P.bgImage&&_.intersectsWithDelta(y.bounds,-1,-1)&&(a.isPatternNode(P.bgImage)&&("rasterOpacity"in m&&(p.globalAlpha=m.rasterOpacity),p.fillStyle=p.createPattern(P.bgImage,"no-repeat"),o.bgImage=!0),M(a.polygonToCanvasFill,!0),p.globalAlpha=1),(r.currentStyle.fillStyle||r.currentStyle.canvasPattern)&&(p.fillStyle=r.currentStyle.canvasPattern||r.currentStyle.fillStyle,M(a.polygonToCanvasFill,!0))}else if("LINESTRING"===b||"MULTILINESTRING"===b){v=g.coordinates,"LINESTRING"===b&&(v=[v]);var C=r.currentStyle||r.parsedStyleKeys,D=C.iconPath||C.iconPath,O=(r.currentStyle.maxSize||r.currentStyle.lineWidth)/m.mInPixel;for(l=0,u=v.length;u>l;l++)if(D){var w=_.clipPolyLine(v[l],!0,O);for(h=0,c=w.length;c>h;h++){P.coords=w[h];var F=a.lineToCanvas(P);F&&(p.save(),a.lineToCanvasAsIcon(F,P),p.restore())}}else P.coords=v[l],a.lineToCanvas(P)}return!0};var l={APIKEY_PARAM:"key",SCRIPT_REGEXP:[/\bleaflet-geomixer(-\w*)?\.js\b/,/\bgeomixer(-\w*)?\.js\b/],_scriptSearched:!1,_scriptAPIKey:null,_searchScriptAPIKey:function(){var e=this;if(this._scriptSearched)return this._scriptAPIKey;for(var t=document.getElementsByTagName("script"),r=0;r<t.length;r++){for(var i=t[r].getAttribute("src"),n=this.SCRIPT_REGEXP,o=0,a=n.length;a>o;o++)if(n[o].exec(i)){var s=i.split("?")[1];if(s)for(var l=s.split("&"),u=0;u<l.length;u++){var h=l[u].split("=");if(h[0]===e.APIKEY_PARAM){e._scriptAPIKey=h[1];break}}break}if(e._scriptAPIKey)break}return this._scriptSearched=!0,this._scriptAPIKey},requestSessionKey:function(e,r){var n=this._sessionKeys;return e in n||(r="undefined"==typeof r?this._searchScriptAPIKey():r,n[e]=new t.gmx.Deferred,r?i.requestJSONP(t.gmxUtil.protocol+"//"+e+"/ApiKey.ashx",{WrapStyle:"func",Key:r}).then(function(t){t&&"ok"===t.Status?n[e].resolve(t.Result.Key):n[e].reject()},n[e].reject):n[e].resolve("")),n[e]},getSessionKey:function(e){var t=this._sessionKeys[e];return t&&t.getFulfilledData()&&t.getFulfilledData()[0]},_sessionKeys:{}};t.gmx=t.gmx||{},t.gmx.gmxSessionManager=l;var u={getMap:function(e,t,r,i,n){return u.loadMapProperties({srs:n,hostName:e,apiKey:t,mapName:r,skipTiles:i})},loadMapProperties:function(e){var r=this._maps,n=e.hostName||e.serverHost,o=e.mapName;if(!r[n]||!r[n][o]){var a={WrapStyle:"func",skipTiles:e.skipTiles||"None",MapName:o,srs:e.srs||"",ModeKey:"map"};3857===e.srs&&(a.cs="wm");var s=new t.gmx.Deferred;r[n]=r[n]||{},r[n][o]={promise:s},l.requestSessionKey(n,e.apiKey).then(function(e){a.key=e,i.requestJSONP(t.gmxUtil.protocol+"//"+n+"/TileSender.ashx",a).then(function(e){e&&"ok"===e.Status&&e.Result?(e.Result.properties.hostName=n,s.resolve(e.Result)):s.reject(e)},s.reject)},s.reject)}return r[n][o].promise},syncParams:{},setSyncParams:function(e){this.syncParams=e},getSyncParams:function(e){var t=this.syncParams;if(e){var r=[];for(var i in t)r.push(i+"="+t[i]);t=r.join("&")}return t},findLayerInfo:function(e,t,r){var i=this._maps[e],n=i&&i[t];if(!n)return null;if(n.layers)return n.layers[r];var o=n.promise.getFulfilledData();return o?(n.layers={},u.iterateLayers(o[0],function(e){n.layers[e.properties.name]=e}),n.layers[r]):null},iterateLayers:function(e,t){var r=function(e){for(var i=0,n=e.length;n>i;i++){var o=e[i];"group"===o.type?r(o.content.children):"layer"===o.type&&t(o.content)}};e&&r(e.children)},iterateNode:function(e,t){var r=function(e){for(var i=e.children,n=0,o=i.length;o>n;n++){var a=i[n];t(a),"group"===a.type&&r(a.content)}};e&&r(e)},_maps:{}};t.gmx.gmxMapManager=u;var h=t.Class.extend({includes:t.Mixin.Events,initialize:function(e,r){this.layers=[],this.layersByTitle={},this.layersByID={},this.dataManagers={};var i=this;this.properties=t.extend({},e.properties),this.properties.BaseLayers=this.properties.BaseLayers?JSON.parse(this.properties.BaseLayers):[],this.rawTree=e,this.layersCreated=new t.gmx.Deferred;var n={},o={};u.iterateLayers(e,function(a){var s=a.properties,l=s.MetaProperties||{},u={mapID:e.properties.name,layerID:s.name};s.hostName=e.properties.hostName,e.srs&&(s.srs=e.srs);var h=s.ContentID||s.type,c=t.extend(u,r);s.dataSource||"parentLayer"in l?(c.parentLayer=s.dataSource||"","parentLayer"in l&&(c.parentLayer=l.parentLayer.Value||""),o[u.layerID]={info:a,options:c}):h in t.gmx._layerClasses?i.addLayer(t.gmx.createLayer(a,c)):(n[h]=n[h]||[],n[h].push({info:a,options:c}))});var a=[];for(var s in n)a.push(t.gmx._loadLayerClass(s).then(function(e){for(var r=n[e],o=0,a=r.length;a>o;o++)i.addLayer(t.gmx.createLayer(r[o].info,r[o].options))}.bind(null,s)));var l,h,c,d={};for(h in o){c=o[h];var f=c.options,m=f.parentLayer,p=this.layersByID[m];p?(c.options.parentOptions=p.getGmxProperties(),c.options.dataManager=this.dataManagers[m]||new g(c.options.parentOptions,!0),this.dataManagers[m]=c.options.dataManager,this.addLayer(t.gmx.createLayer(c.info,c.options))):(l=f.hostName,d[l]||(d[l]={}),d[l][m]||(d[l][m]=[]),d[l][m].push(h))}for(l in d){var v=[],y=t.gmxUtil.protocol+"//"+l;for(h in d[l])v.push({Layer:h});a.push(t.gmxUtil.requestJSONP(y+"/Layer/GetLayerJson.ashx",{WrapStyle:"func",Layers:JSON.stringify(v)},{ids:d[l]}).then(function(e,r){if(e&&"ok"===e.Status&&e.Result)e.Result.forEach(function(e){var n=i.addDataManager(e),a=e.properties,s=a.name;r&&r.ids&&r.ids[s]&&r.ids[s].forEach(function(r){var a=o[r];a.options.parentOptions=e.properties,a.options.dataManager=n,i.addLayer(t.gmx.createLayer(a.info,a.options))})});else if(console.info("Error: loading ",y+"/Layer/GetLayerJson.ashx",e.ErrorInfo),r&&r.ids)for(var n in r.ids)r.ids[n].forEach(function(e){i.addLayer(new t.gmx.DummyLayer(o[e].info.properties))})}))}t.gmx.Deferred.all.apply(null,a).then(this.layersCreated.resolve)},addDataManager:function(e){var t=e.properties.name;return this.dataManagers[t]||(this.dataManagers[t]=new g(e.properties)),this.dataManagers[t]},getDataManager:function(e){return this.dataManagers[e]},addLayer:function(e){var t=e.getGmxProperties();return this.layers.push(e),this.layersByTitle[t.title]=e,this.layersByID[t.name]=e,this.fire("layeradd",{layer:e}),this},removeLayer:function(e){for(var t=e.getGmxProperties(),r=0;r<this.layers.length;r++)if(this.layers[r].getGmxProperties().name===t.name){this.layers.splice(r,1);break}return delete this.layersByTitle[t.title],delete this.layersByID[t.name],this.fire("layerremove",{layer:e}),this},addLayersToMap:function(e){for(var t=this.layers.length-1;t>=0;t--){var r=this.layers[t];r.getGmxProperties().visible&&e.addLayer(r)}return this}});t.gmx=t.gmx||{},t.gmx.gmxMap=h;var c=t.Handler.extend({options:{},initialize:function(e){this._map=e,this._layers={},this._lastLayer=null,this._lastId=null;var r=this;this._drawstart=null,this._lastCursor="";var i=function(){if(r._drawstart)return!0;if(null===r._drawstart){if(e.gmxControlsManager){var t=e.gmxControlsManager.get("drawing");t&&t.on("activechange",function(t){r._drawstart=t.activeIcon,e._container.style.cursor=r._drawstart?"pointer":""})}r._drawstart=!1}return!1},n=function(e){var t=e._container;
if(t)for(var r=t.parentNode.childNodes,i=0,n=r.length;n>i;i++)if(t===r[i])return i;return 0},o={IMG:!0,DIV:!0,path:!0},a=function(){r._lastLayer&&(r._lastLayer.gmxEventCheck({type:"mousemove"},!0),r._lastLayer=null)},s=function(e){var n=e.type,s=r._map,l=!1;if(e.originalEvent){s.gmxMouseDown=t.Browser.webkit?e.originalEvent.which:e.originalEvent.buttons;var u=e.originalEvent.target;l=o[u.nodeName]&&!t.DomUtil.hasClass(u,"leaflet-tile")&&!t.DomUtil.hasClass(u,"leaflet-popup-tip-container")}if(s._animatingZoom||i()||l||"click"===n&&s._skipClick||"mousemove"===n&&s.gmxMouseDown)return a(),s._skipClick=!1,void 0;e.layerPoint&&(s._gmxMouseLatLng=e.latlng,s.gmxMousePos=s.getPixelOrigin().add(e.layerPoint));for(var h,c=Object.keys(r._layers).sort(function(e,t){var i=s._layers[e],n=s._layers[t];if(i&&n){var o=i.options,a=n.options,l=(o.zIndexOffset||0)+(o.zIndex||0),u=(a.zIndexOffset||0)+(a.zIndex||0),h=u-l;return h?h:r._layers[t]-r._layers[e]}return 0}),d=null,f="",m=0,p=c.length;p>m;m++){var g=c[m];if(h=s._layers[g],h&&h._map&&!h._animating&&h.options.clickable&&h.gmxEventCheck(e)){h.hasEventListeners("mouseover")&&(f="pointer"),d=h;break}}r._lastCursor===f||i()||(s._container.style.cursor=f),r._lastCursor=f,"zoomend"!==n&&(d?(r._lastLayer!==d&&a(),r._lastLayer=d):a())};e.on({zoomend:function(){e._gmxMouseLatLng&&setTimeout(function(){s({type:"mousemove",latlng:e._gmxMouseLatLng})},0)},click:s,dblclick:s,mousedown:s,mouseup:s,mousemove:s,contextmenu:s,layeradd:function(e){var t=e.layer;"gmxEventCheck"in t&&t.options.clickable&&(r._layers[t._leaflet_id]=n(t))},layerremove:function(e){var t=e.layer._leaflet_id;delete r._layers[t],r._lastLayer&&r._lastLayer._leaflet_id===t&&(r._lastLayer=null,r._lastId=0)}},this)}});t.Map.addInitHook(function(){this._gmxEventsManager||(this._gmxEventsManager=new c(this),this.isGmxDrawing=function(){return this._gmxEventsManager._drawstart},this.on("remove",function(){this._gmxEventsManager&&this._gmxEventsManager.removeHooks()}))}),function(){var e="rus",r=function(e,t,r,i){i[e]||(i[e]={}),i[e][t]=r};t.gmxLocale={setLanguage:function(e){this._language=e},getLanguage:function(){return window.language||this._language||e}},t.gmxLocaleMixin={addText:function(){var e=arguments[0],t=arguments[1];1===arguments.length&&(t=e,e=null);for(var i in t)if(null===e)for(var n in t[i])r(i,n,t[i][n],this);else r(e,i,t[i],this);return this},getText:function(e){for(var r=t.gmxLocale.getLanguage(),i=this[r]||{},n=e?e.split(/\./):[],o=0,a=n.length;a>o&&i;o++)i=i[n[o]];return i}},t.extend(t.gmxLocale,t.gmxLocaleMixin)}(),t.extend(t.gmxLocale,{rus:{Coordinates:"Координаты",Length:"Длина",nodeLength:"Длина от начала",edgeLength:"Длина сегмента",Area:"Площадь",Perimeter:"Периметр",units:{m:"м",nm:"м.мили",km:"км",m2:"кв. м",km2:"кв. км",ha:"га",m2html:"м<sup>2",km2html:"км<sup>2"}}}),t.extend(t.gmxLocale,{eng:{Coordinates:"Coordinates",Length:"Length",nodeLength:"From start point",edgeLength:"Segment length",Area:"Area",Perimeter:"Perimeter",units:{m:"m",nm:"nmi",km:"km",m2:"sq. m",km2:"sq. km",ha:"ha",m2html:"m<sup>2",km2html:"km<sup>2"}}});var d={_loadedTiles:{},_getKey:function(e){return[e.layerID,e.x,e.y,e.z,"undefined"==typeof e.d?-1:e.d,"undefined"==typeof e.s?-1:e.s,e.v].join(":")},load:function(e,r){var n=d._getKey(r);if(!this._loadedTiles[n]){var o=new t.gmx.Deferred;this._loadedTiles[n]=o;var a={ModeKey:"tile",r:"j",LayerName:r.layerID,z:r.z,x:r.x,y:r.y,v:r.v};r.srs&&(a.srs=r.srs),-1!==r.d&&(a.Level=r.d,a.Span=r.s),i.requestJSONP(e,a,{callbackParamName:null}).then(null,function(){o.reject()})}return this._loadedTiles[n]}};window.gmxAPI=window.gmxAPI||{},window.gmxAPI._vectorTileReceiver=window.gmxAPI._vectorTileReceiver||function(e){var t=d._getKey({layerID:e.LayerName,x:e.x,y:e.y,z:e.z,d:e.level,s:e.span,v:e.v});d._loadedTiles[t]&&d._loadedTiles[t].resolve(e.values,e.bbox,e.srs,e.isGeneralized)};var f=function(e,r){this.dataProvider=e,this.loadDef=new t.gmx.Deferred,this.data=null,this.dataOptions=null,this.x=r.x,this.y=r.y,this.z=r.z,this.v=r.v,this.s=r.s||-1,this.d=r.d||-1,this.attributes=r.attributes,this.isGeneralized=r.isGeneralized,this.isFlatten=r.isFlatten,this.bounds=i.getTileBounds(this.x,this.y,this.z),this.gmxTilePoint={x:this.x,y:this.y,z:this.z,s:this.s,d:this.d},this.vectorTileKey=f.makeTileKey(this.x,this.y,this.z,this.v,this.s,this.d),this.s>=0&&r.dateZero&&(this.beginDate=new Date(r.dateZero.valueOf()+1e3*this.s*this.d*i.oneDay),this.endDate=new Date(r.dateZero.valueOf()+1e3*(this.s+1)*this.d*i.oneDay)),this.state="notLoaded"};f.prototype={addData:function(e,t){t&&this.removeData(t,!0);for(var r=e.length,n=new Array(r),o=i.bounds(),a=0;r>a;a++){var s=this._parseItem(e[a]);n[a]=s,o.extendBounds(s.bounds)}return this.data?(this.data=this.data.concat(e),this.dataOptions=this.dataOptions.concat(n)):(this.data=e,this.dataOptions=n),this.state="loaded",this.loadDef.resolve(this.data),o},removeData:function(e){for(var t=this.data||[],r=t.length-1;r>=0;r--)e[t[r][0]]&&(t.splice(r,1),this.dataOptions&&this.dataOptions.splice(r,1))},load:function(){if("notLoaded"===this.state){this.state="loading";var e=this;this.dataProvider.load(e.x,e.y,e.z,e.v,e.s,e.d,function(t,r,i,n){e.bbox=r,e.srs=i,n&&(e.isGeneralized=n),e.addData(t)})}return this.loadDef},clear:function(){this.state="notLoaded",this.data=null,this.dataOptions=null,this.loadDef=new t.gmx.Deferred},_parseItem:function(e){var t,r=e.length-1;for(t=1;r>t;t++)null===e[t]&&(e[t]="");var n=e[r],o=this.isFlatten,a=n.type,s=-1!==a.indexOf("POLYGON")||-1!==a.indexOf("Polygon"),l="POLYGON"===a||"Polygon"===a,u=n.coordinates,h=[],c=null,d=[];if(s){l&&(u=[u]),c=i.bounds();var f=i.bounds().extendBounds(this.bounds).addBuffer(-.05),m=!1;for(t=0,r=u.length;r>t;t++){for(var p=[],g=[],v=0,y=u[t].length;y>v;v++){o&&"number"!=typeof u[t][v][0]&&(u[t][v]=i.flattenRing(u[t][v]));var x=i.bounds(u[t][v]);p.push(x),0===v&&c.extendBounds(x);var _=i.getHidden(u[t][v],f);g.push(_),_.length&&(m=!0)}d.push(p),h.push(g)}m||(h=null),l&&(d=d[0])}else if("POINT"===a||"Point"===a)c=i.bounds([u]);else if("MULTIPOINT"===a||"MultiPoint"===a)for(c=i.bounds(),t=0,r=u.length;r>t;t++)c.extendBounds(i.bounds([u[t]]));else if("LINESTRING"===a||"LineString"===a)c=i.bounds(u);else if("MULTILINESTRING"===a||"MultiLineString"===a)for(c=i.bounds(),t=0,r=u.length;r>t;t++)c.extendBounds(i.bounds(u[t]));var b={bounds:c,boundsArr:d};return h&&(b.hiddenLines=h),b}},f.makeTileKey=function(e,t,r,i,n,o){return r+"_"+e+"_"+t+"_"+i+"_"+n+"_"+o},f.createTileKey=function(e){return[e.z,e.x,e.y,e.v,e.s,e.d].join("_")},f.parseTileKey=function(e){var t=e.split("_").map(function(e){return Number(e)});return{z:t[0],x:t[1],y:t[2],v:t[3],s:t[4],d:t[5]}},f.boundsFromTileKey=function(e){var t=f.parseTileKey(e);return i.getTileBounds(t.x,t.y,t.z)};var m=t.Class.extend({includes:t.Mixin.Events,initialize:function(e){this.type=e.type||"update",this._callback=e.callback,this.layerID=e.layerID,this.target=e.target,this.itemHook=e.itemHook,this._items=null,this.bbox=e.bbox,this.needBbox=e.needBbox,this.filters=e.filters||[],this.targetZoom=e.targetZoom||null,this.active="active"in e?e.active:!0,e.bounds&&this.setBounds(e.bounds);var t,r=i.worldWidthMerc;this.bbox?this.bbox.max.x>r?(t=this.bbox.max.x-r,this.bbox1=i.bounds([[t-r,this.bbox.max.y],[-(t+r),this.bbox.min.y]])):this.bbox.min.x<-r&&(t=this.bbox.min.x+r,this.bbox1=i.bounds([[t+r,this.bbox.max.y],[r-t,this.bbox.min.y]])):(this.bbox=i.bounds([[-r,-r],[r,r]]),this.world=!0),e.dateInterval&&this._setDateInterval(e.dateInterval[0],e.dateInterval[1])},hasFilter:function(e){for(var t=0,r=this.filters.length;r>t;t++)if(this.filters[t]===e)return!0;return!1},activate:function(){return this.active||(this.active=!0,this.fire("activate")),this},deactivate:function(){return this.active&&(this.active=!1,this.fire("activate")),this},toggleActive:function(e){return e?this.activate():this.deactivate()},isActive:function(){return this.active},updateData:function(e){var t=e.length,r={count:t};if("update"===this.type){this._items||(this._items={});for(var i,n=this._items,o={},a=[],s=[],l=0;t>l;l++){var u=e[l];i=u.id+"_"+u.tileKey,o[i]=u,n[i]||a.push(u)}for(i in n)o[i]||s.push(n[i]);a.length&&(r.added=a),s.length&&(r.removed=s),this._items=o}else r.added=e;return this.fire("data",{data:this._callback(r)}),r=null,e=null,this},removeData:function(e){if("update"!==this.type||!this._items)return this;var t=this._items,r=[];for(var i in e)t[i]&&(r.push(t[i]),delete t[i]);return r.length&&this._callback({removed:r}),this},setBounds:function(e,r){var n;if(!e)return this.world||(n=i.worldWidthMerc,this.bbox=i.bounds([[-n,-n],[n,n]]),this.bbox1=null,this.world=!0,this.fire("update")),this;var o=e.min,a=e.max;if(!o||!a){var s=t.latLngBounds(e),l=s.getSouthWest(),u=s.getNorthEast();o={x:l.lng,y:l.lat},a={x:u.lng,y:u.lat}}var h=o.x,c=a.x,d=o.y,f=a.y,m=null,p=null;if(this.world=!1,n=(c-h)/2,n>=180)h=-180,c=180,this.world=!0;else if(c>180||-180>h){var g=(c+h)/2%360;g>180?g-=360:-180>g&&(g+=360),h=g-n,c=g+n,-180>h?(m=h+360,p=180,h=-180):c>180&&(m=-180,p=c-360,c=180)}var v=t.Projection.Mercator.project(t.latLng(d,h)),y=t.Projection.Mercator.project(t.latLng(f,c));return this.bbox=i.bounds([[v.x,v.y],[y.x,y.y]]),r&&this.bbox.addBuffer(r),this.bbox1=null,m&&(v=t.Projection.Mercator.project(t.latLng(d,m)),y=t.Projection.Mercator.project(t.latLng(f,p)),this.bbox1=i.bounds([[v.x,v.y],[y.x,y.y]]),r&&this.bbox1.addBuffer(r)),this.fire("update"),this},intersects:function(e){return this.world||this.bbox.intersects(e)||!(!this.bbox1||!this.bbox1.intersects(e))},intersectsWithTile:function(e){if(this.targetZoom&&!this.needBbox){var t=this.targetZoom+(this.targetZoom%2?1:0);if(e.isGeneralized&&e.z!==t||e.z>t)return!1}var r=this.dateInterval;return this.intersects(e.bounds)&&(!e.beginDate||r&&r.endDate>=e.beginDate&&r.beginDate<=e.endDate)},_setDateInterval:function(e,t){this.dateInterval=e&&t?{beginDate:e,endDate:t}:null},setDateInterval:function(e,t){var r=e&&t;return(!this.dateInterval!=!r||r&&(this.dateInterval.beginDate.valueOf()!==e.valueOf()||this.dateInterval.endDate.valueOf()!==t.valueOf()))&&(this._setDateInterval(e,t),this.fire("update",{temporalFilter:!0})),this}});t.gmx.observer=function(e){return new m(e)},function(){var e=function(e){var t=[],r=e.TemporalTiles||[],n=e.TemporalVers||[],o=e.TemporalPeriods||[],a=o[o.length-1],s=Number.MAX_VALUE,l=e.ZeroDate.split("."),u=new Date(l.length>2?l[2]:2008,l.length>1?l[1]-1:0,l.length>0?l[0]:1),h=new Date(u.getTime()-6e4*u.getTimezoneOffset()),c=h.getTime()/1e3;this.dateZero=h;var d,m,p=function(e,t,r){var n=e.d;if(t.d===o[n])return e.count++,e.tiles.push(r),void 0;var a=o[n-1],s=o[n]/a;"children"in e||(e.children=new Array(s));var l=Math.floor(t.s*t.d/a),u=l-e.s*s;if(!e.children[u]){var h=a*i.oneDay,d=l*h+c;e.children[u]={d:n-1,s:l,t1:d,t2:d+h,count:0,children:[],tiles:[]}}p(e.children[u],t,r)},g=o.length-1,v=o[g]*i.oneDay;for(d=0,m=r.length;m>d;d++){l=r[d];var y=Number(l[1]),x=Number(l[0]);x===a&&(s=Math.min(s,y))}for(d=0,m=r.length;m>d;d++){l=r[d];var _={x:Number(l[2]),y:Number(l[3]),z:Number(l[4]),v:Number(n[d]),s:Number(l[1]),d:Number(l[0])};if(!(_.d<0)){var b=Math.floor(_.s*_.d/o[g])-s,P=b+s;t[b]=t[b]||{d:g,s:P,t1:P*v+c,t2:(P+1)*v+c,count:0,tiles:[]};var T=f.createTileKey(_);p(t[b],_,T)}}r=n=null,this.selectTiles=function(e,r,i){i=i||{};for(var n=e.valueOf()/1e3,a=r.valueOf()/1e3,s=0,l=(a-n)/3600/24,u=0;u<o.length;u++)if(o[u]>l){s=Math.max(0,u-1);break}o[o.length-1]<=l&&(s=o.length-1);for(var h=Math.min(o.length-1,s+Number(l>o[s])),c=function(e,t){for(var r=0,i=0;i<e.length;i++)e[i].intersects(t)&&r++;return r},d=function(e,t,r){if(t>=e.t2||r<=e.t1)return{count:0,tiles:[],nodes:[]};if(i.bounds&&!e.tileBounds&&(e.tileBounds=e.tiles.map(function(e){return f.boundsFromTileKey(e)})),e.d===s){var n=i.bounds?c(e.tileBounds,i.bounds):e.count;return{tiles:e.tiles,count:n,nodes:[e]}}var o,a=0,l=[],u=e.children?e.children.length:0;for(o=0;u>o;o++)l[o]=e.children[o]?d(e.children[o],Math.max(t,e.t1),Math.min(r,e.t2)):{count:0,tiles:[],nodes:[]},a+=l[o].count;var m=i.bounds?c(e.tileBounds,i.bounds):e.count;if(e.d>h||m>a){var p=[],g=[];for(o=0;o<l.length;o++)g.push(l[o].nodes),p.push(l[o].tiles);return{tiles:[].concat.apply([],p),count:a,nodes:[].concat.apply([],g)}}return{tiles:e.tiles,count:m,nodes:[e]}},m=[],p=0;p<t.length;p++)if(t[p]){var g=d(t[p],n,a);g.tiles.length&&(m=m.concat(g.tiles))}for(var v={},y=0;y<m.length;y++)v[m[y]]=!0;return{tiles:v}},this.getNode=function(e,r){if(0>e||0>r)return null;for(var i=function(e,t,r){if(!e)return null;if(o[e.d]===t)return e.s===r?e:null;var n=o[e.d]/o[e.d-1],a=Math.floor(r*t/o[e.d-1]),s=a-e.s*n;return e.children[s]?i(e.children[s],t,r):null},n=0;n<t.length;n++){var a=i(t[n],e,r);if(a)return a}return null}};t.gmx.tilesTree=function(t){return new e(t)}}();var p=t.Class.extend({includes:t.Mixin.Events,initialize:function(e){this._dataManager=e,this._observerData={},this._tileData={}},addObserver:function(e){return this._observerData[e.id]={observer:e,tiles:{},leftToLoad:0,loadingState:!1},e.on("update",this._updateObserver.bind(this,e)),this._updateObserver(e),this},removeObserver:function(e){var t=this._observerData[e].tiles;for(var r in t)delete this._tileData[r].observers[e];return delete this._observerData[e],this},addTile:function(e){var t="loaded"===e.state?0:1;e.loadDef.then(this._tileLoadedCallback.bind(this,e));var r={};for(var i in this._observerData){var n=this._observerData[i];n.observer.intersectsWithTile(e)&&(n.tiles[e.vectorTileKey]=!0,n.leftToLoad+=t,r[i]=!0)}return this._tileData[e.vectorTileKey]={observers:r,tile:e},this},removeTile:function(e){var t=this._tileData[e],r="loaded"===t.tile.state?0:1;for(var i in t.observers){var n=this._observerData[i];n.leftToLoad-=r,delete n.tiles[e]}return delete this._tileData[e],this},startLoadTiles:function(e){this._dataManager._getActiveTileKeys();var t=this._observerData[e.id];if(0===t.leftToLoad)return this.fire("observertileload",{observer:e}),this;t.loadingState||(t.loadingState=!0,e.fire("startLoadingTiles"));for(var r in t.tiles)this._tileData[r].tile.load();return this},getTileObservers:function(e){return this._tileData[e].observers},getObserverLoadingState:function(e){return this._observerData[e.id].loadingState},getObserverLeftToLoad:function(e){return this._observerData[e.id].leftToLoad},_updateObserver:function(e){var t,r=this._observerData[e.id],i={},n=0;for(t in this._tileData){var o=this._tileData[t].tile;e.intersectsWithTile(o)&&(i[t]=!0,"loaded"!==o.state&&n++,this._tileData[t].observers[e.id]=!0)}for(t in r.tiles)t in i||delete this._tileData[t].observers[e.id];r.tiles=i,r.leftToLoad=n},_tileLoadedCallback:function(e){if(this.fire("tileload",{tile:e}),e.vectorTileKey in this._tileData){var t=this._tileData[e.vectorTileKey].observers;for(var r in t){var i=this._observerData[r];i.leftToLoad--,0===i.leftToLoad&&(i.loadingState&&(i.loadingState=!1,i.observer.fire("stopLoadingTiles")),this.fire("observertileload",{observer:i.observer}))}}}}),g=t.Class.extend({includes:t.Mixin.Events,options:{name:null,srs:"",identityField:"",attributes:[],attrTypes:[],tiles:null,tilesVers:null,LayerVersion:-1,GeoProcessing:null,Temporal:!1,TemporalColumnName:"",ZeroDate:"01.01.2008",TemporalPeriods:[],TemporalTiles:[],TemporalVers:[],hostName:"maps.kosmosnimki.ru",sessionKey:"",isGeneralized:!1,needBbox:!1,isFlatten:!1},setOptions:function(e){this._clearProcessing(),e.GeoProcessing&&(this.processingTile=this.addData([]),this._chkProcessing(e.GeoProcessing)),t.setOptions(this,e),this.optionsLink=e,this._isTemporalLayer=this.options.Temporal;var r=t.gmxUtil.getTileAttributes(this.options);this.tileAttributeIndexes=r.tileAttributeIndexes,this.temporalColumnType=r.tileAttributeTypes[this.options.TemporalColumnName];var i=this.options.hostName,n=this.options.sessionKey;n||(n=t.gmx.gmxSessionManager.getSessionKey(i)),this.tileSenderPrefix=t.gmxUtil.protocol+"//"+i+"/"+"TileSender.ashx?WrapStyle=None"+"&key="+encodeURIComponent(n),this._needCheckActiveTiles=!0},_vectorTileDataProviderLoad:function(e,t,r,i,n,o,a){var s=this;d.load(s.tileSenderPrefix,{x:e,y:t,z:r,v:i,s:n,d:o,srs:this.options.srs,layerID:s.options.name}).then(a,function(){console.log("Error loading vector tile"),a([]),s.fire("chkLayerUpdate",{dataProvider:s})})},initialize:function(e,t){this._tilesTree=null,this._activeTileKeys={},this._endDate=null,this._beginDate=null,this._tiles={},this._filters={},this._filtersView={},this._freeSubscrID=0,this._items={},this._observers={},this._needCheckDateInterval=!1,this._needCheckActiveTiles=!0;var r=this;this._vectorTileDataProvider={load:this._vectorTileDataProviderLoad.bind(this)},this._observerTileLoader=new p(this),this._observerTileLoader.on("tileload",function(e){var t=e.tile;if(r._updateItemsFromTile(t),r._tilesTree){var i=r._tilesTree.getNode(t.d,t.s);i&&i.count--}}),this._observerTileLoader.on("observertileload",function(e){var t=e.observer;t.isActive()&&(t.needRefresh=!1,t.updateData(r.getItems(t.id)))}),this.setOptions(e),t&&(this.options.LayerVersion=-1),this._isTemporalLayer&&this.addFilter("TemporalFilter",function(e,t,r){var i=e.options.unixTimeStamp,n=r.dateInterval;return n&&i>=n.beginDate.valueOf()&&i<n.endDate.valueOf()})},_getActiveTileKeys:function(){if(this._chkMaxDateInterval(),!this._needCheckActiveTiles)return this._activeTileKeys;if(this._needCheckActiveTiles=!1,this._isTemporalLayer){var e={};this._beginDate&&this._endDate&&(this._tilesTree||this.initTilesTree(),e=this._tilesTree.selectTiles(this._beginDate,this._endDate).tiles),this._updateActiveTilesList(e)}else this.initTilesList();return this._activeTileKeys},getViewFilters:function(e,t){var r=[];e=e||"screen";for(var i in this._filtersView[t])0===i.indexOf(e)&&r.push(i);return r},_getObserversByFilterName:function(e,t){var r={};for(var i in this._observers){var n=this._observers[i];n.hasFilter(e)?r[i]=!0:t&&t===n.target&&(n.filters.push(e),r[i]=!0)}return r},addLayerFilter:function(e,t){if(t&&t.layerID){var r=t.layerID,i=t.target||"screen";this._filtersView[r]||(this._filtersView[r]={}),t.id&&(i+="_"+t.id),this._filtersView[r][i]=e,this._triggerObservers(this._getObserversByFilterName(i,t.target))}return this},removeLayerFilter:function(e){if(this._filtersView[e.layerID]){var t=e.layerID,r=e.target||"screen";if(e.id&&(r+="_"+e.id),this._filtersView[t][r]){var i=this._getObserversByFilterName(r);delete this._filtersView[t][r],this._triggerObservers(i)}}return this},addFilter:function(e,t){return this._filters[e]=t,this._triggerObservers(this._getObserversByFilterName(e)),this},removeFilter:function(e){if(this._filters[e]){var t=this._getObserversByFilterName(e);delete this._filters[e],this._triggerObservers(t)}return this},getItems:function(e){var t=[],r=this._observers[e];if(!r)return[];var i=r.layerID,n=this._filtersView[i]||{},o=r.filters.concat("processingFilter");this._isTemporalLayer&&o.push("TemporalFilter"),o=o.filter(function(e){return e in this._filters||e in n}.bind(this));var a=this,s=function(e){var i=e.data,s=t.length,l=i.length;t.length=s+l;for(var u=0;l>u;u++){var h=e.dataOptions[u];if(r.intersects(h.bounds)){for(var c=i[u],d=c[0],f=a.getItem(d),m=c[c.length-1],p=!1,g=0;g<o.length;g++){var v=o[g],y=a._filters[v]||n[v];if(y&&!y(f,e,r,m,h)){p=!0;break}}if(!p){var x={id:d,properties:c,item:f,dataOption:h,tileKey:e.vectorTileKey};r.itemHook?r.itemHook(x):t[s++]=x}}}t.length=s},l=this._getActiveTileKeys();for(var u in l){var h=a._tiles[u].tile;h.data&&h.data.length>0&&(0===h.z||r.intersectsWithTile(h))&&s(h)}return t},_updateItemsFromTile:function(e){for(var t=e.vectorTileKey,r=e.data||[],i=r.length,n=r[0]&&r[0].length-1,o=0;i>o;o++){var a=r[o],s=a[n],l=a[0],u=this._items[l];if(u?(u.processing?e.data[o]=u.properties:(u.properties=a,-1===u.type.indexOf("MULTI")&&(u.type="MULTI"+u.type)),delete u.bounds,u.currentFilter=null):(u={id:l,type:s.type,properties:a,options:{fromTiles:{}}},this._items[l]=u),u.options.fromTiles[t]=o,e.isGeneralized&&(u.options.isGeneralized=!0),this.options.TemporalColumnName){var h=a[this.tileAttributeIndexes[this.options.TemporalColumnName]];u.options.unixTimeStamp=1e3*h}}return i},getMaxDateInterval:function(){return this._chkMaxDateInterval(),{beginDate:this._beginDate,endDate:this._endDate}},_chkMaxDateInterval:function(){if(this._isTemporalLayer&&this._needCheckDateInterval){this._needCheckDateInterval=!1;var e=this._observers,t=null,r=null;for(var i in e){var n=e[i],o=n.dateInterval;o&&((!t||o.beginDate<t)&&(t=o.beginDate),(!r||o.endDate>r)&&(r=o.endDate))}t&&r&&(this._beginDate!==t||this._endDate!==r)&&(this._beginDate=t,this._endDate=r,this._needCheckActiveTiles=!0)}},addObserver:function(e,t){t=t||"s"+ ++this._freeSubscrID;var r=this,i=new m(e);return i.id=t,i.needRefresh=!0,this._observerTileLoader.addObserver(i),i.on("update",function(e){i.needRefresh=!0,e.temporalFilter&&(r._needCheckDateInterval=!0),r._waitCheckObservers()}).on("activate",function(){r.fire("observeractivate"),r.checkObserver(i)}),r._needCheckDateInterval=!0,this._observers[t]=i,this._waitCheckObservers(),i.isActive()&&this.fire("observeractivate"),i},getActiveObserversCount:function(){var e=0;for(var t in this._observers)this._observers[t].isActive()&&e++;return e},getObserver:function(e){return this._observers[e]},removeObserver:function(e){if(this._observers[e]){this._observerTileLoader.removeObserver(e);var t=this._observers[e].isActive();delete this._observers[e],t&&this.fire("observeractivate")}},getObserverLoadingState:function(e){return this._observerTileLoader.getObserverLoadingState(e)},getObserverLeftToLoad:function(e){return this._observerTileLoader.getObserverLeftToLoad(e)},getTileKeysToLoad:function(e,t){var r=this._tilesTree.selectTiles(e,t).tiles;return r},getItemsBounds:function(){if(!this._itemsBounds){this._itemsBounds=i.bounds();for(var e in this._items){var t=this.getItem(e);this._itemsBounds.extendBounds(t.bounds)}}return this._itemsBounds},getItem:function(e){var t=this._items[e];if(t&&!t.bounds){var r=t.options.fromTiles,n=[];for(var o in r)if(this._tiles[o]){var a=r[o],s=this._tiles[o].tile;"loaded"===s.state&&s.dataOptions[a]?n.push(s.dataOptions[a].bounds):delete r[o]}if(1===n.length)t.bounds=n[0];else{t.bounds=i.bounds();for(var l=i.worldWidthMerc,u=0,h=n.length;h>u;u++){var c=n[u];t.bounds.max.x-c.min.x>l&&(c=i.bounds([[c.min.x+2*l,c.min.y],[c.max.x+2*l,c.max.y]])),t.bounds.extendBounds(c)}}}return t},getItemMembers:function(e){var t=this._items[e].options.fromTiles,r=[];for(var i in t)if(this._tiles[i]){var n=this._tiles[i].tile;if(n.data){var o=t[i],a=n.data[o],s=n.dataOptions[o],l=s.bounds;r.push({geo:a[a.length-1],width:l.max.x-l.min.x,dataOption:s})}}return r.sort(function(e,t){return t.width-e.width})},getItemGeometries:function(e){var t=this._items[e]?this._items[e].options.fromTiles:{},r=[];for(var n in t)if(this._tiles[n]&&this._tiles[n].tile.data){var o=this._tiles[n].tile.data,a=o[t[n]];r.push(i.getUnFlattenGeo(a[a.length-1]))}return r},addTile:function(e){this._tiles[e.vectorTileKey]={tile:e},this._getActiveTileKeys()[e.vectorTileKey]=!0,this._observerTileLoader.addTile(e),this.checkObservers()},checkObserver:function(e){e.needRefresh&&e.isActive()&&this._observerTileLoader.startLoadTiles(e)},checkObservers:function(){var e=this._observers;for(var t in this._observers)this.checkObserver(e[t])},_waitCheckObservers:function(){this._checkObserversTimer&&clearTimeout(this._checkObserversTimer),this._checkObserversTimer=setTimeout(t.bind(this.checkObservers,this),0)},_triggerObservers:function(e){var t=e||this._observers;for(var r in t)this._observers[r]&&(this._observers[r].needRefresh=!0);this._waitCheckObservers()},_removeDataFromObservers:function(e){var t=this._observers;for(var r in t)this._observers[r].removeData(e);this._waitCheckObservers()},preloadTiles:function(e,t,i){var n={};this._isTemporalLayer?(this._tilesTree||this.initTilesTree(),n=this._tilesTree.selectTiles(e,t).tiles):(this._needCheckActiveTiles=!0,n=this._getActiveTileKeys());var o=[];for(var a in n){var s=this._getVectorTile(a,!0).tile;if("notLoaded"===s.state&&(!i||i.intersects(s.bounds))){var l=s.load();o.push(l)}}return r.all.apply(null,o)},_updateActiveTilesList:function(e){if(this._tileFilteringHook){var t={};for(var r in e)this._tileFilteringHook(this._getVectorTile(r,!0).tile)&&(t[r]=!0);e=t}var i,n=this._activeTileKeys||{},o={},a=this;this.processingTile&&(e[this.processingTile.vectorTileKey]=!0),this._rasterVectorTile&&(i=this._rasterVectorTile.vectorTileKey,e[i]=!0,this._tiles[i]={tile:this._rasterVectorTile});var s=function(e){var t=a._observerTileLoader.getTileObservers(e);for(var r in t)o[r]=!0};for(i in e)n[i]||(this._observerTileLoader.addTile(this._getVectorTile(i,!0).tile),s(i));for(i in n)e[i]||(s(i),this._observerTileLoader.removeTile(i));this._activeTileKeys=e,this._triggerObservers(o)},_propertiesToArray:function(e){var t=e.properties,r=this.tileAttributeIndexes,i=[];for(var n in r)i[r[n]]=t[n];return i[i.length]=e.geometry,i[0]=e.id,i},_clearProcessing:function(){if(this.processingTile){for(var e=this._items,t=this.processingTile,r=t.vectorTileKey,i=t.data||[],n=0,o=i.length;o>n;n++){var a=i[n][0];if(e[a]){var s=e[a];s.processing=null,s.currentFilter=null,delete s.options.fromTiles[r],delete s.fromServerProps,delete s.geometry}}t.clear()}},_chkProcessing:function(e){var t,r,i,n,o,a=this._items,s=!1,l={};if(e){if(e.Deleted)for(r=0,i=e.Deleted.length;i>r;r++)t=e.Deleted[r],l[t]=!0,a[t]&&(a[t].processing=!0,a[t].currentFilter=null),i>0&&(s=!0);var u={};if(e.Inserted)for(r=0,i=e.Inserted.length;i>r;r++)n=e.Inserted[r],l[n[0]]||(u[n[0]]=n);if(e.Updated){for(r=0,i=e.Updated.length;i>r;r++)n=e.Updated[r],l[n[0]]||(u[n[0]]=n);!s&&i>0&&(s=!0)}o=[];for(t in u)this._items[t]&&(this._items[t].properties=u[t],this._items[t].processing=!0,this._items[t].currentFilter=null),o.push(u[t]);o.length>0&&(this.processingTile=this.addData(o))}s?this.addFilter("processingFilter",function(e,t){return 0===t.z||!e.processing}):this.removeFilter("processingFilter")},enableGeneralization:function(){this.options.isGeneralized||(this.options.isGeneralized=!0,this._resetTilesTree())},disableGeneralization:function(){this.options.isGeneralized&&(this.options.isGeneralized=!1,this._resetTilesTree())},_resetTilesTree:function(){this._tilesTree=null,this._needCheckActiveTiles=!0,this._getActiveTileKeys()},updateVersion:function(e,r){if(!t.gmx.skipLoadTiles)if(e&&this.setOptions(e),r){this._needCheckActiveTiles=!1;for(var i,n={},o={},a=0,s=0,l=r.length;l>a;a+=6,s++)i=f.createTileKey({z:Number(r[a]),x:Number(r[a+1]),y:Number(r[a+2]),v:Number(r[a+3]),d:Number(r[a+4]),s:Number(r[a+5])}),n[i]=this._getVectorTile(i,!0),o[i]=!0;this._tiles=n,this.processingTile&&(this._tiles[this.processingTile.vectorTileKey]={tile:this.processingTile}),this._updateActiveTilesList(o)}else this._resetTilesTree()},getNotLoadedVectorTiles:function(e){var t=0;if(e.tiles)for(var r=e.tiles||[],i=0,n=0,o=r.length;o>i;i+=6,n++)this._tiles[f.createTileKey({z:Number(r[i]),x:Number(r[i+1]),y:Number(r[i+2]),v:Number(r[i+3]),d:Number(r[i+4]),s:Number(r[i+5])})]||t++;return t},_getDataKeys:function(e){for(var t={},r=0,i=e.length;i>r;r++)t[e[r][0]]=!0;return t},_getProcessingTile:function(){if(!this.processingTile){var e=-.5,t=-.5,r=0,i=0,n=-1,o=-1,a=this.options.isFlatten;this.processingTile=new f({load:function(e,t,r,i,n,o,a){a([])}},{x:e,y:t,z:r,v:i,s:n,d:o,isFlatten:a}),this.addTile(this.processingTile)}return this.processingTile},addData:function(e){e||(e=[]);var t=this._getProcessingTile(),r=this._getDataKeys(e),i=t.addData(e,r);return this._itemsBounds&&this._itemsBounds.extendBounds(i),this._updateItemsFromTile(t),this._triggerObservers(),t},removeData:function(e){this._itemsBounds=null;var t=this.processingTile;if(t){var r={};if(!e||!e.length)return t;for(var i=0,n=e.length;n>i;i++){var o=e[i];r[o]=!0,delete this._items[o]}this._removeDataFromObservers(r),t.removeData(r,!0),this._updateItemsFromTile(t),this._triggerObservers()}return t},initTilesTree:function(){this._tilesTree=t.gmx.tilesTree(this.options),this.options.TemporalTiles=this.options.TemporalVers=null,"TemporalTiles"in this.optionsLink&&(this.optionsLink.TemporalVers=this.optionsLink.TemporalTiles=null),this.dateZero=this._tilesTree.dateZero,this.processingTile&&(this._tiles[this.processingTile.vectorTileKey]={tile:this.processingTile})},_getVectorTile:function(e,t){if(!this._tiles[e]&&t){var r=f.parseTileKey(e);r.dateZero=this.dateZero,this._addVectorTile(r)}return this._tiles[e]},_addVectorTile:function(e){e.isFlatten=this.options.isFlatten,e.needBbox=this.options.needBbox,e.attributes=this.options.attributes;var t=new f(this._vectorTileDataProvider,e),r=t.vectorTileKey;return this._tiles[r]={tile:t},r},_getGeneralizedTileKeys:function(e){for(var r=e.z%2?1:2,i=Math.pow(2,r),n=e.z-r,o=Math.floor(e.x/i),a=Math.floor(e.y/i),s={v:e.v,s:-1,d:-1,isGeneralized:!0},l={};n>1;){var u=[n,o,a].join("_");l[u]=t.extend({},s,{x:o,y:a,z:n}),n-=2,o=Math.floor(o/4),a=Math.floor(a/4)}return l},initTilesList:function(){var e={};if(this.options.tiles){for(var t,r,i,n,o=this.options.tiles||[],a=this.options.tilesVers,s=this.options.isGeneralized?{}:null,l={},u=0,h=0,c=o.length;c>u;u+=3,h++)if(i={x:Number(o[u]),y:Number(o[u+1]),z:Number(o[u+2]),v:Number(a[h]),s:-1,d:-1},n=this._getVectorTile(f.createTileKey(i),!0),r=n.tile.vectorTileKey,l[r]=n,e[r]=!0,s){var d=this._getGeneralizedTileKeys(i);for(t in d){var m=d[t];s[t]?s[t].v=Math.max(m.v,s[t].v):s[t]=m}}if(s)for(t in s)i=s[t],r=f.createTileKey(i),l[r]||(this._tiles[r]||this._addVectorTile(i),l[r]=this._tiles[r],e[r]=!0);this._tiles=l,this.processingTile&&(this._tiles[this.processingTile.vectorTileKey]={tile:this.processingTile})}this._updateActiveTilesList(e)},setTileFilteringHook:function(e){this._tileFilteringHook=e,this._needCheckActiveTiles=!0,this._getActiveTileKeys()},removeTileFilteringHook:function(){this._tileFilteringHook=null,this._needCheckActiveTiles=!0,this._getActiveTileKeys()}});t.gmx=t.gmx||{},t.gmx.DataManager=g,t.gmx.VectorLayer=t.TileLayer.Canvas.extend({options:{openPopups:[],minZoom:1,zIndexOffset:0,isGeneralized:!0,isFlatten:!1,useWebGL:!1,skipTiles:"None",clickable:!0},initialize:function(e){e=t.setOptions(this,e),this.initPromise=new t.gmx.Deferred,this._drawQueue=[],this._drawQueueHash={},this._drawInProgress={},this._anyDrawings=!1,this.repaintObservers={};var r=this;this._gmx={hostName:i.normalizeHostname(e.hostName||"maps.kosmosnimki.ru"),mapName:e.mapID,skipTiles:e.skipTiles,needBbox:"All"===e.skipTiles,useWebGL:e.useWebGL,srs:e.srs||"",layerID:e.layerID,beginDate:e.beginDate,endDate:e.endDate,sortItems:e.sortItems||null,styles:e.styles||[],tileSubscriptions:{},_tilesToLoad:0,shiftXlayer:0,shiftYlayer:0,renderHooks:[],preRenderHooks:[],_needPopups:{}},e.crossOrigin&&(this._gmx.crossOrigin=e.crossOrigin),this.on("tileunload",function(e){r._clearTileSubscription(e.tile.zKey)})},_removeTile:function(e){var t=this._tiles[e];if(t){var r=t.el;r&&r.parentNode&&r.parentNode.removeChild(r),delete this._tiles[e]}},onAdd:function(e){if(e.options.crs!==t.CRS.EPSG3857&&e.options.crs!==t.CRS.EPSG3395)throw"GeoMixer-Leaflet: map projection is incompatible with GeoMixer layer";var r=this._gmx;r.shiftY=0,r.applyShift=e.options.crs===t.CRS.EPSG3857&&"3857"!==r.srs,r.currentZoom=e.getZoom(),r.styleManager.initStyles(),t.TileLayer.Canvas.prototype.onAdd.call(this,e),e.on("zoomstart",this._zoomStart,this),e.on("zoomend",this._zoomEnd,this),"Vector"===r.properties.type&&e.on("moveend",this._moveEnd,this),this.options.clickable===!1&&(this._container.style.pointerEvents="none"),r.balloonEnable&&!this._popup&&this.bindPopup(""),this.on("stylechange",this._onStyleChange,this),this.on("versionchange",this._onVersionChange,this),t.gmx.layersVersion.add(this),this.fire("add")},onRemove:function(e){this._container&&this._container.parentNode.removeChild(this._container),e.off({viewreset:this._reset,moveend:this._update},this),this._animated&&e.off({zoomanim:this._animateZoom,zoomend:this._endZoomAnim},this),this.options.updateWhenIdle||e.off("move",this._limitedUpdate,this),this._container=null,this._map=null,this._clearAllSubscriptions(),e.off("zoomstart",this._zoomStart,this),e.off("zoomend",this._zoomEnd,this),this.off("stylechange",this._onStyleChange,this);
var r=this._gmx;delete r.map,"Vector"===r.properties.type&&e.off("moveend",this._moveEnd,this),r.dataManager&&!r.dataManager.getActiveObserversCount()&&t.gmx.layersVersion.remove(this),this.fire("remove")},_initContainer:function(){t.TileLayer.Canvas.prototype._initContainer.call(this),this._prpZoomData(),this.setZIndexOffset()},_updateZIndex:function(){if(this._container){var e=this.options,t=e.zIndex||0,r=e.zIndexOffset||0;this._container.style.zIndex=r+t}},_update:function(){return!this._map||this.isExternalVisible&&this.isExternalVisible(this._map._zoom)?(this._clearAllSubscriptions(),void 0):(this._gmx.styleManager.deferred.then(this.__update.bind(this)),void 0)},_addTile:function(e,t){var r=this,n=this._map._zoom,o=this._gmx;if(!o.layerType||!o.styleManager.isVisibleAtZoom(n))return this._tileLoaded(),void 0;if(!o.tileSubscriptions[e]){o._tilesToLoad++;var a=!1,s=i.getTileNumFromLeaflet(t,n),l=function(){a||(o._tilesToLoad--,r._tileLoaded(),a=!0)},u=o.dataManager.getViewFilters("screen",o.layerID),h={type:"resend",layerID:o.layerID,needBbox:o.needBbox,target:"screen",active:!1,bbox:o.styleManager.getStyleBounds(s),filters:["clipFilter","userFilter_"+o.layerID,"styleFilter","userFilter"].concat(u),callback:function(e){r._drawTileAsync(t,n,e).always(l)}};this.options.isGeneralized&&(h.targetZoom=n),"VectorTemporal"===o.layerType&&(h.dateInterval=[o.beginDate,o.endDate]);var c=o.dataManager.addObserver(h,e);c.on("activate",function(){c.isActive()||l()}),c.on("startLoadingTiles",this._chkDrawingState,this),o.tileSubscriptions[e]={z:n,x:t.x,y:t.y,px:256*s.x,py:256*(1+s.y)},c.activate()}},_chkDrawingState:function(){var e=this._gmx,t=this._drawQueue.length>0||Object.keys(this._drawInProgress).length>0;if(!t)for(var r in e.tileSubscriptions){var i=e.dataManager.getObserver(r);if(i&&e.dataManager.getObserverLoadingState(i)){t=!0;break}}!t&&this._anyDrawings?this.fire("doneDraw"):t&&!this._anyDrawings&&this.fire("startDraw"),this._anyDrawings=t},_getLoadedTilesPercentage:function(e){if(!e)return 0;var t=0,r=0,i=["img","canvas"];for(var n in i){var o=e.getElementsByTagName(i[n]);if(o&&o.length>0){t+=o.length;for(var a=0,s=o.length;s>a;a++)o[a]._tileComplete&&r++}}return 1>t?0:r/t},_tileLoaded:function(){this._animated&&t.DomUtil.addClass(this._tileContainer,"leaflet-zoom-animated"),0===this._gmx._tilesToLoad&&(this.fire("load"),this._animated&&this._setClearBgBuffer(0))},_tileOnLoad:function(e){e&&t.DomUtil.addClass(e,"leaflet-tile-loaded"),this._tileLoaded()},_tileOnError:function(){},tileDrawn:function(e){this._tileOnLoad(e)},_tileCoordsToKey:function(e,t){return e.x+":"+e.y+":"+(e.z||t)},_getTiledPixelBounds:function(e){var r=this._map,i=this._gmx,n=new t.Point(i.shiftX,i.shiftY),o=r.project(e,this._tileZoom).add(n)._floor(),a=r.getSize().divideBy(2);return new t.Bounds(o.subtract(a),o.add(a))},_pxBoundsToTileRange:function(e){var r=this.options.tileSize;return new t.Bounds(e.min.divideBy(r)._floor(),e.max.divideBy(r)._round())},initFromDescription:function(e){var r=this._gmx;if(r.properties=e.properties,r.geometry=e.geometry,r.properties._initDone&&delete r.properties[r.properties.Temporal?"TemporalTiles":"tiles"],r.properties._initDone=!0,!r.geometry){var n=i.tileSizes[1];r.geometry={type:"POLYGON",coordinates:[[[-n,-n],[-n,n],[n,n],[n,-n],[-n,-n]]]}}if(r.rawProperties=e.rawProperties||e.properties,this._updateProperties(e.properties),r.srs&&(e.properties.srs=r.srs),e.properties.needBbox=r.needBbox,e.properties.isGeneralized=this.options.isGeneralized,e.properties.isFlatten=this.options.isFlatten,r.dataManager=this.options.dataManager||new g(e.properties),this.options.parentOptions&&(e.properties.styles||(e.properties.styles=this.options.parentOptions.styles),r.dataManager.on("versionchange",this._onVersionChange,this)),r.styleManager=new v(r),this.options.minZoom=r.styleManager.minZoom,this.options.maxZoom=r.styleManager.maxZoom,r.dataManager.on("observeractivate",function(){r.dataManager.getActiveObserversCount()?t.gmx.layersVersion.add(this):t.gmx.layersVersion.remove(this)},this),"Vector"!==r.properties.type||"chkUpdate"in this.options||(this.options.chkUpdate=!0),"Raster"!==r.rawProperties.type&&this._objectsReorderInit&&this._objectsReorderInit(this),r.clusters&&this.bindClusters(JSON.parse(r.clusters)),r.filter){var o=t.gmx.Parsers.parseSQL(r.filter.replace(/[\[\]]/g,'"'));o&&r.dataManager.addFilter("userFilter_"+r.layerID,function(e){return r.layerID!==this._gmx.layerID||!o||o(e.properties,r.tileAttributeIndexes,r.tileAttributeTypes)?e.properties:null}.bind(this))}return r.dateBegin&&r.dateEnd&&this.setDateInterval(r.dateBegin,r.dateEnd),this.initPromise.resolve(),this},getDataManager:function(){return this._gmx.dataManager},enableGeneralization:function(){this.options.isGeneralized||(this.options.isGeneralized=!0,this._gmx.dataManager&&(this._clearAllSubscriptions(),this._gmx.dataManager.enableGeneralization(),this.redraw()))},disableGeneralization:function(){this.options.isGeneralized&&(this.options.isGeneralized=!1,this._gmx.dataManager&&(this._clearAllSubscriptions(),this._gmx.dataManager.disableGeneralization(),this.redraw()))},setRasterOpacity:function(e){var t=this;return this._gmx.rasterOpacity!==e&&(this._gmx.rasterOpacity=e,this.initPromise.then(function(){t.repaint()})),this},getStyles:function(){return this._gmx.styleManager.getStyles()},getIcons:function(e){return this._gmx.styleManager.getIcons(e),this},setStyles:function(e){var t=this;return this.initPromise.then(function(){t._gmx.styleManager.clearStyles(),e?e.forEach(function(e,r){t.setStyle(e,r,!0)}):t.fire("stylechange")}),this},getStyle:function(e){return this.getStyles()[e]},setStyle:function(e,t,r){var i=this,n=this._gmx;return this.initPromise.then(function(){n.styleManager.setStyle(e,t,r).then(function(){i.fire("stylechange",{num:t||0})})}),this},setStyleHook:function(e){return this._gmx.styleHook=e,this.repaint(),this},removeStyleHook:function(){return this._gmx.styleHook=null,this},setRasterHook:function(e){return this._gmx.rasterProcessingHook=e,this.repaint(),this},removeRasterHook:function(){return this._gmx.rasterProcessingHook=null,this.repaint(),this},setFilter:function(e){var t=this._gmx;return t.dataManager.addFilter("userFilter",function(r){return t.layerID!==this._gmx.layerID||!e||e(r)?r.properties:null}.bind(this)),this},removeFilter:function(){return this._gmx.dataManager.removeFilter("userFilter"),this},addLayerFilter:function(e,t){var r=this._gmx;return t=t||{},t.layerID=r.layerID,r.dataManager.addLayerFilter(function(t){return!e||e(t)?t.properties:null}.bind(this),t),this},removeLayerFilter:function(e){return e=e||{},e.layerID=this._gmx.layerID,this._gmx.dataManager.removeLayerFilter(e),this},setDateInterval:function(e,r){var i=this._gmx;if(i.dateBegin&&i.dateEnd&&(e=i.dateBegin,r=i.dateEnd),!i.beginDate!=!e||!i.endDate!=!r||e&&i.beginDate.valueOf()!==e.valueOf()||r&&i.endDate.valueOf()!==r.valueOf()){if(i.rawProperties.maxShownPeriod&&e){var n=1e3*3600*24*i.rawProperties.maxShownPeriod;e=new Date(Math.max(e.valueOf(),r.valueOf()-n))}i.beginDate=e,i.endDate=r;var o=null,a=i.dataManager;for(var s in i.tileSubscriptions)o=a.getObserver(s),o.setDateInterval(e,r);o=a.getObserver("_Labels"),o&&o.setDateInterval(e,r),("NotVisible"===i.skipTiles||i.needBbox||i.properties.UseTiles===!1)&&(i.properties.LayerVersion=-1,a.setOptions({LayerVersion:-1}),this._map&&t.gmx.layersVersion.now()),this.fire("dateIntervalChanged")}return this},getDateInterval:function(){return{beginDate:this._gmx.beginDate,endDate:this._gmx.endDate}},addObserver:function(e){return this._gmx.dataManager.addObserver(e)},removeObserver:function(e){return this._gmx.dataManager.removeObserver(e.id)},setPositionOffset:function(e,t){var r=this._gmx;return r.shiftXlayer=e,r.shiftYlayer=t,this._update(),this},getPositionOffset:function(){var e=this._gmx;return{shiftX:e.shiftXlayer,shiftY:e.shiftYlayer}},setZIndexOffset:function(e){return arguments.length&&(this.options.zIndexOffset=e),this._updateZIndex(),this},repaint:function(e){if(this._map){if(!e){e={};for(var r in this._gmx.tileSubscriptions)e[r]=!0;t.extend(e,this.repaintObservers)}this._gmx.dataManager._triggerObservers(e)}},redrawItem:function(e){if(this._map){var t=this._gmx.dataManager.getItem(e),r=this._getTilesByBounds(t.bounds);this.repaint(r)}},gmxGetCanvasTile:function(e){var t=this._tileCoordsToKey(e);if(t in this._tiles)return this._tiles[t];var r=this._getTile();return this._tiles[t]={el:r,coords:e,current:!0},r._zoom=this._map._zoom,r._tileComplete=!0,r._tilePoint=e,this.tileDrawn(r),this._tiles[t]},appendTileToContainer:function(e){this._tileContainer.appendChild(e);var r=this._getTilePos(e._tilePoint);t.DomUtil.setPosition(e,r,t.Browser.chrome||t.Browser.android23)},addData:function(e,t){return this._gmx.mapName||(this._gmx.dataManager.addData(e,t),this.repaint()),this},removeData:function(e,t){return this._gmx.mapName||(this._gmx.dataManager.removeData(e,t),this.repaint()),this},getStylesByProperties:function(e,t){return this._gmx.styleManager.getCurrentFilters(e,t)},getItemStyle:function(e){var t=this._gmx,r=t.dataManager.getItem(e);return t.styleManager.getObjStyle(r)},getTileAttributeTypes:function(){return this._gmx.tileAttributeTypes},getTileAttributeIndexes:function(){return this._gmx.tileAttributeIndexes},getItemBalloon:function(e){var r=this._gmx,i=r.dataManager.getItem(e),n=this.getStyles(),o="";if(i&&n[i.currentFilter]){var a=i.properties;o=t.gmxUtil.parseBalloonTemplate(n[i.currentFilter].Balloon,{properties:this.getItemProperties(a),geometries:[a[a.length-1]],tileAttributeTypes:r.tileAttributeTypes,unitOptions:this._map?this._map.options:{}})}return o},getItemProperties:function(e){var t={},r=this._gmx.tileAttributeIndexes;for(var i in r)t[i]=e[r[i]];return t},addPreRenderHook:function(e){this._gmx.preRenderHooks.push(e),this.repaint()},removePreRenderHook:function(e){for(var t=this._gmx.preRenderHooks,r=0,i=t.length;i>r;r++)if(t[r]===e){t.splice(r,1),this.repaint();break}},addRenderHook:function(e){this._gmx.renderHooks.push(e),this.repaint()},removeRenderHook:function(e){for(var t=this._gmx.renderHooks,r=0,i=t.length;i>r;r++)if(t[r]===e){t.splice(r,1),this.repaint();break}},getGmxProperties:function(){return this._gmx.rawProperties},getBounds:function(){var e=t.Projection.Mercator,r=this._gmx.layerID?i.geoItemBounds(this._gmx.geometry).bounds:this._gmx.dataManager.getItemsBounds();return r?t.latLngBounds([e.unproject(r.min),e.unproject(r.max)]):new t.LatLngBounds},getGeometry:function(){return this._gmx.latLngGeometry||(this._gmx.latLngGeometry=t.gmxUtil.geometryToGeoJSON(this._gmx.geometry,!0)),this._gmx.latLngGeometry},_clearTileSubscription:function(e){var t=this._gmx;if(e in t.tileSubscriptions){var r=t.tileSubscriptions[e];r.screenTile&&r.screenTile.destructor();var i=t.dataManager.getObserver(e);i&&i.deactivate(),delete t.tileSubscriptions[e],this._removeTile(e),this._anyDrawings&&this._chkDrawingState()}e in this._drawQueueHash&&this._drawQueueHash[e].cancel()},_clearAllSubscriptions:function(){for(;this._drawQueue.length;)this._drawQueue[0].def.cancel();var e=this._gmx;for(var t in e.tileSubscriptions){var r=e.tileSubscriptions[t];r.screenTile&&r.screenTile.destructor();var i=e.dataManager.getObserver(t);i&&i.deactivate(),e.dataManager.removeObserver(t),delete e.tileSubscriptions[t],delete this._tiles[t]}this._anyDrawings&&this._chkDrawingState(),e._tilesToLoad=0},_zoomStart:function(){this._gmx.zoomstart=!0},_zoomEnd:function(){this._gmx.zoomstart=!1,this.setCurrentZoom(this._map)},_moveEnd:function(){"dataManager"in this._gmx&&this._gmx.dataManager.fire("moveend")},_onStyleChange:function(){var e=this._gmx;if(!e.balloonEnable&&this._popup?this.unbindPopup():e.balloonEnable&&!this._popup&&this.bindPopup(""),this._map)if((this.options.minZoom!==e.styleManager.minZoom||this.options.maxZoom!==e.styleManager.maxZoom)&&(this.options.minZoom=e.styleManager.minZoom,this.options.maxZoom=e.styleManager.maxZoom,this._map._updateZoomLevels()),e.labelsLayer?this._map._labelsLayer.add(this):e.labelsLayer||this._map._labelsLayer.remove(this),Object.keys(e.tileSubscriptions).length>0)for(var r in e.tileSubscriptions){var n=e.dataManager.getObserver(r),o=e.tileSubscriptions[r],a=i.getTileNumFromLeaflet(o,o.z),s=e.styleManager.getStyleBounds(a);if(!n.bbox.isEqual(s)){var l=t.Projection.Mercator;n.setBounds(t.latLngBounds([l.unproject(s.min),l.unproject(s.max)]))}}else this.redraw()},_removeInProgressDrawing:function(e){delete this._drawInProgress[e],this._chkDrawingState()},_drawTileAsync:function(e,r,n){var o=this._drawQueue,a=0===o.length,s=this._tileCoordsToKey(e,r),l=this;this._drawQueueHash[s]&&this._drawQueueHash[s].cancel();var u=function(){if(l._chkDrawingState(),o.length){var e=o.shift();delete l._drawQueueHash[e.zKey],l._map&&e.z===l._map._zoom?(e.drawDef=l._gmxDrawTile(e.tp,e.z,e.data),l._drawInProgress[e.zKey]=!0,e.drawDef.always(l._removeInProgressDrawing.bind(l,e.zKey)),e.drawDef.then(e.def.resolve.bind(e.def,e.data),e.def.reject)):e.def.reject(),setTimeout(u,0)}},h=i.getTileNumFromLeaflet(e,r),c={gtp:h,tp:e,z:r,zKey:s,data:n},d=c.def=new t.gmx.Deferred(function(){c.drawDef&&c.drawDef.cancel(),l._removeInProgressDrawing(s),delete l._drawQueueHash[s];for(var e=o.length-1;e>=0;e--){var t=o[e];if(t.zKey===s){o.splice(e,1);break}}});return o.push(c),this._drawQueueHash[s]=d,a&&setTimeout(u,0),d},_updateShiftY:function(){var e=this._gmx,r=this._map,i=0;if(e.applyShift&&r){var n=r.getCenter();i=r.options.crs.project(n).y-t.Projection.Mercator.project(n).y}e.shiftX=Math.floor(e.mInPixel*(e.shiftXlayer||0)),e.shiftY=Math.floor(e.mInPixel*(i+(e.shiftYlayer||0))),e.shiftPoint=new t.Point(e.shiftX,-e.shiftY),t.DomUtil.setPosition(this._tileContainer,e.shiftPoint)},_prpZoomData:function(){this.setCurrentZoom(this._map)},setCurrentZoom:function(e){var t=this._gmx;t.currentZoom=e._zoom,t.tileSize=i.tileSizes[t.currentZoom],t.mInPixel=256/t.tileSize},_setClearBgBuffer:function(e){this._clearBgBufferTimer&&clearTimeout(this._clearBgBufferTimer);var t=this;this._clearBgBufferTimer=setTimeout(function(){t._bgBuffer&&t._clearBgBuffer()},e||0)},_getNeedPopups:function(){for(var e={},t=this.options.openPopups,r=0,i=t.length;i>r;r++)e[t[r]]=!1;return e},__update:function(){var e=this._map;if(e){var r=e.getZoom(),i=e.getCenter();this._updateShiftY(),this._tileZoom=r,this.options.openPopups.length&&(this._gmx._needPopups=this._getNeedPopups(),this.options.openPopups=[]);var n=this._getTiledPixelBounds(i),o=this._pxBoundsToTileRange(n),a=this._getWrapTileNum();if(o.min.y<0&&(o.min.y=0),o.max.y>=a.y&&(o.max.y=a.y-1),this._chkTileSubscriptions(r,o),r>this.options.maxZoom||r<this.options.minZoom)return this._setClearBgBuffer(500),void 0;for(var s=o.min.y,l=o.max.y;l>=s;s++)for(var u=o.min.x,h=o.max.x;h>=u;u++){var c=new t.Point(u,s);c.z=this._tileZoom;var d=this._tileCoordsToKey(c);this._tiles[d]||this._addTile(d,c)}}},_chkTileSubscriptions:function(e,t){var r=this._gmx,i=t.min,n=t.max;for(var o in r.tileSubscriptions){var a=r.tileSubscriptions[o];(a.z!==e||a.x<i.x||a.x>n.x||a.y<i.y||a.y>n.y)&&this._clearTileSubscription(o)}},_getScreenTile:function(t,r){var i=this._gmx,n=this._tileCoordsToKey(t,r),o=i.tileSubscriptions[n],a=null;return o&&(o.screenTile?a=o.screenTile:o.screenTile=a=new e(this,t,r)),a},_gmxDrawTile:function(e,r,i){var n=this._gmx,o=!1,a=null,s=new t.gmx.Deferred(function(){o=!0,a&&a.cancel()});if(!this._map)return s.reject(),s;var l=this._getScreenTile(e,r||this._map._zoom);return l&&n.styleManager.deferred.then(function(){o||(a=l.drawTile(i),a.then(s.resolve.bind(s,i),s.reject))}),s},_getTilesByBounds:function(e){var r=this._gmx,i=this._map._zoom,n=r.shiftX||0,o=r.shiftY||0,a=t.Projection.Mercator.unproject(new t.Point(e.min.x,e.min.y)),s=t.Projection.Mercator.unproject(new t.Point(e.max.x,e.max.y)),l=this._map.getBounds(),u=l.getSouthWest(),h=l.getNorthEast(),c=0;h.lng-u.lng<360&&(s.lng<u.lng?c=360*(1+Math.floor((u.lng-s.lng)/360)):a.lng>h.lng&&(c=360*Math.floor((h.lng-a.lng)/360))),a.lng+=c,s.lng+=c;var d,f,m,p,g=this._map.getPixelBounds(),v=this._map.project(a),y=this._map.project(s);g?(d=Math.floor((Math.max(y.y,g.min.y)+o)/256),f=Math.floor((Math.min(v.y,g.max.y)+o)/256),m=a.lng<=-180?g.min.x:Math.max(v.x,g.min.x),m=Math.floor((m+n)/256),p=s.lng>=180?g.max.x:Math.min(y.x,g.max.x),p=Math.floor((p+n)/256)):(d=Math.floor((y.y+o)/256),f=Math.floor((v.y+o)/256),m=Math.floor((v.x+n)/256),p=Math.floor((y.x+n)/256));for(var x={},_=m;p>=_;_++)for(var b=d;f>=b;b++){var P=this._tileCoordsToKey({x:_,y:b},i);x[P]=!0}return x},_updateProperties:function(e){var r=this._gmx,i=this.options.apikeyRequestHost||r.hostName;r.sessionKey=e.sessionKey=this.options.sessionKey||l.getSessionKey(i),this.options.parentOptions&&(e=this.options.parentOptions),r.identityField=e.identityField,r.GeometryType=(e.GeometryType||"").toLowerCase(),r.minZoomRasters=e.RCMinZoomForRasters||1,r.minZoomQuicklooks=r.minZoomRasters;var n=e.type||"Vector";if(e.Temporal&&(n+="Temporal"),r.layerType=n,r.items={},t.extend(r,t.gmxUtil.getTileAttributes(e)),r.dataManager&&r.dataManager.setOptions(e),"ZIndexField"in e&&e.ZIndexField in r.tileAttributeIndexes&&(r.zIndexField=r.tileAttributeIndexes[e.ZIndexField]),this._objectsReorder&&this._objectsReorder.initialize(),r.filter=e.filter,r.dateBegin=e.dateBegin,r.dateEnd=e.dateEnd,r.dataSource=e.dataSource,"MetaProperties"in r.rawProperties){var o=r.rawProperties.MetaProperties;"srs"in o&&(r.srs=o.srs.Value||""),"parentLayer"in o&&(r.dataSource=o.parentLayer.Value||""),"filter"in o&&(r.filter=o.filter.Value||""),"dateBegin"in o&&(r.dateBegin=t.gmxUtil.getDateFromStr(o.dateBegin.Value||"01.01.1980")),"dateEnd"in o&&(r.dateEnd=t.gmxUtil.getDateFromStr(o.dateEnd.Value||"01.01.1980")),("shiftX"in o||"shiftY"in o)&&(r.shiftXlayer=o.shiftX?Number(o.shiftX.Value):0,r.shiftYlayer=o.shiftY?Number(o.shiftY.Value):0),("shiftXfield"in o||"shiftYfield"in o)&&(o.shiftXfield&&(r.shiftXfield=o.shiftXfield.Value),o.shiftYfield&&(r.shiftYfield=o.shiftYfield.Value)),"quicklookPlatform"in o&&(r.quicklookPlatform=o.quicklookPlatform.Value,"image"===r.quicklookPlatform&&delete r.quicklookPlatform),"quicklookX1"in o&&(r.quicklookX1=o.quicklookX1.Value),"quicklookY1"in o&&(r.quicklookY1=o.quicklookY1.Value),"quicklookX2"in o&&(r.quicklookX2=o.quicklookX2.Value),"quicklookY2"in o&&(r.quicklookY2=o.quicklookY2.Value),"quicklookX3"in o&&(r.quicklookX3=o.quicklookX3.Value),"quicklookY3"in o&&(r.quicklookY3=o.quicklookY3.Value),"quicklookX4"in o&&(r.quicklookX4=o.quicklookX4.Value),"quicklookY4"in o&&(r.quicklookY4=o.quicklookY4.Value),"multiFilters"in o&&(r.multiFilters="1"===o.multiFilters.Value?!0:!1),"isGeneralized"in o&&(this.options.isGeneralized="false"!==o.isGeneralized.Value),"isFlatten"in o&&(this.options.isFlatten="false"!==o.isFlatten.Value)}if(e.Temporal&&(this.options.isGeneralized=!1),e.IsRasterCatalog){r.IsRasterCatalog=e.IsRasterCatalog;var a=r.tileAttributeIndexes.GMX_RasterCatalogID;a&&(r.rasterBGfunc=function(e,i,n,o){var s=o.properties,l=t.gmxUtil.protocol+"//"+r.hostName+"/TileSender.ashx?ModeKey=tile"+"&x="+e+"&y="+i+"&z="+n;return r.srs&&(l+="&srs="+r.srs),r.crossOrigin&&(l+="&cross="+r.crossOrigin),l+="&LayerName="+s[a],r.sessionKey&&(l+="&key="+encodeURIComponent(r.sessionKey)),l})}if(e.Quicklook){var s;s="{"===e.Quicklook[0]?JSON.parse(e.Quicklook):{minZoom:r.minZoomRasters,template:e.Quicklook},"X1"in s&&(r.quicklookX1=s.X1),"Y1"in s&&(r.quicklookY1=s.Y1),"X2"in s&&(r.quicklookX2=s.X2),"Y2"in s&&(r.quicklookY2=s.Y2),"X3"in s&&(r.quicklookX3=s.X3),"Y3"in s&&(r.quicklookY3=s.Y3),"X4"in s&&(r.quicklookX4=s.X4),"Y4"in s&&(r.quicklookY4=s.Y4);var u=r.Quicklook=s.template;"minZoom"in s&&(r.minZoomQuicklooks=s.minZoom),r.quicklookBGfunc=function(e){for(var t=u,i=/\[([^\]]+)\]/,n=i.exec(t);n&&n.length>1;)t=t.replace(n[0],e.properties[r.tileAttributeIndexes[n[1]]]),n=i.exec(t);return r.srs&&(t+=(-1===t.indexOf("?")?"?":"&")+"srs="+r.srs),t},r.imageQuicklookProcessingHook=t.gmx.gmxImageTransform}this.options.attribution=e.Copyright||""},_onVersionChange:function(){this._updateProperties(this._gmx.rawProperties)},getViewRasters:function(){var e=this._gmx,t={},r=[];for(var i in e.tileSubscriptions){var n=e.tileSubscriptions[i],o=n.screenTile;o&&o.itemsView.forEach(function(e){t[e.id]=!0})}for(var a in t)r.push(a);return r},getPropItem:function(e,t){return i.getPropItem(e,t,this._gmx.tileAttributeIndexes)}}),t.Map.addInitHook(function(){t.Mixin.ContextMenu&&t.gmx.VectorLayer.include(t.Mixin.ContextMenu)}),e.prototype={_loadTileRecursive:function(e,r){var i,n=this.gmx,o=this,a=null,s=new t.gmx.Deferred(function(){a&&(delete o.rasterRequests[i],a.cancel())}),l=function(e,u){var h=r(e),c=function(){e.z>1?l({x:Math.floor(e.x/2),y:Math.floor(e.y/2),z:e.z-1},""):s.reject()};if(n.badTiles[h]||n.maxNativeZoom&&n.maxNativeZoom<e.z)return c(),void 0;var d=o.rasterRequests[h];d?d.options.tileRastersId=o._uniqueID:(n.rasterProcessingHook&&(u="anonymous"),d=t.gmx.imageLoader.push(h,{tileRastersId:o._uniqueID,zoom:o.zoom,cache:!0,crossOrigin:n.crossOrigin||u||""}),o.rasterRequests[h]=d),i=h,a=d.def,a.then(function(t){s.resolve({gtp:e,image:t})},function(){n.badTiles[h]=!0,c()})};return l(e),s},_rasterHook:function(e){var t=e.sourceTilePoint||e.destinationTilePoint,r={geoItem:e.geoItem,destination:{z:e.destinationTilePoint.z,x:e.destinationTilePoint.x,y:e.destinationTilePoint.y},source:{z:t.z,x:t.x,y:t.y}};return e.url&&(r.quicklook=e.url),(this.gmx.rasterProcessingHook||this._defaultRasterHook)(e.res,e.image,e.sx||0,e.sy||0,e.sw||256,e.sh||256,e.dx||0,e.dy||0,e.dw||256,e.dh||256,r)},_defaultRasterHook:function(e,t,r,i,n,o,a,s,l,u){var h=e.getContext("2d");h.drawImage(t,r,i,n,o,a,s,l,u)},_getShiftPixels:function(e){var t=e.dx+(e.dx<0?256:0),r=e.dy+(e.dy<0?256:0),i=0,n=256-t,o=t,a=n;if(e.tx>e.x&&(i=n,n=t,o=0,a=n),256===i||1>n)return null;var s=r,l=256-r,u=0,h=l;return e.ty>e.y&&(s=0,u=l,l=r,h=l),256===s||1>l?null:{sx:i,sy:s,sw:n,sh:l,dx:o,dy:u,dw:a,dh:h}},_getShiftTilesArray:function(e,t,r){var i=this.gmx.mInPixel,n=this.gmxTilePoint,o=t*i,a=r*i,s=Math.floor(.5+o%256),l=Math.floor(.5+a%256),u=256/i,h=n.x-t/u,c=n.y-r/u,d=Math.floor(h),f=d+(h===d?0:1),m=Math.floor(c),p=m+(c===m?0:1),g=Math.floor((e.min.x-t)/u),v=Math.floor((e.max.x-t)/u),y=Math.floor((e.min.y-r)/u),x=Math.floor((e.max.y-r)/u);g>d&&(d=g),f>v&&(f=v),y>m&&(m=y),p>x&&(p=x);for(var _=[],b=m;p>=b;b++)for(var P=d;f>=P;P++)_.push({z:n.z,x:P,y:b,dx:s,dy:l,tx:h,ty:c});return _},_getItemRasters:function(e){var r,n=e.properties,o=n[0],a=this,s=this.gmx,l=s.tileAttributeIndexes,u=this.rasters,h=null,c=Number(s.shiftXfield?i.getPropItem(s.shiftXfield,n,l):0)%this.worldWidthMerc,d=Number(s.shiftYfield?i.getPropItem(s.shiftYfield,n,l):0),f=c||d,m=i.getPropItem("urlBG",n,l),p="",g=null,v=!1,y=s.dataManager.getItem(o),x=this.gmxTilePoint,_=null,b=null;if(s.IsRasterCatalog&&("Raster"===s.rawProperties.type||i.getPropItem("GMX_RasterCatalogID",n,l))?v=!0:s.quicklookBGfunc?(p=s.quicklookBGfunc(y),g=s.imageQuicklookProcessingHook):m&&(p=m,g=s.imageQuicklookProcessingHook),v)h=new t.gmx.Deferred(function(){r.forEach(function(e){e.cancel()}),r=null});else{p+=(-1===p.indexOf("?")?"?":"&")+s.sessionKey;var P=this.rasterRequests[p];P?P.options.tileRastersId=this._uniqueID:(P=t.gmx.imageLoader.push(p,{tileRastersId:a._uniqueID,crossOrigin:s.crossOrigin||"anonymous"}),this.rasterRequests[p]=P),h=new t.gmx.Deferred(function(){delete a.rasterRequests[p],P.def.cancel()}),P.def.then(h.resolve,h.reject)}var T=new t.gmx.Deferred(function(){h&&(h.cancel(),h=null)});if(v){var S=e.dataOption||{},I=f?this._getShiftTilesArray(S.bounds,c,d):[x],M=I.length,L=function(){1>M&&h.resolve()},k=function(){M--,L()},C=function(e){return s.rasterBGfunc(e.x,e.y,e.z,y)},D=function(r,n,o){y.skipRasters=!1;var l=!0;g&&(o=g(o,{gmx:s,geoItem:e,item:y,gmxTilePoint:r}),l=!1);var u={geoItem:e,image:o,destinationTilePoint:x,sourceTilePoint:r,sx:0,sy:0,sw:256,sh:256,dx:0,dy:0,dw:256,dh:256};if(f){var h=a._getShiftPixels(n);if(null===h)return k(),void 0;t.extend(u,h),l=!1}if(r.z!==x.z){var c=i.getTilePosZoomDelta(x,x.z,r.z);if(c.size<1/256)return L(),void 0;if(l=!1,u.sx=Math.floor(c.x),u.sy=Math.floor(c.y),u.sw=u.sh=c.size,f){var d=Math.floor(u.dw/c.zDelta);u.sx=(0===u.dx?u.sw:256)-d,u.sw=d;var m=Math.floor(u.dh/c.zDelta);u.sy=(0===u.dy?u.sh:256)-m,u.sh=m}}if(l&&!s.rasterProcessingHook)M--,_=o,L();else{_||(_=document.createElement("canvas"),_.width=_.height=256),u.res=_;var p=a._rasterHook(u),v=function(){M--,n.resImage=_,L()};p?p instanceof t.gmx.Deferred&&p.then(v):null===p?(y.skipRasters=!0,k()):v()}};r=I.map(function(e){var t=a._loadTileRecursive(e,C);return t.then(function(t){D(t.gtp,e,t.image)},k),t}),h.then(function(){u[o]=_,T.resolve()})}else{y.skipRasters=!1;var O=function(r){var i={gmx:s,geoItem:e,item:y,gmxTilePoint:x};_||(_=document.createElement("canvas"),_.width=_.height=256);var n=function(r){var n=a._rasterHook({geoItem:e,res:_,image:g?g(r,i):r,destinationTilePoint:x,url:p}),s=function(){u[o]=_,T.resolve()};n?n instanceof t.gmx.Deferred&&n.then(s):null===n?(y.skipRasters=!0,T.resolve()):s()};n(r),delete a.rasterRequests[p]};b?O(b):h.then(O.bind(this),T.resolve)}return T.always(function(){h=null,r&&(r=null)}),T},_getVisibleItems:function(e){if(e.length<2)return this.itemsView=e,e;i._tileCanvas||(i._tileCanvas=document.createElement("canvas"),i._tileCanvas.width=i._tileCanvas.height=256);var r,n,o=this.gmx,a=o.dataManager,s=i._tileCanvas,l=s.getContext("2d"),u={tbounds:this.tbounds,gmx:o,tpx:this.tpx,tpy:this.tpy,ctx:l};for(l.clearRect(0,0,256,256),l.imageSmoothingEnabled=!1,r=0,n=e.length;n>r;r++){l.fillStyle=i.dec2rgba(r+1,1);var h=e[r];t.gmxUtil.drawGeoItem(h,a.getItem(h.properties[0]),u,{fillStyle:l.fillStyle})}var c={},d=l.getImageData(0,0,256,256).data;for(r=0,n=d.length;n>r;r+=4)if(255===d[r+3]){var f=d[r+2];d[r+1]&&(f+=d[r+1]<<8),d[r]&&(f+=d[r]<<16),f&&(c[f]=!0)}var m=[];for(var p in c){var g=e[Number(p)-1];g&&m.push(g)}return this.itemsView=m,m},_getNeedRasterItems:function(e){for(var t=this.gmx,r=t.tileAttributeIndexes,n=this.tbounds,o=[],a=0,s=e.length;s>a;a++){var l=e[a],u=l.properties,h=u[0],c=l.dataOption||{},d=!1;if(t.quicklookBGfunc&&!i.getPropItem("GMX_RasterCatalogID",u,r)){if(t.minZoomQuicklooks&&this.zoom<t.minZoomQuicklooks)continue;var f=i.getPropItem(t.quicklookPlatform,u,r)||t.quicklookPlatform||"";if(!(f&&"imageMercator"!==f||i.getQuicklookPointsFromProperties(u,t)))continue}t.styleHook&&(l.styleExtend=t.styleHook(t.dataManager.getItem(h),t.lastHover&&h===t.lastHover.id),d=l.styleExtend&&l.styleExtend.skipRasters),!d&&n.intersectsWithDelta(c.bounds,-1,-1)&&o.push(l)}return this._getVisibleItems(o)},_getTileRasters:function(e){var r=[],i=new t.gmx.Deferred(function(){r.forEach(function(e){e.cancel()}),r=null}),n=this._getNeedRasterItems(e),o=n.length;if(o){var a=this,s=function(){1>o&&i.resolve()};n.forEach(function(e){var t=a._getItemRasters(e);t.then(function(){o--,s()}),r.push(t)})}else i.resolve();return i},_chkItems:function(e){var t=this.layer;if(!t._map)return null;var r=e&&e.added&&e.added.length?e.added:null;if(!r){var i=t._tiles[this.zKey];return i&&i.el&&i.el.getContext("2d").clearRect(0,0,256,256),null}return this.gmx.sortItems?t.getSortedItems(r):r},_cancelRastersPromise:function(){this.rastersPromise&&(this.rastersPromise.cancel(),this.rastersPromise=null)},drawTile:function(e){var r=this.currentDrawPromise,i=this;this._uniqueID++,r&&(this._cancelRastersPromise(),this._preRenderPromise&&this._preRenderPromise.cancel(),this._renderPromise&&this._renderPromise.cancel(),r.reject()),r=new t.gmx.Deferred(this._cancelRastersPromise.bind(this)),r.always(function(){i._drawDone(),i.currentDrawPromise=null,i.rastersPromise=null,i._preRenderPromise=null,i._renderPromise=null}),this.currentDrawPromise=r;var n=this._chkItems(e);if(!n)return r.resolve(),r;var o=this.layer.gmxGetCanvasTile(this.tilePoint),a=o.el,s=a.getContext("2d"),l=this.gmx,u={tbounds:this.tbounds,rasters:this.rasters,gmx:l,tpx:this.tpx,tpy:this.tpy,ctx:s};a.zKey=o.el._zKey=this.zKey;var h=function(){s.clearRect(0,0,256,256);var e={tpx:i.tpx,tpy:i.tpy,x:i.tilePoint.x,y:i.tilePoint.y,z:i.zoom},o=null;i._preRenderPromise=new t.gmx.Deferred,i._preRenderPromise.resolve(o),l.preRenderHooks.forEach(function(t){i._preRenderPromise=i._preRenderPromise.then(function(r){return o=r||o,o||(o=document.createElement("canvas"),o.width=o.height=256),t(o,e)})}),i._preRenderPromise.then(function(s){o=s||o,o&&(u.bgImage=o);for(var h=0,c=n.length;c>h;h++){var d=n[h],f=d.id,m=l.dataManager.getItem(f);if(m){var p=l.styleManager.getObjStyle(m),g=l.lastHover&&l.lastHover.id===d.id&&p;if(l.multiFilters)for(var v=0,y=m.multiFilters.length;y>v;v++){var x=m.multiFilters[v];t.gmxUtil.drawGeoItem(d,m,u,g?x.parsedStyleHover:x.parsedStyle,x.style)}else t.gmxUtil.drawGeoItem(d,m,u,g?m.parsedStyleHover:m.parsedStyleKeys,p);f in l._needPopups&&!l._needPopups[f]&&(l._needPopups[f]=!0)}}i.rasters={},i.layer._map&&!a.parentNode&&i.layer.appendTileToContainer(a),i._renderPromise=new t.gmx.Deferred,i._renderPromise.resolve(a),l.renderHooks.forEach(function(t){i._renderPromise=i._renderPromise.then(function(r){return a=r||a,t(a,e)})}),i._renderPromise.then(r.resolve,r.reject)},r.reject)};return this.showRaster?(this.rastersPromise=this._getTileRasters(n),this.rastersPromise.then(h,r.reject)):h(),r},destructor:function(){this._cancelRastersPromise(),this._clearCache(),this.currentDrawPromise&&this.currentDrawPromise.reject()},_drawDone:function(){for(var e in this.rasterRequests){var t=this.rasterRequests[e];this._uniqueID!==t.options.tileRastersId&&(t.remove(),delete this.rasterRequests[e])}},_clearCache:function(){for(var e in this.rasterRequests)this.rasterRequests[e].remove();this.rasterRequests={}}},function(){var e=1e6,r=function(e){this.all={},this.userSetSortFunc=!1,this.sortFunc=null,this.count=0,this.disabled=!1,this.layer=e,e.on("add",this.onAdd,this),e.on("remove",this.onRemove,this)};r.prototype={addToReorder:function(e,t){++this.count,this.all[e]=t?-this.count:this.count},clickFunc:function(e){if(!this.disabled){var t=e.gmx.id;this.addToReorder(t,e.originalEvent.ctrlKey),this.layer.redrawItem(t)}},sortItems:function(t,r){var i=this._objectsReorder;if(i.count>0){var n=i.all[t.id],o=i.all[r.id];if(n||o)return n=n?n+(n>0?e:-e):0,o=o?o+(o>0?e:-e):0,n-o}return i.sortFunc?i.sortFunc.call(this,t,r):0},resetSortFunc:function(){var e=this.layer,t=e._gmx,r=t.zIndexField;t.sortItems=this.sortItems,this.sortFunc=r&&!this.userSetSortFunc?function(e,t){var i=Number(e.properties[r])-Number(t.properties[r]);return i?i:e.id-t.id}:function(e,t){return e.id-t.id}},initialize:function(){var e=this.layer._gmx;this.userSetSortFunc||"polygon"!==e.GeometryType&&"linestring"!==e.GeometryType||this.resetSortFunc()},onAdd:function(){this.initialize(),this.layer.on("click",this.clickFunc,this)},onRemove:function(){this.layer.off("click",this.clickFunc,this)}},t.gmx.VectorLayer.include({_objectsReorder:null,_objectsReorderInit:function(){this._objectsReorder||(this._objectsReorder=new r(this))},getReorderArrays:function(){var e={top:[],bottom:[]};if(this._objectsReorder)for(var t=this._objectsReorder,r=Object.keys(t.all).sort(function(e,r){return t.all[e]-t.all[r]}),i=0,n=r.length;n>i;i++){var o=r[i];t.all[o]>0?e.top.push(o):e.bottom.push(o)}return e},bringToTopItem:function(e){return this._objectsReorderInit(),this._objectsReorder.addToReorder(e),this.redrawItem(e),this},bringToBottomItem:function(e){return this._objectsReorderInit(),this._objectsReorder.addToReorder(e,!0),this.redrawItem(e),this},clearReorderArrays:function(){if(this._objectsReorder){var e=this._objectsReorder;e.all={},e.count=0,this.repaint()}return this},setReorderArrays:function(e,t){this._objectsReorderInit();var r=this._objectsReorder;return r.all={},r.count=0,t&&t.forEach(function(e){r.addToReorder(e,!0)}),e&&e.forEach(function(e){r.addToReorder(e)}),this.repaint(),this},getSortedItems:function(e){return this._objectsReorderInit(),e.sort(t.bind(this._objectsReorder.count>0?this._gmx.sortItems:this._objectsReorder.sortFunc,this))
},setSortFunc:function(e){this._objectsReorderInit();var t=this._objectsReorder;return t.sortFunc=e,t.userSetSortFunc=e?!0:!1,this._gmx.sortItems=t.sortItems,this.repaint(),this},disableFlip:function(){return this._objectsReorderInit(),this._objectsReorder.disabled=!0,this},enableFlip:function(){return this._objectsReorderInit(),this._objectsReorder.disabled=!1,this}})}();var v=function(e){this.gmx=e,this.deferred=new t.gmx.Deferred,this._maxVersion=0,this._maxStyleSize=0,this._styles=[],this._deferredIcons=[],this._parserFunctions={},this._serverStylesParsed=!1;for(var r=1/0,i=-1/0,n=e.properties.styles||[],o=0,a=n.length;a>o;o++){var s=n[o];r=Math.min(r,s.MinZoom),i=Math.max(i,s.MaxZoom)}this.minZoom=1/0===r?0:r,this.maxZoom=i===-1/0?18:i};v.prototype={_getMaxStyleSize:function(e){for(var t=0,r=0,i=this._styles.length;i>r;r++){var n=this._styles[r];if(!(e>n.MaxZoom||e<n.MinZoom)){var o=n.RenderStyle;if(this._needLoadIcons||!o||!("maxSize"in o)){t=v.MAX_STYLE_SIZE;break}var a=0;"iconAnchor"in o&&!o.iconCenter&&(a=Math.max(Math.abs(o.iconAnchor[0]),Math.abs(o.iconAnchor[1]))),t=Math.max(o.maxSize+a,t)}}return t},getStyleBounds:function(e){if(!e)return i.bounds();this._maxStyleSize=this._getMaxStyleSize(this.gmx.currentZoom);var t=2*this._maxStyleSize*i.tileSizes[e.z]/256;return i.getTileBounds(e.x,e.y,e.z).addBuffer(t)},isVisibleAtZoom:function(e){for(var t=0,r=this._styles.length;r>t;t++){var i=this._styles[t];if(e>=i.MinZoom&&e<=i.MaxZoom)return!0}return!1},getIcons:function(e){var t=this;this.deferred.then(function(){for(var r=[],i=0,n=t._styles.length;n>i;i++){var o=t._styles[i],a={};o.RenderStyle&&(a.RenderStyle={image:o.RenderStyle.image}),o.HoverStyle&&(a.HoverStyle={image:o.HoverStyle.image}),r.push(a)}e&&e(r)}),this.initStyles()},_chkReady:function(){if(this._needLoadIcons<1){var e=this;this.gmx.dataManager&&this.gmx.dataManager.addFilter("styleFilter",function(t){return e._chkStyleFilter(t)}),this.deferred.resolve()}},initStyles:function(){this._serverStylesParsed||this._parseServerStyles();for(var e=0,t=this._deferredIcons.length;t>e;e++)this._getImageSize(this._deferredIcons[e]);return this._deferredIcons=[],this._chkReady(),this.deferred},getStyles:function(){this._serverStylesParsed||this._parseServerStyles();for(var e=[],r=0,i=this._styles.length;i>r;r++){var n=t.extend({},this._styles[r]);n.RenderStyle=v.getStyleKeys(n.RenderStyle),n.HoverStyle&&(n.HoverStyle=v.getStyleKeys(n.HoverStyle)),delete n.filterFunction,delete n.version,delete n.common,delete n.type,e.push(n)}return e},clearStyles:function(){this._styles=[],this.gmx.balloonEnable=!1,this.gmx.labelsLayer=!1},_changeStylesVersion:function(){var e=this;this._styles.map(function(t){t.version=++e._maxVersion})},setStyle:function(e,r,i){if(r=r||0,r<this._styles.length||i){var n=this._styles[r];if(n||(n=this._prepareItem({}),this._styles[r]=n),this.deferred=new t.gmx.Deferred,n.version=++this._maxVersion,"Filter"in e){n.Filter=e.Filter;var o=typeof e.Filter;n.filterFunction="string"===o?t.gmx.Parsers.parseSQL(n.Filter.replace(/[\[\]]/g,'"')):"function"===o?n.Filter:null,this._changeStylesVersion()}for(var a=0,s=v.DEFAULT_KEYS.length;s>a;a++){var l=v.DEFAULT_KEYS[a];l in e&&(n[l]=e[l])}e.RenderStyle&&(n.RenderStyle=this._parseStyle(e.RenderStyle)),e.HoverStyle&&(n.HoverStyle=this._parseStyle(e.HoverStyle,n.RenderStyle)),this._checkStyles()}return this.initStyles()},getItemBalloon:function(e){var t=this.gmx.dataManager.getItem(e),r=t?t.currentFilter:0,i=this._styles[r];return i?{DisableBalloonOnMouseMove:i.DisableBalloonOnMouseMove||!1,DisableBalloonOnClick:i.DisableBalloonOnClick||!1,templateBalloon:i.Balloon||null,isSummary:/\[SUMMARY\]/.test(i.Balloon)}:null},getObjStyle:function(e){this._chkStyleFilter(e);var t,r=this._styles[e.currentFilter];return r?r.hoverDiff&&this.gmx.lastHover&&e.id===this.gmx.lastHover.id?r.HoverStyle?(t=r.HoverStyle.version||-1,t!==e.styleVersion&&(e.parsedStyleHover=this._itemStyleParser(e,r.HoverStyle)),r.HoverStyle):(delete e.parsedStyleHover,null):(t=r.version||-1,t!==e.styleVersion&&(e.parsedStyleKeys=this._itemStyleParser(e,r.RenderStyle)),r.RenderStyle):null},_needLoadIcons:0,_getImageSize:function(e){var r=e.iconUrl||e.fillIconUrl,i=e.iconAngle||e.iconScale?{crossOrigin:"anonymous"}:{},n=this;t.gmxUtil.isIE11&&/\.svg$/.test(r)&&(i={}),i.layerID=this.gmx.layerID,++this._needLoadIcons,t.gmx.imageLoader.unshift(r,i).def.then(function(i){if(e.version=++n._maxVersion,e.fillIconUrl)e.imagePattern=i;else{var o=i.width,a=i.height;t.gmxUtil.isIE11&&/\.svg$/.test(r)&&(document.body.appendChild(i),o=i.offsetWidth,a=i.offsetHeight,document.body.removeChild(i)),e.sx=o,e.sy=a,e.image=i;var s=e.iconAngle?Math.sqrt(e.sx*e.sx+e.sy*e.sy):Math.max(e.sx,e.sy);e.scaleFunction||e.rotateFunction||((e.iconScale||1===e.iconScale)&&(s*=e.iconScale),e.common=!0),e.maxSize=Number(s.toFixed())}n._needLoadIcons--,n._chkReady()},function(){e.version=++n._maxVersion,e.sx=1,e.sy=0,e.image=null,n._needLoadIcons--,n._chkReady(),console.log({url:r,func:"_getImageSize",Error:"image not found"})})},getCurrentFilters:function(e,t){var r=this.gmx,i=r.tileAttributeIndexes,n=r.tileAttributeTypes,o=t||1,a=[];this._serverStylesParsed||this._parseServerStyles();for(var s=0,l=this._styles.length;l>s;s++){var u=this._styles[s];if(!(o>u.MaxZoom||o<u.MinZoom||u.filterFunction&&!u.filterFunction(e,i,n)||(a.push(s),r.multiFilters)))break}return a},_chkStyleFilter:function(e){var t=this.gmx,r=t.currentZoom,i=t.multiFilters?-1:e.currentFilter,n=this._styles[i],o=!n||n.version!==e.styleVersion;if(o||e._lastZoom!==r){e.currentFilter=-1,e.multiFilters=[];for(var a=this.getCurrentFilters(e.properties,r),s=0,l=a.length;l>s;s++){var u=a[s],h=this._styles[u];if(e.hoverDiff=h.hoverDiff,e.currentFilter=u,o||i!==u){var c=h.common&&h.common.RenderStyle||this._itemStyleParser(e,h.RenderStyle),d=null;e.parsedStyleKeys=c,h.HoverStyle&&(d=h.common&&h.common.HoverStyle||this._itemStyleParser(e,h.HoverStyle),e.parsedStyleHover=d),t.multiFilters&&e.multiFilters.push({style:h.RenderStyle,styleHover:h.HoverStyle,parsedStyle:c,parsedStyleHover:d})}if(e.styleVersion=h.version,!t.multiFilters)break}e._lastZoom=r}return this._styles[e.currentFilter]?!0:(e.currentFilter=-1,!1)},_parseServerStyles:function(){for(var e=this.gmx,t=e.properties,r=t.styles||[{MinZoom:1,MaxZoom:21,RenderStyle:v.DEFAULT_STYLE}],i=Math.max(r.length,e.styles.length),n=0;i>n;n++)if(!this._styles[n]){var o=e.styles[n]||r[n];if(o.RenderStyle||(o.RenderStyle=v.DEFAULT_STYLE),void 0===o.HoverStyle){var a=JSON.parse(JSON.stringify(o.RenderStyle));a.outline&&(a.outline.thickness+=1),o.HoverStyle=a}else null===o.HoverStyle&&delete o.HoverStyle;var s=this._prepareItem(o);this._styles.push(s),this._isLabel(s.RenderStyle)&&(e.labelsLayer=!0)}this._checkStyles(),this._serverStylesParsed=!0},_checkStyles:function(){for(var e=1/0,t=-1/0,r=!1,i=!1,n=0,o=this._styles.length;o>n;n++){var a=this._styles[n];a.DisableBalloonOnMouseMove=a.DisableBalloonOnMouseMove===!1?!1:!0,a.DisableBalloonOnClick=a.DisableBalloonOnClick||!1,(a.DisableBalloonOnMouseMove===!1||a.DisableBalloonOnClick===!1)&&(r=!0,a.BalloonEnable=!0),a.hoverDiff=null,a.common={},a.RenderStyle&&(i||this._isLabel(a.RenderStyle)&&(i=!0),a.RenderStyle.common&&(a.common.RenderStyle=this._itemStyleParser({},a.RenderStyle)),a.HoverStyle&&(a.hoverDiff=v.checkDiff(a.RenderStyle,a.HoverStyle))),a.HoverStyle&&a.HoverStyle.common&&(a.common.HoverStyle=this._itemStyleParser({},a.HoverStyle)),e=Math.min(e,a.MinZoom),t=Math.max(t,a.MaxZoom)}1/0!==this.minZoom&&(this.minZoom=e),this.maxZoom!==-1/0&&(this.maxZoom=t),this.gmx.balloonEnable=r,this.gmx.labelsLayer=i},_parseStyle:function(e,r){if(e){e.common=!0;for(var n in e)if(i.styleFuncKeys[n]){var o=i.styleFuncKeys[n],a=e[n];"string"==typeof a?(e.common=!1,r&&r[n]===a?e[o]=r[o]:(this._parserFunctions[a]||(this._parserFunctions[a]=t.gmx.Parsers.parseExpression(a)),e[o]=this._parserFunctions[a])):"function"==typeof a&&(e.common=!1,e[o]=a)}var s="";if("iconUrl"in e)s="image",e.iconUrl&&(e.maxSize=256,this._deferredIcons.push(e));else if(e.fillIconUrl)s="square",this._deferredIcons.push(e);else if(e.fillPattern)s="square",e.common=v.parsePattern(e.fillPattern),e.canvasPattern=i.getPatternIcon(null,e);else if(e.iconCircle)s="circle","iconSize"in e||(e.iconSize=4);else if(e.iconPath){s="iconPath";var l=0,u=t.Util.isArray(e.iconPath)?e.iconPath:v.DEFAULT_ICONPATH;e.iconPath=v.DEFAULT_ICONPATH.map(function(e,t){var r=u[t]||e;return l=Math.max(l,r),r}),e.iconSize=2*l}else if(e.fillRadialGradient){s="circle","iconCenter"in e||(e.iconCenter=!0);var h=v.parseRadialGradient(e.fillRadialGradient);null===h?e.common=!1:e.iconSize=h}else e.fillLinearGradient?(s="square",e.common=v.parseLinearGradient(e.fillLinearGradient)):e.iconSize&&(s="square","iconCenter"in e||(e.iconCenter=!0));e.type=s,e.common&&!e.maxSize&&(e.maxSize=e.iconSize||0,e.maxSize+=e.weight?e.weight:0,"iconScale"in e&&(e.maxSize*=e.iconScale))}return e},_prepareItem:function(e){var r={MinZoom:e.MinZoom||0,MaxZoom:e.MaxZoom||18,Filter:e.Filter||null,Balloon:e.Balloon||"",RenderStyle:e.RenderStyle?this._parseStyle(t.gmxUtil.fromServerStyle(e.RenderStyle)):{},version:++this._maxVersion};if(r.DisableBalloonOnMouseMove=e.DisableBalloonOnMouseMove===!1?!1:!0,r.DisableBalloonOnClick=e.DisableBalloonOnClick||!1,e.HoverStyle&&(r.HoverStyle=this._parseStyle(t.gmxUtil.fromServerStyle(e.HoverStyle),r.RenderStyle)),"Filter"in e){var i=t.gmx.Parsers.parseSQL(e.Filter.replace(/[\[\]]/g,'"'));i&&(r.filterFunction=i)}return r},_isLabel:function(e){var t=this.gmx.tileAttributeIndexes;return e&&(e.labelTemplate||e.labelField&&e.labelField in t)},_itemStyleParser:function(e,t){t=t||{};var r,n,o,a={},s=this.gmx.tileAttributeIndexes,l=e.properties||{},u=e.type,h=t.type,c="color"in t?t.color:255,d="opacity"in t?t.opacity:1;if(a.sx=t.sx,a.sy=t.sy,t.maxSize&&(a.maxSize=t.maxSize),t.iconAngle){var f=t.iconAngle||0;f&&"string"==typeof f&&(f=t.rotateFunction?t.rotateFunction(l,s):0),a.rotate=f||0}if("iconColor"in t&&(a.iconColor="iconColorFunction"in t?t.iconColorFunction(l,s):t.iconColor),"iconScale"in t&&(a.iconScale="scaleFunction"in t?t.scaleFunction?t.scaleFunction(l,s):1:t.iconScale),"image"===h)a.type=h,t.iconUrl&&(a.iconUrl=t.iconUrl),t.image&&(a.image=t.image);else if(t.fillRadialGradient){var m=t.fillRadialGradient,p=m.r1Function?m.r1Function(l,s):m.r1,g=m.r2Function?m.r2Function(l,s):m.r2,v=m.x1Function?m.x1Function(l,s):m.x1,y=m.y1Function?m.y1Function(l,s):m.y1,x=m.x2Function?m.x2Function(l,s):m.x2,_=m.y2Function?m.y2Function(l,s):m.y2;m.r2max&&(g=Math.min(g,m.r2max));var b=[];for(o=m.addColorStop.length,m.addColorStopFunctions||(m.addColorStopFunctions=new Array(o)),n=0;o>n;n++){r=m.addColorStop[n];var P=m.addColorStopFunctions[n]||[],T=P[0]?P[0](l,s):r[0],S=r[3];if(r.length<4){var I=r.length<3?1:P[2]?P[2](l,s):r[2];S=i.dec2color(P[1]?P[1](l,s):r[1],I)}b.push([T,S])}a.maxSize=a.sx=a.sy=a.iconSize=g,a.fillRadialGradient={x1:v,y1:y,r1:p,x2:x,y2:_,r2:g,addColorStop:b},a._radialGradientParsed={create:[v,y,p,x,_,g],colorStop:b}}else if(t.fillLinearGradient)a.fillLinearGradient=t.fillLinearGradient;else{if(t.fillPattern&&(a.canvasPattern=t.canvasPattern?t.canvasPattern:i.getPatternIcon(e,t,s)),"iconPath"===h&&(a.type=h,a.iconPath=t.iconPath),("POLYGON"===u||"MULTIPOLYGON"===u||"polygon"===this.gmx.GeometryType)&&(h="polygon"),t.iconSize){var M="sizeFunction"in t?t.sizeFunction(l,s):t.iconSize;a.sx=a.sy=M,a.iconSize=M,"iconScale"in t&&(a.iconSize*=t.iconScale),a.maxSize=M}a.stroke=!0,("colorFunction"in t||"opacityFunction"in t)&&(c="colorFunction"in t?t.colorFunction(l,s):c,d="opacityFunction"in t?t.opacityFunction(l,s):d),a.strokeStyle=i.dec2color(c,d),a.lineWidth="weight"in t?t.weight:1}if("iconScale"in t&&(a.iconScale="scaleFunction"in t?t.scaleFunction?t.scaleFunction(l,s):1:t.iconScale),"iconAnchor"in t&&(a.iconAnchor=t.iconAnchor),"iconCenter"in t&&(a.iconCenter=t.iconCenter),"square"===h||"polygon"===h||"circle"===h||"iconPath"===h){a.type=h;var L=t.fillOpacity,k=t.fillColor,C="string"==typeof k?parseInt(k.replace(/#/,""),16):k;"fillColor"in t&&(a.fillStyle=i.dec2color(C,1)),"fillColorFunction"in t||"fillOpacityFunction"in t?(c="fillColorFunction"in t?t.fillColorFunction(l,s):k||255,d="fillOpacityFunction"in t?t.fillOpacityFunction(l,s):L||1,a.fillStyle=i.dec2color(c,d)):"fillOpacity"in t&&"fillColor"in t&&(a.fillStyle=i.dec2color(C,L))}if("dashArray"in t&&(a.dashArray=t.dashArray),"dashOffset"in t&&(a.dashOffset=t.dashOffset),this.gmx.labelsLayer){for(r=i.styleKeys.label.client,n=0,o=r.length;o>n;n++){var D=r[n];if(D in t){if("labelField"===D){if(!s[t[D]])continue}else if("labelTemplate"===D){var O=i.getPropertiesHash(l,s);a.labelText=i.parseTemplate(t[D],O)}a[D]=t[D]}}"labelAnchor"in t&&(a.labelAnchor=t.labelAnchor)}return a}},v.MAX_STYLE_SIZE=256,v.DEFAULT_STYLE={outline:{color:255,thickness:1},marker:{size:8}},v.DEFAULT_KEYS=["MinZoom","MaxZoom","Balloon","BalloonEnable","DisableBalloonOnMouseMove","DisableBalloonOnClick"],v.DEFAULT_ICONPATH=[0,10,5,-10,-5,-10,0,10],v.parsePattern=function(e){var r=!0,i=t.gmx.Parsers;if("step"in e&&"string"==typeof e.step&&(e.patternStepFunction=i.parseExpression(e.step),r=!1),"width"in e&&"string"==typeof e.width&&(e.patternWidthFunction=i.parseExpression(e.width),r=!1),"colors"in e){for(var n=[],o=0,a=e.colors.length;a>o;o++){var s=e.colors[o];"string"==typeof s?(n.push(i.parseExpression(s)),r=!1):n.push(null)}e.patternColorsFunction=n}return r},v.getStyleKeys=function(e){var t={};for(var r in i.styleKeys)for(var n=i.styleKeys[r],o=0,a=n.client.length;a>o;o++){var s=n.client[o];s in e&&(void 0!==e[s]&&(t[s]=JSON.parse(JSON.stringify(e[s]))),"fillPattern"===s?delete t[s].patternColorsFunction:"fillLinearGradient"===s&&delete t[s].addColorStopFunctions)}return"iconAnchor"in e&&(t.iconAnchor=e.iconAnchor),"labelAnchor"in e&&(t.labelAnchor=e.labelAnchor),t},v.checkDiff=function(e,t){for(var r in e)if(e[r]!==t[r])return r;return null},v.parseRadialGradient=function(e){var r=!0,n=t.gmx.Parsers,o=0,a=["r1","x1","y1","r2","x2","y2"],s=a.length;for(o=0;s>o;o++){var l=a[o];e[l]||(e[l]=0),"string"==typeof e[l]&&(e[l+"Function"]=n.parseExpression(e[l]),r=!1)}for(e.addColorStop=e.addColorStop||[[0,16711680,.5],[1,16777215,.5]],e.addColorStopFunctions=[],o=0,s=e.addColorStop.length;s>o;o++){a=e.addColorStop[o];var u=["string"==typeof a[0]?n.parseExpression(a[0]):null,"string"==typeof a[1]?n.parseExpression(a[1]):null,"string"==typeof a[2]?n.parseExpression(a[2]):null];e.addColorStopFunctions.push(u),null===u[1]&&null===u[2]?a[3]=i.dec2color(a[1],a[2]>1?a[2]/100:a[2]):r=!1}return"r2Function"in e&&(r=!1),r?Math.max(e.r1,e.r2):null},v.parseLinearGradient=function(e){var r=!0,i=0,n=t.gmx.Parsers,o=["x1","y1","x2","y2"],a=[0,0,0,256],s=o.length;for(i=0;s>i;i++){var l=o[i];l in e?"string"==typeof e[l]&&(e[l+"Function"]=n.parseExpression(e[l]),r=!1):e[l]=a[i]}for(e.addColorStop=e.addColorStop||[[0,16711680],[1,16777215]],e.addColorStopFunctions=[],i=0,s=e.addColorStop.length;s>i;i++)o=e.addColorStop[i],e.addColorStopFunctions.push(["string"==typeof o[0]?n.parseExpression(o[0]):null,"string"==typeof o[1]?n.parseExpression(o[1]):null,"string"==typeof o[2]?n.parseExpression(o[2]):null]);return r},t.gmx.VectorLayer.include({bindPopup:function(e,r){var i=t.extend({maxWidth:1e4,className:"gmxPopup",layerId:this._gmx.layerID},r);return this._popup&&this.unbindPopup(),e instanceof t.Popup?this._popup=e:((!this._popup||r)&&(this._popup=new t.Popup(i)),this._popup.setContent(e)),this._popup._initContent=e,this._popup._state="",this._popupHandlersAdded||(this.on("click",this._openClickPopup,this).on("mousemove",this._movePopup,this).on("mouseover",this._overPopup,this).on("mouseout",this._outPopup,this).on("doneDraw",this._chkNeedOpenPopup,this),this._popupHandlersAdded=!0),i&&i.popupopen&&(this._popupopen=i.popupopen),this._popup.updateLayout=this._popup._updateLayout,this},unbindPopup:function(){return this._popup&&(this._popup=null,this.off("click",this._openClickPopup,this).off("mousemove",this._movePopup,this).off("mouseover",this._overPopup,this).off("mouseout",this._outPopup,this).off("doneDraw",this._chkNeedOpenPopup,this),this._popupopen=null,this._popupHandlersAdded=!1),this._gmx.balloonEnable=!1,this},_chkNeedOpenPopup:function(){for(var e in this._gmx._needPopups)this._gmx._needPopups[e]&&(this.addPopup(e),delete this._gmx._needPopups[e])},disablePopup:function(){return this._popupDisabled=!0,this},enablePopup:function(){return this._popupDisabled=!1,this},openPopup:function(e,t){return this._popup&&(e=e||this._latlng||this._latlngs[Math.floor(this._latlngs.length/2)],t=t||{},t.latlng=e,this._openPopup(t)),this},closePopup:function(){return this._popup&&(this._popup._close(),this.fire("popupclose",{popup:this._popup})),this},_movePopup:function(e){if("mouseover"===this._popup._state){var t=this._popup.options._gmxID||-1;t!==e.gmx.id&&this._setPopupContent(e),this._popup.setLatLng(e.latlng)}},_overPopup:function(e){var t=this._popup;t._map?this.fire("popupopen",{popup:t,gmx:this._setPopupContent(e,t)}):this._openPopup(e),"mouseover"===t._state&&t.setLatLng(e.latlng)},_outPopup:function(e){"mouseover"!==this._popup._state||e.gmx.prevId||this.closePopup()},_callBalloonHook:function(e,t){var r,i,n,o=t.getElementsByTagName("span"),a={};for(r in this._balloonHook){var s=this._balloonHook[r].hookID;for(a[r]=0,i=0,n=o.length;n>i;i++)o[i].id===s&&a[r]++}for(r in this._balloonHook){var l=this._balloonHook[r],u=l.hookID,h=!0;for(i=0,n=o.length;n>i;i++){var c=o[i];c.id===u&&(h=!1,c.id+="_"+i,l.callback(e,t,c,a))}h&&l.callback(e,t,null,a)}},_setPopupContent:function(e,r){r||(r=this._popup);var n=e.gmx||{},o=n.balloonData||{},a=t.extend({},n.properties),s=n.target||{},l=s.geometry||{},u=s.offset,h=r._initContent||o.templateBalloon||"",c=e.type,d=this.options.isGeneralized&&("mouseover"===c||"mousemove"===c),f={id:n.id,type:c,nodePoint:n.nodePoint,latlng:e.latlng,properties:a,templateBalloon:h};if("POINT"===l.type){var m=l.coordinates;f.latlng=t.Projection.Mercator.unproject({x:m[0],y:m[1]})}if(u){var p=t.Popup.prototype.options.offset;r.options.offset=[-p[0]-u[0],p[1]-u[1]]}if(this._popupopen)this._popupopen({popup:r,latlng:f.latlng,layerPoint:e.layerPoint,contentNode:r._contentNode,containerPoint:e.containerPoint,originalEvent:e.originalEvent,gmx:f});else if(!(h instanceof t.Popup)){if(!(h instanceof HTMLElement)){var g,v="",y=this._map?this._map.options:{};if(d||(g=s.geometry?[s.geometry]:n.geometries||this._gmx.dataManager.getItemGeometries(n.id)||[],f.summary=v=t.gmxUtil.getGeometriesSummary(g,y)),this._balloonHook){h||(h=i.getDefaultBalloonTemplate(a));for(var x in this._balloonHook)a[x]=i.parseTemplate(this._balloonHook[x].resStr,a)}h=t.gmxUtil.parseBalloonTemplate(h,{properties:a,tileAttributeTypes:this._gmx.tileAttributeTypes,unitOptions:y,summary:v,geometries:g})}var _=t.DomUtil.create("div","");_.innerHTML=h,r.setContent(_),this._balloonHook&&this._callBalloonHook(n.properties,r.getContent())}return r.options._gmxID=n.id,f},_openClickPopup:function(e){var r=e.originalEvent||{},n=!e.gmx||this._popupDisabled||r.ctrlKey||r.altKey||r.shiftKey;if(!n){var o=e.type,a=e.gmx,s=a.balloonData,l="click"===o&&s.isSummary&&!s.DisableBalloonOnClick,u=a.target;if(l&&u.options.isGeneralized&&!u.geometry){var h=a.layer.getGmxProperties();i.getLayerItemFromServer({options:e,layerID:h.name,value:u.id,field:h.identityField}).then(function(e,t){if(e&&"ok"===e.Status&&e.Result){var r=e.Result.values[0];t.options.gmx.target.fromServerProps=r,t.options.gmx.target.geometry=r[r.length-1],this._openPopup(t.options)}}.bind(this))}else-1!==u.type.indexOf("POINT")&&(e.latlng=t.latLng(t.gmxUtil.geometryToGeoJSON(u.properties[u.properties.length-1],!0).coordinates.reverse())),this._openPopup(e)}},_openPopup:function(e,r){var i=this._map,n=e.originalEvent||{},o=r?!r:this._popupDisabled||n.ctrlKey||n.altKey||n.shiftKey;if(!o){var a=e.type,s=this._popup,l=e.gmx||{},u=l.balloonData||{};if("click"===a){if(!r&&u.DisableBalloonOnClick&&!this.hasEventListeners("popupopen"))return;"_gmxPopups"in i||(i._gmxPopups=[]),"maxPopupCount"in i.options||(i.options.maxPopupCount=1),this._gmx._gmxPopupsInit||(this._gmx._gmxPopupsInit=!0,i.on({layerremove:function(e){if(e.layer instanceof t.Popup)this._clearPopup(e.layer);else if(e.layer===this){if(i._gmxPopups){var r=this._gmx.layerID;i._gmxPopups=i._gmxPopups.reduce(function(e,t){return t._map&&(t.options.layerId===r?t._map.removeLayer(t):e.push(t)),e},[])}this.closePopup()}}},this)),this._clearPopup(l.id);var h=this._popup?this._popup.options:{maxWidth:1e4,className:"gmxPopup",layerId:this._gmx.layerID};s=new t.Popup(t.extend({},h,{closeOnClick:1===i.options.maxPopupCount,autoPan:!0}))}else{if("mouseover"!==a)return;if(u.DisableBalloonOnMouseMove)return s._state="",void 0;s.options.autoPan=!1}s.options.objectId=l.id,s._state=a;var c=this._setPopupContent(e,s);if(s.setLatLng(c.latlng),this.fire("popupopen",{popup:s,gmx:c}),"click"===a&&(i._gmxPopups.length>=i.options.maxPopupCount&&i.removeLayer(i._gmxPopups.shift()),i._gmxPopups.push(s)),s.addTo(i),s._closeButton){var d=s._closeButton.style;"mouseover"===a&&"hidden"!==d?(d.visibility="hidden",s._container.style.marginBottom="7px",s._container.style.pointerEvents="none"):"click"===a&&"inherit"!==d&&(d.visibility="inherit",s._container.style.marginBottom="",s._container.style.pointerEvents="")}}},_clearPopup:function(e){var r=this._map;if(r&&r._gmxPopups){var i=this._gmx.layerID,n=e instanceof t.Popup;r._gmxPopups=r._gmxPopups.reduce(function(t,r){return r._map&&(n&&r===e?r._map.removeLayer(r):r.options.layerId===i&&r.options.objectId===e?r._map.removeLayer(r):t.push(r)),t},[])}},getPopups:function(e){var t=this._map,r=[];if(t&&t._gmxPopups){var i=this._gmx.layerID;t._gmxPopups.reduce(function(t,r){return r.options.layerId===i&&t.push(e?r:r.options.objectId),t},r)}return r},addPopup:function(e){var r=this._gmx,i=r.dataManager.getItem(e);if(i&&this._map){var n=i.bounds.getCenter(),o=t.Projection.Mercator.unproject(new t.Point(n[0],n[1]));this._openPopup({type:"click",latlng:o,gmx:this.getHoverOption(i)},!0),delete r._needPopups[e]}else r._needPopups[e]=!1;return this},addPopupHook:function(e,r){if(this._balloonHook||(this._balloonHook={}),!this._balloonHook[e]){var i="_"+t.stamp({});this._balloonHook[e]={key:e,hookID:i,resStr:'<span id="'+i+'"></span>',callback:r}}return this},removePopupHook:function(e){return this._balloonHook&&delete this._balloonHook[e],this}}),t.gmx.VectorLayer.include({_gmxFirstObjectsByPoint:function(e,t,r){for(var n,o,a=this._gmx,s=a.mInPixel,l=e.length-1;l>=0;l--){var u=e[l].properties,h=u[0],c=e[l].dataOption||{},d=a.dataManager.getItem(h),f=d.currentStyle||d.parsedStyleKeys||{},m=f.iconScale||1,p=f.iconCenter,g=!p&&f.iconAnchor?f.iconAnchor:null,v=a.styleManager.getObjStyle(d),y=f.lineWidth||v.lineWidth||0,x=y+(v.sx||f.sx||0),_=y+(v.sy||f.sy||0),b=[m*x/2,m*_/2],P=t,T=u[u.length-1],S=T.type;"POINT"===S&&"circle"===v.type&&(b[0]*=2,b[1]*=2);var I=b[0],M=i.bounds().extendBounds(c.bounds).addBuffer(b[0]/s,b[1]/s);if(g&&(b=[g[0]-b[0],g[1]-b[1]],P=[t[0]+b[0]/s,t[1]-b[1]/s]),M.contains(P)){var L=f.fillStyle||f.canvasPattern||v.bgImage||v.fillColor,k=v&&v.image?v.image:null,C=S,D=c.hiddenLines||[],O=c.boundsArr,w=T.coordinates,F=null,N={point:t,bounds:r,coords:w,boundsArr:O};if(("MULTIPOLYGON"===S||"POLYGON"===S)&&(k?C="POINT":L||("POLYGON"===S?(C="MULTILINESTRING",D=D[0]):C="LIKEMULTILINESTRING",N.hidden=D)),"LINESTRING"===C){if(!i.isPointInPolyLine(t,y/s,w)&&(F=i.bounds([P]).addBuffer(b[0]/s,b[1]/s).isNodeIntersect(w),null===F))continue}else if("LIKEMULTILINESTRING"===C){N.delta=y/s;var R=!1;for(n=0,o=w.length;o>n;n++)if(N.coords=w[n],N.hidden=D?D[n]:null,N.boundsArr=O[n],i.isPointInLines(N)){R=!0;break}if(!R)continue}else if("MULTILINESTRING"===C){if(N.delta=y/s,N.hidden=D,!i.isPointInLines(N)){var A=i.bounds([P]).addBuffer(b[0]/s,b[1]/s);for(n=0,o=w.length;o>n;n++)if(F=A.isNodeIntersect(w[n]),null!==F){F.ring=n;break}if(null===F)continue}}else if("MULTIPOLYGON"===C||"POLYGON"===C){var E=t;for(R=!1,"POLYGON"===C&&(w=[T.coordinates],O=[c.boundsArr]),n=0,o=w.length;o>n;n++)for(var z=w[n],G=O[n],B=0,U=z.length;U>B;B++){var H=G[B];if(H.intersects(r)&&i.isPointInPolygonWithHoles(E,z)){R=0===B?!0:!1;break}}if(!R)continue}else if("POINT"===C&&"circle"===v.type){var V=(w[0]-P[0])*s,j=(w[1]-P[1])*s;if(V*V+j*j>I*I)continue}if(this.isPointInClipPolygons(t))return{id:h,properties:d.properties,geometry:T,bounds:d.bounds,nodePoint:F,offset:g?b:null,parsedStyle:v}}}return null},gmxEventCheck:function(e,r){if(!this._map)return 0;var n=this,o=n._gmx,a=e.type,s=o.lastHover,l=function(t){s&&"mousemove"===a&&(t&&n.hasEventListeners(t)&&(e.gmx=s,n.fire(t,e)),s.hoverDiff&&n.redrawItem(s.id))},u=this._map.getZoom();if((u>this.options.maxZoom||u<this.options.minZoom)&&(r=!0),r)s&&(s.prevId=null),l("mouseout"),o.lastHover=null;else if(this.hasEventListeners("mouseover")||this.hasEventListeners("mouseout")||this.hasEventListeners(a)||"mousemove"===a&&"Raster"!==o.properties.fromType){var h=e.latlng.lng%360,c=new t.LatLng(e.latlng.lat,h+(-180>h?360:h>180?-360:0)),d=t.Projection.Mercator.project(c)._subtract({x:o.shiftXlayer||0,y:o.shiftYlayer||0}),f=Math.max(5,o.styleManager._getMaxStyleSize(u))/o.mInPixel,m=[d.x,d.y],p=o.dataManager.getViewFilters("screen",o.layerID),g={type:"resend",layerID:o.layerID,needBbox:o.needBbox,bbox:i.bounds([m]).addBuffer(f),dateInterval:"VectorTemporal"===o.layerType?[o.beginDate,o.endDate]:null,filters:["clipFilter","userFilter_"+o.layerID,"styleFilter","userFilter"].concat(p),active:!1};this.options.isGeneralized&&(g.targetZoom=u),o.dataManager.addObserver(g,"hover");var v=o.dataManager.getItems("hover");if(o.dataManager.removeObserver("hover"),v&&v.length){v.length>1&&o.sortItems&&(v=this.getSortedItems(v));var y=this._gmxFirstObjectsByPoint(v,m,g.bbox);if(y){var x=y.id,_=o.dataManager.getItem(x),b=s?s.id:null,P=!s||s.id!==x;if("mousemove"===a&&s){if(!P)return e.gmx=s,this.fire(a,e),x;l(_.currentFilter!==s.currentFilter?"mouseout":""),o.lastHover=null}return e.gmx=t.extend(this.getHoverOption(_),{targets:v,nodePoint:y.nodePoint,prevId:b,hoverDiff:_.hoverDiff}),this.hasEventListeners(a)&&this.fire(a,e),"mousemove"===a&&P&&(s=o.lastHover=e.gmx,l("mouseover"),o.lastMouseover=o.lastHover),this._map.doubleClickZoom.disable(),x}}}return this._map&&this._map.doubleClickZoom.enable(),0},getHoverOption:function(e){return{layer:this,target:e,balloonData:this._gmx.styleManager.getItemBalloon(e.id),properties:this.getItemProperties(e.properties),currentFilter:e.currentFilter||0,id:e.id}}}),function(){var e=2e4,r={},i={},n="/Layer/CheckVersion.ashx",o=null,a=null,s="",l=function(e){var t=e.Temporal?"TemporalTiles":"tiles";return t in e||e.currentTiles},u=function(e,t,r){var i={Name:e.name,Version:l(e)?e.LayerVersion:-1};if(t&&(e.UseTiles===!1||"NotVisible"===r.skipTiles||r.needBbox)){var n=t.getMaxDateInterval(),o=n.beginDate||r.beginDate,a=n.endDate||r.endDate;o&&(i.dateBegin=Math.floor(o.getTime()/1e3)),a&&(i.dateEnd=Math.floor(a.getTime()/1e3))}return i},h=function(e){var i,n,o,a,s={};if(e)e.target instanceof t.gmx.DataManager&&(e=e.target),e instanceof t.gmx.DataManager?(o=e,i=o.options):(i=e._gmx.properties,o=e._gmx.dataManager,a=e._gmx),n=i.hostName||e._gmx.hostName,s[n]=[u(i,o,a)];else{var l={};for(var h in r){var c=r[h],d=c instanceof t.gmx.DataManager;if(c.options.chkUpdate||d){o=d?c:c._gmx.dataManager,i=d?c.options:c._gmx.properties,a=d?c:c._gmx,n=i.hostName||c._gmx.hostName;var f=u(i,o,a),m=f.Name+f.Version;l[m]||(s[n]?s[n].push(f):s[n]=[f]),l[m]=!0}}}return s},c=function(e,i){var o=d._map,a=function(n){if(n&&"ok"===n.Status&&n.Result){var a,l,u,h,c,f=n.Result,m=f.length,p=0;if(d.needBbox){for(a=0;m>a;a++){if(c=f[a],h=c.name||c.properties.name,u=null,e&&e._gmx.properties.name===h)u=e;else for(l in r)if(u=r[l],!(e&&e===u&&"updateVersion"in e)){if(u._gmx&&u._gmx.properties.name===h&&"updateVersion"in u)break;if(u instanceof t.gmx.DataManager&&u.options.name===h)break}u&&(p+=(u.getDataManager?u.getDataManager():u).getNotLoadedVectorTiles(c))}if(o.fire("needLoadTiles",{count:p}),t.gmx.skipLoadTiles)return console.log("Skiped tiles: ",t.gmx.needLoadTiles),void 0}for(a=0;m>a;a++){c=f[a],h=c.name||c.properties.name,e&&e._gmx.properties.name===h&&"updateVersion"in e&&e.updateVersion(c);for(l in r)u=r[l],e&&e===u||(u._gmx&&u._gmx.properties.name===h&&"updateVersion"in u?u.updateVersion(c):u instanceof t.gmx.DataManager&&u.options.name===h&&u.updateVersion(c.properties,c.tiles))}}s="",i&&i(n)};if(document.body&&!t.gmxUtil.isPageHidden()){var l=h(e),u=function(e){var i=t.gmxUtil.protocol+"//"+e+n,u=JSON.stringify(l[e]);if(s!==u){if(s=u,"FormData"in window){var h="WrapStyle=None";if(d.needBbox){"3857"===o.options.srs&&(h+="&srs=3857");var c=o.getZoom(),f=o.getBounds(),m=t.Projection.Mercator.project(f.getSouthWest()),p=t.Projection.Mercator.project(f.getNorthEast()),g=[m.x,m.y,p.x,p.y].join(",");h+="&zoom="+c,h+="&bbox=["+g+"]"}h+="&layers="+encodeURIComponent(u),t.gmxUtil.request({url:i,async:!0,headers:{"Content-type":"application/x-www-form-urlencoded"},type:"POST",params:h,withCredentials:!0,callback:function(e){a(JSON.parse(e))},onError:function(e){console.log("Error: LayerVersion ",e)}})}else t.gmxUtil.sendCrossDomainPostRequest(i,{WrapStyle:"message",layers:u},a);var v=Date.now();for(var y in r){var x=r[y],_=x._gmx||x.options;_.hostName===e&&(_._stampVersionRequest=v)}}};for(var c in l)u(c)}},d={needBbox:!1,addDataManager:function(e){var t=e.options,i=t.name;i in r||(t.needBbox&&!d.needBbox&&(d.needBbox=t.needBbox),e.on("chkLayerUpdate",c.bind(e)),r[i]=e)},removeDataManager:function(e){var t=e.options.name;t in r&&(e.off("chkLayerUpdate",c.bind(e)),delete r[t])},remove:function(e){delete r[e._leaflet_id];var t=e._gmx,n=e.options.parentOptions;if(n){var o=n.name;i[o]&&(delete i[o][t.properties.name],Object.keys(i[o]).length||(d.removeDataManager(t.dataManager),delete i[o]))}else t.dataManager.off("chkLayerUpdate",t._chkVersion)},add:function(e){var t=e._leaflet_id;if(!(t in r)){var n=e._gmx,o=n.properties;if("LayerVersion"in o){r[t]=e,n._chkVersion=function(){c(e)},n.dataManager.on("chkLayerUpdate",n._chkVersion);var a=e.options.parentOptions;if(a){var s=a.name;d.addDataManager(n.dataManager),i[s]||(i[s]={}),i[s][o.name]=e}n.needBbox&&!d.needBbox&&(d.needBbox=n.needBbox),d.start(),(!n._stampVersionRequest||n._stampVersionRequest<Date.now()-19e3||!l(o))&&d.now()}}},chkVersion:c,now:function(){a&&clearTimeout(a),a=setTimeout(c,0)},stop:function(){o&&clearInterval(o),o=null},start:function(t){t&&(e=t),d.stop(),o=setInterval(c,e)}};t.gmx||(t.gmx={}),t.gmx.layersVersion=d,t.gmx.VectorLayer.include({updateVersion:function(e){if(e){var r=this._gmx;e.geometry&&(r.geometry=e.geometry),e.properties&&(t.extend(r.properties,e.properties),r.properties.currentTiles=e.tiles,r.properties.GeoProcessing=e.properties.GeoProcessing,r.rawProperties=r.properties,this.fire("versionchange")),!r.dataSource&&r.dataManager&&r.dataManager.updateVersion(r.rawProperties,e.tiles)}}}),t.Map.addInitHook(function(){d._map=this;var e=this,t={};this.on("moveend",function(){var r=e.getZoom(),i=e.getPixelBounds().getCenter();(r!==t.z||t.center.distanceTo(i)>128)&&(c(),t.z=r,t.center=i)})})}(),t.gmx.RasterLayer=t.gmx.VectorLayer.extend({options:{isGeneralized:!1,zIndexOffset:0},initFromDescription:function(e){var r=e.properties,n=r.styles[0]||{MinZoom:r.MinZoom||0,MaxZoom:r.MaxZoom||21},o={type:"Vector",fromType:r.type,identityField:"ogc_fid",GeometryType:"POLYGON",IsRasterCatalog:!0,Copyright:r.Copyright||"",RCMinZoomForRasters:n.MinZoom,visible:r.visible,styles:[{DisableBalloonOnClick:!0,MinZoom:n.MinZoom,MaxZoom:n.MaxZoom,RenderStyle:{outline:{thickness:0},fill:{opacity:100}},HoverStyle:null}]},a=this._gmx,s=i.tileSizes[1];r.MaxZoom&&(a.maxNativeZoom=r.MaxZoom),e.geometry||(e.geometry={type:"POLYGON",coordinates:[[[-s,-s],[-s,s],[s,s],[s,-s],[-s,-s]]]}),t.gmx.VectorLayer.prototype.initFromDescription.call(this,{geometry:e.geometry,properties:o,rawProperties:e.properties}),a.rasterBGfunc=function(e,r,i){var n=t.gmxUtil.protocol+"//"+a.hostName+"/"+"TileSender.ashx?ModeKey=tile"+"&z="+i+"&x="+e+"&y="+r;
return a.srs&&(n+="&srs="+a.srs),a.crossOrigin&&(n+="&cross="+a.crossOrigin),n+="&LayerName="+a.layerID,a.sessionKey&&(n+="&key="+encodeURIComponent(a.sessionKey)),n};var l={load:function(t,r,n,o,a,l,u){var h=[[777,e.geometry]],c=i.geoItemBounds(e.geometry),d=c.bounds;if(d.max.x>s){var f=2*s,m=777,p=e.geometry.coordinates,g=c.boundsArr;h=[],"POLYGON"===e.geometry.type&&(p=[p],g=[g]);for(var v=0,y=p.length;y>v;v++){var x=p[v],_=g[v][0],b=x;if(h.push([m++,{type:"POLYGON",coordinates:b}]),_.max.x>s){b=[];for(var P=0,T=x.length;T>P;P++){for(var S=x[P],I=0,M=[],L=S.length;L>I;I++){var k=S[I];M.push([k[0]-f,k[1]])}b.push(M)}h.push([m++,{type:"POLYGON",coordinates:b}])}}}u(h,[d.min.x,d.min.y,d.max.x,d.max.y])}};return a.dataManager._rasterVectorTile=new f(l,{x:-.5,y:-.5,z:0,v:0,s:-2,d:-2}),a.dataManager.addTile(a.dataManager._rasterVectorTile),this},setZoomBounds:function(e,r){var i=this.getStyles().slice(0);i[0]=t.extend({},i[0]),i[0].MinZoom=e,i[0].MaxZoom=r,this.setStyles(i)}}),t.LabelsLayer=t.Class.extend({options:{pane:"overlayPane"},initialize:function(e,r){t.setOptions(this,r),this._observers={},this._styleManagers={},this._labels={};var n=this;this.bbox=i.bounds();var o=function(r,o){if(r.added||r.removed){for(var a=o.options,s=e._zoom>=a.minZoom&&e._zoom<=a.maxZoom?r.added:[],l="_"+o._leaflet_id,u=o._gmx,h={},c=0,d=s.length;d>c;c++){var f=s[c].item,m="POINT"===f.type||"MULTIPOINT"===f.type,p=f.parsedStyleKeys||f.currentStyle||{};if(u.styleHook){var g=u.styleHook(f,u.lastHover&&f.id===u.lastHover.id);if(!g)continue;p=t.extend({},p,g)}if(f.multiFilters)for(var v=0,y=f.multiFilters.length;y>v;v++){var x=f.multiFilters[v].parsedStyle;if("labelField"in x||"labelText"in x){p=x;break}}var _=u.styleManager.getObjStyle(f)||{},b=p.labelText||_.labelText,P=p.labelField||_.labelField,T=u.tileAttributeTypes[P],S=String(b||t.gmxUtil.attrToString(T,o.getPropItem(P,f.properties)));if(_.labelTemplate){var I,M=/\[([^\]]*)\]/g;for(S=_.labelTemplate;I=M.exec(_.labelTemplate);)if(2===I.length){P=I[1],T=u.tileAttributeTypes[P];var L=t.gmxUtil.attrToString(T,o.getPropItem(P,f.properties));S=S.replace(I[0],L)}}if(S||0===S){var k,C=_.labelFontSize||p.labelFontSize||12,D="_"+f.id,O=!0,w=0,F=f.options,N={font:C+'px "Arial"',labelHaloColor:"labelHaloColor"in p?p.labelHaloColor:"labelHaloColor"in _?_.labelHaloColor:16777215,labelColor:p.labelColor||_.labelColor,labelAlign:p.labelAlign||_.labelAlign,labelAnchor:p.labelAnchor||_.labelAnchor,labelFontSize:C};if(F){if(!("center"in F)){var R=i.getItemCenter(f,u.dataManager.getItemMembers(f.id));if(!R)continue;F.center=R}if(F.label){w=F.label.width,k=F.label.arrTxtWidth;var A=F.label.style;O=F.label.txt!==S||A.labelHaloColor!==N.labelHaloColor||A.labelColor!==N.labelColor||A.labelAlign!==N.labelAlign||A.labelAnchor!==N.labelAnchor||A.labelFontSize!==N.labelFontSize}}if(O){if(w=0,k=i.getLabelWidth(S,N),k&&k.forEach(function(e){w=Math.max(w,e[1])}),!w){delete h[D];continue}w+=4,f.options.labelStyle=null}F.label={isPoint:m,width:w,sx:_.sx||0,txt:S,arrTxtWidth:k,style:N},h[D]=f}}n._labels[l]=h}},a=function(e,t){var r=e._gmx,i=["styleFilter","userFilter"],a={type:"resend",bbox:n.bbox,filters:i,callback:function(t){o(t,e),n.redraw()}};return r.beginDate&&r.endDate&&(a.dateInterval=[r.beginDate,r.endDate]),r.dataManager.addObserver(a,"_Labels_"+t)};this.add=function(e){var t=e._leaflet_id,r=e._gmx;!n._observers[t]&&r&&r.labelsLayer&&t&&r.styleManager.deferred.then(function(){var i=a(e,t),o=n._map._zoom;e.options.isGeneralized&&(i.targetZoom=o),i.dateInterval&&e.on("dateIntervalChanged",function(e){var t=e.target.getDateInterval();this.setDateInterval(t.beginDate,t.endDate)},i),r.styleManager.isVisibleAtZoom(o)||i.deactivate(),n._observers[t]=i,n._styleManagers[t]=r.styleManager,n._labels["_"+t]={},n._updateBbox()})},this.remove=function(e){var t=e._leaflet_id;if(n._observers[t]){var r=e._gmx,i=r.dataManager;i.removeObserver(n._observers[t].id),delete n._observers[t],delete n._styleManagers[t],delete n._labels["_"+t],n.redraw()}},this._layeradd=function(e){n.add(e.layer)},this._layerremove=function(e){n.remove(e.layer)}},redraw:function(){return this._frame||this._map._animating||(this._frame=t.Util.requestAnimFrame(this._redraw,this)),this},_addToPane:function(){var e=this._map.getPanes()[this.options.pane];e&&e.insertBefore(this._canvas,e.firstChild)},onAdd:function(e){this._map=e,this._canvas||this._initCanvas(),e.on("moveend",this._reset,this),e.on({layeradd:this._layeradd,layerremove:this._layerremove}),e.options.zoomAnimation&&t.Browser.any3d&&e.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(e){this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),e.off("moveend",this._reset,this),e.off("layeradd",this._layeradd),e.off("layerremove",this._layerremove),e.options.zoomAnimation&&e.off("zoomanim",this._animateZoom,this)},addTo:function(e){return e.addLayer(this),this},_initCanvas:function(){var e=t.DomUtil.create("canvas","leaflet-labels-layer leaflet-layer"),r=this._map.getSize();e.width=r.x,e.height=r.y,e.style.pointerEvents="none",this._canvas=e;var i=this._map.options.zoomAnimation&&t.Browser.any3d;t.DomUtil.addClass(e,"leaflet-zoom-"+(i?"animated":"hide"))},_updateBbox:function(){var e=this._map,r=e.getBounds(),n=r.getSouthWest(),o=r.getNorthEast(),a=t.Projection.Mercator.project(n),s=t.Projection.Mercator.project(o),l=e.getZoom();this.mInPixel=i.getPixelScale(l),this._ctxShift=[a.x*this.mInPixel,s.y*this.mInPixel];for(var u in this._observers){var h=this._observers[u];h.targetZoom&&(h.targetZoom=l),h.setBounds({min:{x:n.lng,y:n.lat},max:{x:o.lng,y:o.lat}})}},_reset:function(){this._updateBbox();for(var e in this._observers){var t=this._observers[e];!t.isActive()&&this._styleManagers[e].isVisibleAtZoom(this._map.getZoom())&&t.activate(),t.fire("update")}},_redraw:function(){var e=[],r=this._map,n=r.getSize(),o=this._canvas,a=r.latLngToContainerPoint(r.getBounds().getNorthWest()),s=r.containerPointToLayerPoint(a);o.width=n.x,o.height=n.y,t.DomUtil.setPosition(o,s);var l,u,h,c=2*this.mInPixel*i.worldWidthMerc,d=c*Math.floor(r.getPixelBounds().min.x/c),f=o.getContext("2d");for(var m in this._labels){var p=this._labels[m];for(var g in p){h=p[g];var v=h.options,y=v.label,x=y.style,_=x.labelAlign||"center",b=y.arrTxtWidth,P=b.length||1,T=y.width,S=T/2,I=x.labelFontSize||12,M=I/2,L=v.center,k=[L[0]*this.mInPixel,L[1]*this.mInPixel],C=!1;if(y.isPoint){var D=y.sx;"left"===_?k[0]+=S+D:"right"===_&&(k[0]-=T+D)}k[0]-=S+this._ctxShift[0],k[1]=-M-k[1]+this._ctxShift[1],M*=P,x.labelAnchor&&(k[0]+=x.labelAnchor[0],k[1]+=x.labelAnchor[1]);for(var O=k[0]+d;O<n.x;O+=c){var w=[Math.floor(O),Math.floor(k[1])],F=i.bounds([[w[0]-S,w[1]-M],[w[0]+S,w[1]+M]]);for(l=0,u=e.length;u>l;l++)if(F.intersects(e[l].bbox)){C=!0;break}C||(v.labelStyle||(v.labelStyle={font:I+'px "Arial"',fillStyle:i.dec2color(x.labelColor||0,1),shadowBlur:4},-1!==x.labelHaloColor&&(v.labelStyle.strokeStyle=v.labelStyle.shadowColor=i.dec2color(x.labelHaloColor,1))),e.push({arr:h.properties,bbox:F,arrTxtWidth:b,width2:"center"===_?S:0,txt:y.txt,style:v.labelStyle,size:I,coord:w}))}}}if(e.length){for(f.clearRect(0,0,o.width,o.height),l=0,u=e.length;u>l;l++)h=e[l],h.arrTxtWidth.forEach(function(e,t){var r=[h.coord[0]+h.width2-e[1]/2,h.coord[1]+(t+1)*h.size];i.setLabel(f,e[0],r,h.style)});o.parentNode||this._addToPane()}else o.parentNode&&o.parentNode.removeChild(o);this._frame=null},_animateZoom:function(e){var r=this._map.getZoomScale(e.zoom),i=this._map.getPixelBounds().min,n=this._map._getCenterOffset(e.center)._multiplyBy(-r).subtract(this._map._getMapPanePos());i.y<0&&(n.y+=i.multiplyBy(-r).y),this._canvas.style[t.DomUtil.TRANSFORM]=t.DomUtil.getTranslateString(n)+" scale("+r+")"}}),t.labelsLayer=function(e,r){return new t.LabelsLayer(e,r)},t.Map.addInitHook(function(){this._labelsLayer||(this._labelsLayer=new t.LabelsLayer(this),this._labelsLayer.addTo(this))}),function(){var e=function(e,t){for(var r in t)for(var i=t[r],n=0,o=i.length;o>n;n++)for(var a=i[n],s=a.geometry.type,l=a.boundsArr,u=0,h=l.length;h>u;u++){var c=l[u];"Polygon"===s&&(c=[c]);for(var d=0,f=c.length;f>d;d++)if(c[d].intersects(e))return!0}return!1},r=function(e,t){for(var r in t)for(var i=t[r],n=0,o=i.length;o>n;n++)for(var a=i[n],s=a.geometry.type,l=a.boundsArr,u=0,h=l.length;h>u;u++){var c=l[u];"Polygon"===s&&(c=[c]);for(var d=0,f=c.length;f>d;d++)if(e.intersects(c[d]))return!0}return!1},n=function(e,t){if(!t||0===Object.keys(t).length)return!0;for(var r in t)for(var n=t[r],o=0,a=n.length;a>o;o++)for(var s=n[o],l=s.geometry.type,u=s.boundsArr,h=0,c=u.length;c>h;h++){var d=u[h];"Polygon"===l&&(d=[d]);for(var f=0,m=d.length;m>f;f++)if(d[f].contains(e)){var p=s.geometry.coordinates,g=!1;"Polygon"===l&&(p=[p]);for(var v=0,y=p.length;y>v;v++)if(i.isPointInPolygonWithHoles(e,p[v])){g=!0;break}if(g)return!0}}return!1},o=function(e){var t=i.convertGeometry(e),r=i.geoItemBounds(t);return r.geometry=t,r},a=function(e){var t=document.createElement("canvas");t.width=t.height=256;var r=t.getContext("2d"),n=e.clipPolygons;e.ctx=r,r.fillStyle=r.createPattern(e.tile,"no-repeat");for(var o in n)for(var a=n[o],s=0,l=a.length;l>s;s++){var u=a[s].geometry,h=u.coordinates;"Polygon"===u.type&&(h=[h]);for(var c=0,d=h.length;d>c;c++){var f=h[c];r.beginPath();for(var m=0,p=f.length;p>m;m++){e.coords=f[m];var g=i.getRingPixels(e);e.coords=g.coords,i.polygonToCanvasFill(e)}r.closePath(),r.fill()}}r=e.tile.getContext("2d"),r.clearRect(0,0,256,256),r.drawImage(t,0,0)};t.gmx.VectorLayer.include({isPointInClipPolygons:function(e){return n(e,this._gmx._clipPolygons)},addClipPolygon:function(i){var s,l,u=[];if("coordinates"in i&&"type"in i)u.push(o(i));else if(i instanceof t.Polygon)u.push(o(i.toGeoJSON().geometry));else if(i instanceof t.GeoJSON){var h=i.getLayers();for(s=0,l=h.length;l>s;s++){var c=h[s];c instanceof t.Polygon&&c.feature?u.push(o(c.feature.geometry)):c instanceof t.MultiPolygon&&c.feature&&u.push(o(c.feature.geometry))}}if(u.length){var d=this._gmx,f=d.dataManager,m=this,p=t.stamp(i);this._gmx._clipPolygons||(this._gmx._clipPolygons={}),this._gmx._clipPolygons[p]=u,f.setTileFilteringHook(function(t){return e(t.bounds,m._gmx._clipPolygons)}),f.addFilter("clipFilter",function(e,t,i){return r(i,m._gmx._clipPolygons)}),f.addFilter("clipPointsFilter",function(e){if("POINT"===e.type){var t=e.properties,r=t[t.length-1];return n(r.coordinates,m._gmx._clipPolygons)}return!0}),1===Object.keys(this._gmx._clipPolygons).length&&d.renderHooks.unshift(function(e,t){e&&Object.keys(m._gmx._clipPolygons).length>0&&a({tile:e,tpx:t.tpx,tpy:t.tpy,gmx:{mInPixel:d.mInPixel},clipPolygons:m._gmx._clipPolygons})})}return this},removeClipPolygon:function(e){var r=t.stamp(e);return this._gmx._clipPolygons&&(delete this._gmx._clipPolygons[r],0===Object.keys(this._gmx._clipPolygons).length&&(this._gmx.dataManager.removeTileFilteringHook(),this._gmx.dataManager.removeFilter("clipFilter"))),this}})}(),t.gmx.gmxImageTransform=function(e,r){var n=r.gmx,o=r.gmxTilePoint,a=n.mInPixel,s=r.geoItem,l=s.properties,u=s.dataOption||{},h=l[l.length-1],c=h.coordinates[0],d=n.tileAttributeIndexes,f=l[d[n.quicklookPlatform]]||n.quicklookPlatform||"",m={};"MULTIPOLYGON"===h.type&&(c=c[0]),"LANDSAT8"===f?(m.x1=u.bounds.min.x,m.y1=u.bounds.max.y,m.x2=u.bounds.max.x,m.y2=u.bounds.max.y,m.x3=u.bounds.max.x,m.y3=u.bounds.min.y,m.x4=u.bounds.min.x,m.y4=u.bounds.min.y):m=i.getQuicklookPointsFromProperties(l,n);var p=a*m.x1,g=a*m.y1,v=a*m.x2,y=a*m.y2,x=a*m.x3,_=a*m.y3,b=a*m.x4,P=a*m.y4,T=i.bounds([[p,g],[v,y],[x,_],[b,P]]),S=Math.round(T.max.x-T.min.x),I=Math.round(T.max.y-T.min.y),M=256-T.max.y+256*o.y,L=s.item.bounds,k=i.worldWidthMerc,C=o.x;0>C&&L.max.x>k&&L.min.x<-k&&(C+=Math.round(k*a/128));var D=T.min.x-256*C;p-=T.min.x,g=T.max.y-g,v-=T.min.x,y=T.max.y-y,x-=T.min.x,_=T.max.y-_,b-=T.min.x,P=T.max.y-P;var O=[[p,g],[v,y],[x,_],[b,P]];n.ProjectiveImage||(n.ProjectiveImage=(n.useWebGL?t.gmx.projectiveImageWebGL():null)||t.gmx.projectiveImage());var w=n.ProjectiveImage.getCanvas({imageObj:e,points:O,wView:S,hView:I,deltaX:D,deltaY:M});return w.canvas},function(){function e(e){return[e[4]*e[8]-e[5]*e[7],e[2]*e[7]-e[1]*e[8],e[1]*e[5]-e[2]*e[4],e[5]*e[6]-e[3]*e[8],e[0]*e[8]-e[2]*e[6],e[2]*e[3]-e[0]*e[5],e[3]*e[7]-e[4]*e[6],e[1]*e[6]-e[0]*e[7],e[0]*e[4]-e[1]*e[3]]}function r(e,t){for(var r=Array(9),i=0;3!==i;++i)for(var n=0;3!==n;++n){for(var o=0,a=0;3!==a;++a)o+=e[3*i+a]*t[3*a+n];r[3*i+n]=o}return r}function i(e,t){return[e[0]*t[0]+e[1]*t[1]+e[2]*t[2],e[3]*t[0]+e[4]*t[1]+e[5]*t[2],e[6]*t[0]+e[7]*t[1]+e[8]*t[2]]}function n(t){var n=[t[0],t[2],t[4],t[1],t[3],t[5],1,1,1],o=i(e(n),[t[6],t[7],1]);return r(n,[o[0],0,0,0,o[1],0,0,0,o[2]])}var o=t.Class.extend({options:{antialias:!0,depth:!1,preserveDrawingBuffer:!0,shaderVS:"attribute vec2 aVertCoord;            uniform mat4 uTransformMatrix;            varying vec2 vTextureCoord;            void main(void) {                vTextureCoord = aVertCoord;                gl_Position = uTransformMatrix * vec4(aVertCoord, 0.0, 1.0);            }        ",shaderFS:"precision mediump float;            varying vec2 vTextureCoord;            uniform sampler2D uSampler;            void main(void) {                gl_FragColor = texture2D(uSampler, vTextureCoord);            }        "},setOptions:function(e){t.setOptions(this,e)},initialize:function(e){this.setOptions(e);var t=document.createElement("canvas"),r={antialias:this.options.antialias,depth:this.options.depth,preserveDrawingBuffer:this.options.preserveDrawingBuffer},i=t.getContext("webgl",r)||t.getContext("experimental-webgl",r);if(i){var n=this._setupGlContext(i);n&&(t.width=t.height=256,n.canvas=t,this.glResources=n,this.canvas=t,this.gl=i)}},_getShader:function(e,t,r){var i=r.createShader(e);return r.shaderSource(i,t),r.compileShader(i),r.getShaderParameter(i,r.COMPILE_STATUS)?i:(r.deleteShader(i),null)},_setupGlContext:function(e){var t=this._getShader(e.VERTEX_SHADER,this.options.shaderVS,e),r=this._getShader(e.FRAGMENT_SHADER,this.options.shaderFS,e);if(t&&r){var i=e.createProgram();if(e.attachShader(i,t),e.attachShader(i,r),e.linkProgram(i),e.getProgramParameter(i,e.LINK_STATUS)){e.useProgram(i),this.vertices=new Float32Array([0,0,1,0,0,1,1,1]);var n=e.createBuffer(),o=e.getAttribLocation(i,"aVertCoord");return e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.vertices),e.STATIC_DRAW),e.enableVertexAttribArray(o),e.vertexAttribPointer(o,2,e.FLOAT,!1,0,0),{transMatUniform:e.getUniformLocation(i,"uTransformMatrix"),samplerUniform:e.getUniformLocation(i,"uSampler"),screenTexture:e.createTexture()}}}return null},_bindTexture:function(e,t,r){e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null)},getCanvas:function(e){var t=e.points,r=e.deltaX,i=e.deltaY,n=new Float32Array([(t[0][0]+r)/128-1,1-(t[0][1]+i)/128,(t[1][0]+r)/128-1,1-(t[1][1]+i)/128,(t[3][0]+r)/128-1,1-(t[3][1]+i)/128,(t[2][0]+r)/128-1,1-(t[2][1]+i)/128]),a=o.Utils.general2DProjection(this.vertices,n),s=this.gl,l=this.glResources;return this._bindTexture(s,e.imageObj,l.screenTexture),s.viewport(0,0,256,256),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.uniformMatrix4fv(l.transMatUniform,!1,[a[0],a[3],0,a[6],a[1],a[4],0,a[7],0,0,1,0,a[2],a[5],0,1]),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,l.screenTexture),s.uniform1i(l.samplerUniform,0),s.drawArrays(s.TRIANGLE_STRIP,0,4),this}});o.Utils={general2DProjection:function(t,i){var o=r(n(i),e(n(t)));if(o[8])for(var a=0;9!==a;++a)o[a]=o[a]/o[8];return o},getWebGlResources:function(e){var t=new o(e);return t.gl?t:null}},t.gmx.projectiveImageWebGL=function(e){var t=new o(e);return t.gl?t:null}}(),function(){var e=function(){var e=0,t=4,r=64,n=null,o=function(e,t){for(var r=[],i=0;t>i;++i){r[i]=[];for(var n=0;e>n;++n)r[i][n]=0}return r},a=function(e,t,r){this.w=e,this.h=t,this.values=r||o(t)},s=function(e){for(var t=[],r=0;r<e.length;++r)t[r]=[].concat(e[r]);return t};a.prototype={add:function(e){if(e.w!==this.w||e.h!==this.h)throw new Error("Matrix add size mismatch");for(var t=o(this.w,this.h),r=0;r<this.h;++r)for(var i=0;i<this.w;++i)t[r][i]=this.values[r][i]+e.values[r][i];return new a(this.w,this.h,t)},transformProjectiveVector:function(e){var t,r,i=[];for(r=0;r<this.h;++r)for(i[r]=0,t=0;t<this.w;++t)i[r]+=this.values[r][t]*e[t];var n=i[i.length-1];if(n){var o=1/i[i.length-1];for(r=0;r<this.h;++r)i[r]*=o}return i},multiply:function(e){var t,r,i;if(+e!==e){if(e.h!==this.w)throw new Error("Matrix mult size mismatch");for(t=o(this.w,this.h),i=0;i<this.h;++i)for(r=0;r<e.w;++r){for(var n=0,s=0;s<this.w;s++)n+=this.values[i][s]*e.values[s][r];t[i][r]=n}return new a(e.w,this.h,t)}for(t=o(this.w,this.h),i=0;i<this.h;++i)for(r=0;r<this.w;++r)t[i][r]=this.values[i][r]*e;return new a(this.w,this.h,t)},rowEchelon:function(){if(this.w<=this.h)throw new Error("Matrix rowEchelon size mismatch");for(var e=s(this.values),t=0;t<this.h;++t){for(var r=e[t][t];0===r;){for(var i=t+1;i<this.h;++i)if(0!==e[i][t]){var n=e[i];e[i]=e[t],e[t]=n;break}if(i===this.h)return new a(this.w,this.h,e);r=e[t][t]}for(var o=1/r,l=t;l<this.w;++l)e[t][l]*=o;for(var u=0;u<this.h;++u)if(u!==t){var h=e[u][t];for(e[u][t]=0,l=t+1;l<this.w;++l)e[u][l]-=h*e[t][l]}}return new a(this.w,this.h,e)},invert:function(){var e,t;if(this.w!==this.h)throw new Error("Matrix invert size mismatch");var r=o(2*this.w,this.h);for(t=0;t<this.h;++t)for(e=0;e<this.w;++e)r[t][e]=this.values[t][e],r[t][e+this.w]=e===t?1:0;r=new a(2*this.w,this.h,r),r=r.rowEchelon();var i=o(this.w,this.h);for(t=0;t<this.w;++t)for(e=0;e<this.w;++e)i[t][e]=r.values[t][e+this.w];return new a(this.w,this.h,i)}};var l=function(e){var t=new a(9,8,[[1,1,1,0,0,0,-e[2][0],-e[2][0],-e[2][0]],[0,1,1,0,0,0,0,-e[3][0],-e[3][0]],[1,0,1,0,0,0,-e[1][0],0,-e[1][0]],[0,0,1,0,0,0,0,0,-e[0][0]],[0,0,0,-1,-1,-1,e[2][1],e[2][1],e[2][1]],[0,0,0,0,-1,-1,0,e[3][1],e[3][1]],[0,0,0,-1,0,-1,e[1][1],0,e[1][1]],[0,0,0,0,0,-1,0,0,e[0][1]]]),r=t.rowEchelon().values,i=new a(3,3,[[-r[0][8],-r[1][8],-r[2][8]],[-r[3][8],-r[4][8],-r[5][8]],[-r[6][8],-r[7][8],1]]);return i},u=function(t,i,o,a,s,l,h,c,d,f){if(d){var m=[l[0]+h[0]-2*s[0],l[1]+h[1]-2*s[1]],p=[l[0]+h[0]-2*c[0],l[1]+h[1]-2*c[1]],g=[m[0]+p[0],m[1]+p[1]],v=Math.abs((g[0]*g[0]+g[1]*g[1])/(m[0]*p[0]+m[1]*p[1]));m=[l[0]-s[0]+c[0]-h[0],l[1]-s[1]+c[1]-h[1]],p=[h[0]-s[0]+c[0]-l[0],h[1]-s[1]+c[1]-l[1]];var y=Math.abs(m[0]*p[1]-m[1]*p[0]);if(0===t&&1===o||(.25+5*v)*y>r*r){var x=(t+o)/2,_=(i+a)/2,b=n.transformProjectiveVector([x,_,1]),P=n.transformProjectiveVector([x,i,1]),T=n.transformProjectiveVector([x,a,1]),S=n.transformProjectiveVector([t,_,1]),I=n.transformProjectiveVector([o,_,1]);return d--,u.call(this,t,i,x,_,s,P,S,b,d,f),u.call(this,x,i,o,_,P,l,b,I,d,f),u.call(this,t,_,x,a,S,b,h,T,d,f),u.call(this,x,_,o,a,b,I,T,c,d,f),void 0}}var M=f.ctx,L=[l[0]-s[0],l[1]-s[1]],k=[c[0]-l[0],c[1]-l[1]],C=[h[0]-c[0],h[1]-c[1]],D=[s[0]-h[0],s[1]-h[1]],O=Math.abs(L[0]*D[1]-L[1]*D[0]),w=Math.abs(k[0]*L[1]-k[1]*L[0]),F=Math.abs(C[0]*k[1]-C[1]*k[0]),N=Math.abs(D[0]*C[1]-D[1]*C[0]),R=Math.max(Math.max(O,w),Math.max(N,F)),A=0,E=0,z=0,G=0;R===O?(M.setTransform(L[0],L[1],-D[0],-D[1],s[0]+f.deltaX,s[1]+f.deltaY),1!==o&&(z=1.05/Math.sqrt(L[0]*L[0]+L[1]*L[1])),1!==a&&(G=1.05/Math.sqrt(D[0]*D[0]+D[1]*D[1]))):R===w?(M.setTransform(L[0],L[1],k[0],k[1],l[0]+f.deltaX,l[1]+f.deltaY),1!==o&&(z=1.05/Math.sqrt(L[0]*L[0]+L[1]*L[1])),1!==a&&(G=1.05/Math.sqrt(k[0]*k[0]+k[1]*k[1])),A=-1):R===F?(M.setTransform(-C[0],-C[1],k[0],k[1],c[0]+f.deltaX,c[1]+f.deltaY),1!==o&&(z=1.05/Math.sqrt(C[0]*C[0]+C[1]*C[1])),1!==a&&(G=1.05/Math.sqrt(k[0]*k[0]+k[1]*k[1])),A=-1,E=-1):R===N&&(M.setTransform(-C[0],-C[1],-D[0],-D[1],h[0]+f.deltaX,h[1]+f.deltaY),1!==o&&(z=1.05/Math.sqrt(C[0]*C[0]+C[1]*C[1])),1!==a&&(G=1.05/Math.sqrt(D[0]*D[0]+D[1]*D[1])),E=-1);var B=o-t,U=a-i;z++,G++;var H=f.imageObj.width,V=f.imageObj.height,j=Math.floor(t*H),q=Math.floor(i*V),Z=Math.floor(Math.min(z*B,1)*H),K=Math.floor(Math.min(G*U,1)*V);e++,M.drawImage(f.imageObj,j,q,Z,K,A,E,z,G)};this.getCanvas=function(o){e=0,n=l(o.points);var a=n.transformProjectiveVector([0,0,1]),s=n.transformProjectiveVector([1,0,1]),h=n.transformProjectiveVector([0,1,1]),c=n.transformProjectiveVector([1,1,1]),d=document.createElement("canvas");d.width=d.height=256,o.canvas=d,o.ctx=d.getContext("2d");var f=i.bounds([a,s,c,h]),m=Math.max(f.max.x-f.min.x,f.max.y-f.min.y);t="limit"in o?o.limit:200>m?1:4,r="patchSize"in o?o.patchSize:m/8;try{u(0,0,1,1,a,s,h,c,t,o)}catch(p){console.log("Error: ProjectiveImage event:",p),d=null}return{canvas:d,ptl:a,ptr:s,pbl:h,pbr:c,cnt:e}}};t.gmx.projectiveImage=function(){return new e}}(),t.RotatedMarker=t.Marker.extend({options:{angle:0},statics:{TRANSFORM_ORIGIN:t.DomUtil.testProp(["transformOrigin","WebkitTransformOrigin","OTransformOrigin","MozTransformOrigin","msTransformOrigin"])},_initIcon:function(){t.Marker.prototype._initIcon.call(this),this._icon.style[t.RotatedMarker.TRANSFORM_ORIGIN]=this._getTransformOrigin()},_getTransformOrigin:function(){var e=this.options.icon.options.iconAnchor;return e?e[0]+"px "+e[1]+"px":"50% 50%"},_setPos:function(e){if(t.Marker.prototype._setPos.call(this,e),t.DomUtil.TRANSFORM)this._icon.style[t.DomUtil.TRANSFORM]+=" rotate("+this.options.angle+"deg)";else if(t.Browser.ie){var r=this.options.angle*(Math.PI/180),i=Math.cos(r),n=Math.sin(r);this._icon.style.filter+=" progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', M11="+i+", M12="+-n+", M21="+n+", M22="+i+")"}},setAngle:function(e){this.options.angle=e}}),t.rotatedMarker=function(e,r){return new t.RotatedMarker(e,r)},t.gmx.ExternalLayer=t.Class.extend({createExternalLayer:function(){return null},isExternalVisible:function(){return!0},updateData:function(){},setDateInterval:function(){if(this._observer){var e=this.parentLayer._gmx;this._observer.setDateInterval(e.beginDate,e.endDate)}},options:{useDataManager:!0,observerOptions:{delta:0,filters:["clipFilter","userFilter","clipPointsFilter"]}},initialize:function(e,r){t.setOptions(this,e),this.parentLayer=r,r.on("add",this._addEvent,this).on("dateIntervalChanged",this.setDateInterval,this),this.options.useDataManager&&this._addObserver(this.options.observerOptions),this.externalLayer=this.createExternalLayer(),r._map&&(this._addEvent({target:{_map:r._map}}),this._updateBbox())},_addObserver:function(e){this._items={},this._observer=this.parentLayer.addObserver(t.extend({bbox:i.bounds([[Number.MAX_VALUE,Number.MAX_VALUE]]),callback:t.bind(this.updateData,this)},e)).deactivate()},unbindLayer:function(){this.parentLayer.off("add",this._addEvent,this).off("dateIntervalChanged",this.setDateInterval,this),this._observer&&delete this.parentLayer.repaintObservers[this._observer.id];var e=this._map||this.parentLayer._map;this._onRemove(!e),this._removeMapHandlers()},_addMapHandlers:function(e){this._map=e,this._map.on({moveend:this._updateBbox,zoomend:this._chkZoom,layeradd:this._layeradd,layerremove:this._layerremove},this)},_removeMapHandlers:function(){this._map&&this._map.off({moveend:this._updateBbox,zoomend:this._chkZoom,layeradd:this._layeradd,layerremove:this._layerremove},this),this._map=null},_addEvent:function(e){this._addMapHandlers(e.target._map),this._updateBbox(),this._chkZoom()},_isParentLayer:function(e){var t=e.layer;return t._gmx&&t._gmx.layerID===this.parentLayer.options.layerID},_layeradd:function(e){this._isParentLayer(e)&&this._chkZoom()},_layerremove:function(e){this._isParentLayer(e)&&(this._onRemove(!0),this._removeMapHandlers())},_onRemove:function(e){this._observer&&this._observer.deactivate();var t=this._map;t&&(t.hasLayer(this.externalLayer)&&(this._chkZoom(),t.removeLayer(this.externalLayer)),e||this.parentLayer.onAdd(t))},_chkZoom:function(){if(this._map){var e=this.parentLayer,t=this._observer,r=this._map,i=r.hasLayer(this.externalLayer);e.setCurrentZoom(r),this.isExternalVisible(r.getZoom())?e._map&&(e.onRemove(r),i||r.addLayer(this.externalLayer),this.setDateInterval(),t&&e.getIcons(function(){t.activate()}.bind(this)),e.disablePopup()):(t&&t.deactivate(),e._map||(i&&r.removeLayer(this.externalLayer),e.onAdd(r)),e.enablePopup())}},_updateBbox:function(){if(this._map&&this._observer){var e=this._map,r=e.getBounds(),i=r.getNorthWest(),n=r.getSouthEast(),o=t.gmxUtil.bounds([[i.lng,i.lat],[n.lng,n.lat]]),a=this.options.observerOptions.delta,s=a?a*t.gmxUtil.tileSizes[e.getZoom()]/256:0;this._observer.setBounds(o,s)}}}),function(){var e=t.gmx.ExternalLayer.extend({options:{minZoom:1,maxZoom:6,useDataManager:!1,format:"png",transparent:!0},createExternalLayer:function(){var e=this.parentLayer.options,r={map:e.mapID,layers:e.layerID,format:this.options.format,transparent:this.options.transparent},i=this.parentLayer.getGmxProperties();return i&&i.Temporal&&this._extendOptionsByDateInterval(r),this.options.apikey&&(r.apikey=this.options.apikey),t.tileLayer.wms(t.gmxUtil.protocol+"//"+e.hostName+"/TileService.ashx",r)},_extendOptionsByDateInterval:function(e){var r=this.parentLayer.getDateInterval(),i=r.beginDate,n=r.endDate;t.extend(e,{StartDate:i&&i.toLocaleDateString(),EndDate:n&&n.toLocaleDateString()})},setDateInterval:function(){this._extendOptionsByDateInterval(this.externalLayer.wmsParams),this.externalLayer.redraw()},isExternalVisible:function(e){return!(e<this.options.minZoom||e>this.options.maxZoom)}});t.gmx.VectorLayer.include({bindWMS:function(t){return this._layerWMS&&this._layerWMS.unbindLayer(),this._layerWMS=new e(t,this),this.isExternalVisible=this._layerWMS.isExternalVisible,this},unbindWMS:function(){return this._layerWMS&&(this._layerWMS.unbindLayer(),this._layerWMS=null,this.isExternalVisible=null,this.enablePopup()),this}})}(),function(){var e=t.gmx.ExternalLayer.extend({options:{minHeatMapZoom:1,maxHeatMapZoom:6,intensityField:"",intensityScale:1,observerOptions:{type:"resend"}},createExternalLayer:function(){return t.heatLayer([],t.extend({},this.options))},isExternalVisible:function(e){return!(e<this.options.minHeatMapZoom||e>this.options.maxHeatMapZoom)},updateData:function(e){if(e.added){var r=[],i=this.parentLayer.getTileAttributeIndexes(),n=null,o=this.options.intensityField||"",a=this.options.intensityScale||1;o&&o in i&&(n=i[o]);for(var s=0,l=e.added.length;l>s;s++){var u=e.added[s].properties,h=null!==n?u[n]:1,c=u[u.length-1],d=c.coordinates,f=t.Projection.Mercator.unproject({x:d[0],y:d[1]});r.push([f.lat,f.lng,"function"==typeof a?a(h):a*h])}this.externalLayer.setLatLngs(r)}}});t.gmx.VectorLayer.include({bindHeatMap:function(r){return t.heatLayer&&(this._heatmap&&this._heatmap.unbindLayer(),this._heatmap=new e(r,this)),this},unbindHeatMap:function(){return t.heatLayer&&this._heatmap&&(this._heatmap.unbindLayer(),this._heatmap=null,this.enablePopup()),this}})}(),function(){var e={radiusFunc:function(e){var t=Math.floor(e/15);return t>40?t=40:20>t&&(t=20),t},text:{stroke:"black","stroke-width":1,"text-anchor":"middle",fill:"white"}},r=t.gmx.ExternalLayer.extend({options:{observerOptions:{delta:256,filters:["clipFilter","styleFilter","userFilter","clipPointsFilter"]},spiderfyOnMaxZoom:!0,minZoom:1,maxZoom:6},createExternalLayer:function(){var r=t.extend({showCoverageOnHover:!1,disableClusteringAtZoom:1+Number(this.options.maxZoom)},this.options);if("clusterIconOptions"in this.options){var i=this.options.clusterIconOptions;if("radialGradient"in i){var n=i.radialGradient,o=i.text||e.text;r.iconCreateFunction=function(r){var i=r.getChildCount();return o.count=i,t.gmxUtil.getSVGIcon({type:"circle",iconSize:2*(n.radiusFunc||e.radiusFunc)(i),text:o,fillRadialGradient:n})}}}this.options.clusterclick&&(r.clusterclick=this.options.clusterclick,r.clusterclick===!0&&(r.zoomToBoundsOnClick=!1)),this._popup=new t.Popup({maxWidth:1e4,className:"gmxPopup"});var a=new t.MarkerClusterGroup(r),s=null;return a.on("click",function(e){var r=e.layer.options.properties,i=this.parentLayer.getItemProperties(r),n=[r[r.length-1]],o=r[0];!s||s.getAllChildMarkers().indexOf(e.layer)+1?this._openPopup(r,e.latlng):(s.unspiderfy(),a.once("unspiderfied",function(){this._openPopup(r,e.latlng)},this)),this.parentLayer.fire("click",t.extend(e,{eventFrom:"markerClusters",originalEventType:"click",gmx:{id:o,layer:this.parentLayer,properties:i,target:{id:o,properties:r,geometry:n}}}))},this).on("animationend",function(){this._popup&&this._popup._map&&this._popup._map.removeLayer(this._popup)},this).on("clusterclick",function(e){this.parentLayer.fire("clusterclick",t.extend(e,{eventFrom:"markerClusters",originalEventType:"clusterclick"}))},this).on("spiderfied",function(e){s=e.cluster},this).on("unspiderfied",function(){s=null},this),r.clusterclick&&a.on("clusterclick",r.clusterclick instanceof Function?r.clusterclick:function(e){e.layer.spiderfy()}),a},isExternalVisible:function(e){return!(e<this.options.minZoom||e>this.options.maxZoom)},updateData:function(e){var r,i,n,o,a,s=[];if(e.removed){for(r=0,i=e.removed.length;i>r;r++)n=e.removed[r],o=n.id,a=this._items[o],a&&s.push(a),delete this._items[o];this.externalLayer.removeLayers(s),s=[]}if(e.added){for(r=0,i=e.added.length;i>r;r++){n=e.added[r],o=n.id,a=this._items[o];var l=n.properties;if(a&&l.processing&&(this.externalLayer.removeLayer(a),a=null),!a){n.item.parsedStyleKeys||(n.item.parsedStyleKeys=this.parentLayer.getItemStyle(o));var u=l[l.length-1],h=n.item.parsedStyleKeys,c=u.coordinates,d=t.Projection.Mercator.unproject({x:c[0],y:c[1]}),f={properties:n.properties,mPoint:c};if(this.options.notClusteredIcon){var m=this.options.notClusteredIcon;f.icon=m instanceof t.Icon?m:t.icon(m)}else if(h)if(h.iconUrl){var p=h.iconAnchor;if(!p){var g=this.parentLayer.getItemStyle(o);p=g.image?[g.sx/2,g.sy/2]:[8,10]}f.icon=t.icon({iconAnchor:p,iconUrl:h.iconUrl})}else f.icon=t.gmxUtil.getSVGIcon(h);a=h.rotate?t.rotatedMarker(d,t.extend(f,{angle:h.rotate})):t.marker(d,t.extend(f,{angle:h.rotate})),this._items[o]=a}s.push(a)}this.externalLayer.addLayers(s)}},_openPopup:function(e,r){var i=this.parentLayer._gmx,n=e[0],o=i.styleManager.getItemBalloon(n),a=this.parentLayer.getItemProperties(e),s=[e[e.length-1]];if(o&&!o.DisableBalloonOnClick){var l=this.parentLayer.getItemStyle(n);if(l&&l.iconAnchor){var u=t.Popup.prototype.options.offset;this._popup.options.offset=[-u[0]-l.iconAnchor[0]+l.sx/2,u[1]-l.iconAnchor[1]+l.sy/2]}this._popup.setLatLng(r).setContent(t.gmxUtil.parseBalloonTemplate(o.templateBalloon,{properties:a,tileAttributeTypes:i.tileAttributeTypes,unitOptions:this._map.options||{},geometries:s})).openOn(this._map)}}});t.gmx.VectorLayer.include({bindClusters:function(e){return t.MarkerClusterGroup&&(this._clusters&&this._clusters.unbindLayer(),this._clusters=new r(e,this)),this},unbindClusters:function(){return t.MarkerClusterGroup&&this._clusters&&(this._clusters.unbindLayer(),this._clusters=null,this.enablePopup()),this}})}(),t.gmx=t.gmx||{};var y="maps.kosmosnimki.ru",x=2e6;t.gmx._layerClasses={Raster:t.gmx.RasterLayer,Vector:t.gmx.VectorLayer,VectorView:t.gmx.DummyLayer},t.gmx._loadingLayerClasses={},t.gmx.addLayerClass=function(e,r){t.gmx._layerClasses[e]=r},t.gmx._layerClassLoaders=[],t.gmx.addLayerClassLoader=function(e){t.gmx._layerClassLoaders.push(e),t.gmx._loadingLayerClasses={}},t.gmx._loadLayerClass=function(e){if(!t.gmx._loadingLayerClasses[e]){var r=new t.gmx.Deferred;r.resolve(),t.gmx._layerClassLoaders.forEach(function(i){r=r.then(function(r){return r?(t.gmx._layerClasses[e]=r,r):i(e)},function(){})}),r=r.then(function(r){return r?(t.gmx._layerClasses[e]=r,r):void 0},function(){}),t.gmx._loadingLayerClasses[e]=r}return t.gmx._loadingLayerClasses[e]},t.gmx.loadLayer=function(e,r,n){var o=new t.gmx.Deferred,a={mapID:e,layerID:r};n=n||{};for(var s in n)a[s]=n[s];var l=i.normalizeHostname(n.hostName||y);return a.hostName=l,u.loadMapProperties({srs:n.srs,hostName:l,apiKey:n.apiKey,mapName:e,skipTiles:n.skipTiles}).then(function(){var i=u.findLayerInfo(l,e,r);
if(!i)return o.reject("There is no layer "+r+" in map "+e),void 0;i.properties.hostName=l;var n=i.properties.ContentID||i.properties.type,s=function(){var e=t.gmx.createLayer(i,a);e?o.resolve(e):o.reject("Unknown type of layer "+r)};n in t.gmx._layerClasses?s():t.gmx._loadLayerClass(n).then(s)},function(t){o.reject("Can't load layer "+r+" from map "+e+": "+t.error)}),o},t.gmx.loadLayers=function(e,r){var i=e.map(function(e){var i=t.extend({},r,e.options);return t.gmx.loadLayer(e.mapID,e.layerID,i)});return t.gmx.Deferred.all.apply(null,i)},t.gmx.loadMap=function(e,r){r=t.extend({},r),r.hostName=i.normalizeHostname(r.hostName||y),r.mapName=e;var n=new t.gmx.Deferred;return u.loadMapProperties(r).then(function(e){var i=new t.gmx.gmxMap(e,r);i.layersCreated.then(function(){if(r.leafletMap||r.setZIndex)for(var t,o,a=0,s=i.layers.length-1;s>=0;s--)t=i.layers[s],o=t.getGmxProperties(),"VectorOnTop"===e.properties.LayerOrder&&t.setZIndexOffset&&"Raster"!==o.type&&t.setZIndexOffset(x),r.setZIndex&&t.setZIndex&&t.setZIndex(++a),r.leafletMap&&o.visible&&t.addTo(r.leafletMap);n.resolve(i)})},function(t){var i=t&&t.ErrorInfo&&t.ErrorInfo.ErrorMessage||"Server error";n.reject("Can't load map "+e+" from "+r.hostName+": "+i)}),n},t.gmx.DummyLayer=function(e){this.onAdd=this.onRemove=function(){},this.getGmxProperties=function(){return e}},t.gmx.createLayer=function(e,r){e||(e={}),e.properties||(e.properties={type:"Vector"});var i,n=e.properties.ContentID||e.properties.type||"Vector";if(n in t.gmx._layerClasses)try{i=new t.gmx._layerClasses[n](r),i=i.initFromDescription(e)}catch(o){i=new t.gmx.DummyLayer(e.properties)}else i=new t.gmx.DummyLayer(e.properties);return i}}();